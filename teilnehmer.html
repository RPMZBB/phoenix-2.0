<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alle Teilnehmer</title>

  <!-- Dein Custom CSS -->
  <link rel="stylesheet" href="css/custom.css" />
  <link href="https://cdn.jsdelivr.net/npm/bs-stepper/dist/css/bs-stepper.min.css" rel="stylesheet" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    /* Spalten per Checkbox ein-/ausblenden */
    .col-hide { display: none !important; }

    /* Filterzeile: auf Desktop alles in 1 Reihe, mobil umbrechen */
    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
      align-items:end;
    }
    @media (min-width: 992px){
      .filter-row{ flex-wrap:nowrap; }
      .filter-item{ flex: 1 1 0; min-width: 0; }
      .filter-search{ flex: 2.2 1 0; }
      .filter-actions{ flex: 0 0 auto; white-space:nowrap; }
    }
  </style>
</head>

<body class="bg-light p-4 p-lg-5">

  <!-- CARD 1: Heading + Filter -->
  <div class="card border-0 shadow mb-3">
    <div class="card-body p-4">
      <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
        <div>
          <h2 class="fw-normal mb-2" id="tn-erstellen">Alle Teilnehmer</h2>
          <div class="text-secondary" style="font-size: 0.95rem; max-width: 900px;">
            Übersicht aller aktuell erfassten Teilnehmer. Klicken Sie auf eine Zeile, um das Profil aufzurufen.<br>
            Oder nutzen Sie den Filter, um den Datensatz zu finden.
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teilnehmerModal">
            <i class="bi bi-person-plus me-1"></i> Neuer Teilnehmer
          </button>
        </div>
      </div>

      <hr class="my-3">

      <!-- FILTERS: Desktop eine Zeile -->
      <div class="filter-row">

        <!-- Suche -->
        <div class="filter-item filter-search">
          <label class="form-label text-secondary small mb-1">Suche</label>
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input id="fltSearch" type="text" class="form-control" placeholder="Name, Kundennummer, …" />
            <button class="btn btn-outline-primary" id="btnSearch">Suchen</button>
          </div>
        </div>

        <!-- Maßnahme -->
        <div class="filter-item">
          <label class="form-label text-secondary small mb-1">Maßnahme</label>
          <select id="fltMassnahme" class="form-select">
            <option value="" selected>Alle Maßnahmen</option>
            <option>Integra 2025</option>
            <option>Integra 2024</option>
            <option>ZUKUNFT.SAUBER</option>
          </select>
        </div>

        <!-- Betreuer -->
        <div class="filter-item">
          <label class="form-label text-secondary small mb-1">Betreuer</label>
          <select id="fltBetreuer" class="form-select">
            <option value="" selected>Alle Betreuer</option>
            <option>Daniel Chu</option>
            <option>Corinna Adams</option>
            <option>Janine Kerber</option>
          </select>
        </div>

        <!-- Status -->
        <div class="filter-item">
          <label class="form-label text-secondary small mb-1">Status</label>
          <select id="fltStatus" class="form-select">
            <option value="" selected>Alle</option>
            <option value="Aktiv">Aktiv</option>
            <option value="Geplant">Geplant</option>
            <option value="Beendet">Beendet</option>
          </select>
        </div>

        <!-- Zeitraum von -->
        <div class="filter-item">
          <label class="form-label text-secondary small mb-1">Zeitraum von</label>
          <input id="fltVon" type="date" class="form-control" />
        </div>

        <!-- Zeitraum bis -->
        <div class="filter-item">
          <label class="form-label text-secondary small mb-1">Zeitraum bis</label>
          <input id="fltBis" type="date" class="form-control" />
        </div>

        <!-- Reset -->
        <div class="filter-actions">
          <label class="form-label text-secondary small mb-1 d-none d-lg-block">&nbsp;</label>
          <button class="btn btn-outline-secondary" id="btnReset">
            <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- CARD 2: Toolbar + Tabelle -->
  <div class="card border-0 shadow">
    <div class="card-body p-0">

      <div class="p-3 p-lg-4 border-bottom d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="d-flex flex-wrap gap-2">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-layout-three-columns me-1"></i> Spalten anzeigen
            </button>
            <div class="dropdown-menu p-3" style="min-width: 260px;">
              <div class="form-check">
                <input class="form-check-input col-toggle" data-col="kundennr" type="checkbox" checked id="colKundennr">
                <label class="form-check-label" for="colKundennr">Kundennummer</label>
              </div>
              <div class="form-check">
                <input class="form-check-input col-toggle" data-col="geb" type="checkbox" checked id="colGeb">
                <label class="form-check-label" for="colGeb">Geburtsdatum</label>
              </div>
              <div class="form-check">
                <input class="form-check-input col-toggle" data-col="status" type="checkbox" checked id="colStatus">
                <label class="form-check-label" for="colStatus">Status</label>
              </div>
              <div class="form-check">
                <input class="form-check-input col-toggle" data-col="zuweisung" type="checkbox" checked id="colZuweisung">
                <label class="form-check-label" for="colZuweisung">Zuweisung</label>
              </div>
              <div class="form-check">
                <input class="form-check-input col-toggle" data-col="eintritt" type="checkbox" checked id="colEintritt">
                <label class="form-check-label" for="colEintritt">Eintrittsdatum</label>
              </div>
              <div class="form-check">
                <input class="form-check-input col-toggle" data-col="massnahme" type="checkbox" checked id="colMassnahme">
                <label class="form-check-label" for="colMassnahme">Maßnahme</label>
              </div>
              <div class="form-check">
                <input class="form-check-input col-toggle" data-col="betreuer" type="checkbox" checked id="colBetreuer">
                <label class="form-check-label" for="colBetreuer">Betreuer</label>
              </div>
            </div>
          </div>

          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-download me-1"></i> Exportieren
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); alert('CSV Export (Demo)');"><i class="bi bi-filetype-csv me-2"></i>CSV</a></li>
              <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); alert('Excel Export (Demo)');"><i class="bi bi-file-earmark-excel me-2"></i>Excel</a></li>
              <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); alert('PDF Export (Demo)');"><i class="bi bi-file-earmark-pdf me-2"></i>PDF</a></li>
            </ul>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <span class="badge rounded-pill bg-warning text-dark fs-6" id="cntTeilnehmer">0</span>
          <span class="text-secondary">Anzahl der Teilnehmer</span>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="tnTable">
          <thead class="table-light">
            <tr>
              <th data-col="teilnehmer">Teilnehmer</th>
              <th data-col="kundennr">Kundennummer</th>
              <th data-col="geb">Geburtsdatum</th>
              <th data-col="status">Status</th>
              <th data-col="zuweisung">Zuweisung</th>
              <th data-col="eintritt">Eintrittsdatum</th>
              <th data-col="massnahme">Maßnahme</th>
              <th data-col="betreuer">Betreuer</th>
              <th class="text-end" data-col="aktionen">Aktionen</th>
            </tr>
          </thead>
          <tbody id="tnTbody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- =========================================
       MODAL: Neuer Teilnehmer + Stepper (4 Steps)
  ========================================== -->
  <div class="modal fade" id="teilnehmerModal" tabindex="-1" aria-labelledby="teilnehmerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="teilnehmerModalLabel">Neuer Teilnehmer</h5>
            <div class="text-secondary small">
              Teilnehmer anlegen, Massnahme zuweisen und Unterlagen
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>

        <div class="modal-body">
          <div class="container mt-3">

            <form id="teilnehmerForm">
              <div class="card border-0 shadow-sm">
                <div id="stepper" class="bs-stepper">

                  <div class="bs-stepper-header m-3" role="tablist">
                    <div class="step" data-target="#step1">
                      <button type="button" class="step-trigger" role="tab" aria-controls="step1" id="step1-trigger">
                        <span class="bs-stepper-circle">1</span>
                        <span>Persönliche Informationen</span>
                      </button>
                    </div>
                    <div class="line"></div>

                    <div class="step" data-target="#step2">
                      <button type="button" class="step-trigger" role="tab" aria-controls="step2" id="step2-trigger">
                        <span class="bs-stepper-circle">2</span>
                        <span>Maßnahme</span>
                      </button>
                    </div>
                    <div class="line"></div>

                    <div class="step" data-target="#step3">
                      <button type="button" class="step-trigger" role="tab" aria-controls="step3" id="step3-trigger">
                        <span class="bs-stepper-circle">3</span>
                        <span>Sonstiges</span>
                      </button>
                    </div>
                    <div class="line"></div>

                    <div class="step" data-target="#step4">
                      <button type="button" class="step-trigger" role="tab" aria-controls="step4" id="step4-trigger">
                        <span class="bs-stepper-circle">4</span>
                        <span>Unterlagen</span>
                      </button>
                    </div>
                  </div>

                  <div class="bs-stepper-content p-3 p-lg-4">

                    <!-- STEP 1 -->
                    <div id="step1" class="content d-none" role="tabpanel" aria-labelledby="step1-trigger">
                      <div class="row">
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_nachname" placeholder="Nachname" required minlength="2" />
                            <label for="tn_nachname">Nachname *</label>
                          </div>
                        </div>
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_vorname" placeholder="Vorname" />
                            <label for="tn_vorname">Vorname</label>
                          </div>
                        </div>
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_geburtsname" placeholder="Geburtsname" />
                            <label for="tn_geburtsname">Geburtsname</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <select class="form-select" id="tn_geschlecht">
                              <option selected value="">Wählen...</option>
                              <option value="m">Männlich</option>
                              <option value="w">Weiblich</option>
                              <option value="d">Divers</option>
                            </select>
                            <label for="tn_geschlecht">Geschlecht</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_strasse" placeholder="Straße" />
                            <label for="tn_strasse">Straße</label>
                          </div>
                        </div>
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_hausnummer" placeholder="Hausnummer" />
                            <label for="tn_hausnummer">Hausnummer</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_plz" placeholder="PLZ" />
                            <label for="tn_plz">PLZ</label>
                          </div>
                        </div>
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_ort" placeholder="Ort" />
                            <label for="tn_ort">Ort</label>
                          </div>
                        </div>
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_land" placeholder="Land" />
                            <label for="tn_land">Land</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="date" class="form-control" id="tn_geburtsdatum" />
                            <label for="tn_geburtsdatum">Geburtsdatum</label>
                          </div>
                        </div>
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="tel" class="form-control" id="tn_telefon" placeholder="Telefon" />
                            <label for="tn_telefon">Telefon</label>
                          </div>
                        </div>
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="tel" class="form-control" id="tn_mobil" placeholder="Mobil" />
                            <label for="tn_mobil">Mobil</label>
                          </div>
                        </div>
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="email" class="form-control" id="tn_mail" placeholder="Mail" />
                            <label for="tn_mail">Mail</label>
                          </div>
                        </div>
                      </div>

                      <div class="d-flex justify-content-between mt-3">
                        <div></div>
                        <button type="button" class="btn btn-primary" id="btnNext1">
                          Weiter <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                      </div>
                    </div>

                    <!-- STEP 2 -->
                    <div id="step2" class="content d-none" role="tabpanel" aria-labelledby="step2-trigger">
                      <div class="row">
                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <select class="form-select" id="tn_massnahme" required>
                              <option selected disabled value="">Maßnahme wählen *</option>
                              <option>Maßnahme 1</option>
                              <option>Maßnahme 2</option>
                              <option>Maßnahme 3</option>
                              <option>Maßnahme 4</option>
                            </select>
                            <label for="tn_massnahme">Maßnahme *</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <select class="form-select" id="tn_betreuer" required>
                              <option selected disabled value="">Betreuer wählen *</option>
                              <option>Daniel Chu</option>
                              <option>Janine Kerber</option>
                            </select>
                            <label for="tn_betreuer">Betreuer *</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="text" class="form-control" id="tn_kennung" placeholder="Kennung" />
                            <label for="tn_kennung">Kennung</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="date" class="form-control" id="tn_zuweisung_von" required />
                            <label for="tn_zuweisung_von">Zuweisung von *</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="date" class="form-control" id="tn_zuweisung_bis" required />
                            <label for="tn_zuweisung_bis">Zuweisung bis *</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <input type="date" class="form-control" id="tn_eintritt" />
                            <label for="tn_eintritt">Eintrittsdatum (Unterschrift)</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <select class="form-select" id="tn_jc_team" required>
                              <option selected disabled value="">JC-Team *</option>
                              <option>Team A</option>
                              <option>Team B</option>
                              <option>Team C</option>
                            </select>
                            <label for="tn_jc_team">JC-Team *</label>
                          </div>
                        </div>

                        <div class="col-md-4 mb-3">
                          <div class="form-floating">
                            <select class="form-select" id="tn_jc_mitarbeiter" required>
                              <option selected disabled value="">JC-Mitarbeiter *</option>
                              <option>Alessandro</option>
                              <option>Uwe</option>
                              <option>Maria</option>
                            </select>
                            <label for="tn_jc_mitarbeiter">JC-Mitarbeiter *</label>
                          </div>
                        </div>
                      </div>

                      <!-- UX Hint: Eintrittsdatum steuert Status -->
                      <div class="alert alert-light border small d-flex gap-2 mt-2 mb-0">
                        <i class="bi bi-info-circle text-secondary mt-1"></i>
                        <div class="text-secondary">
                          <strong>Hinweis:</strong> Ohne Eintrittsdatum wird der Teilnehmer als <strong>Geplant</strong> gespeichert und erscheint <strong>nicht</strong> in ESF-Statistiken.
                          Mit Eintrittsdatum wird er ab diesem Datum als <strong>Aktiv</strong> geführt und die Unterlagen können gedruckt werden.
                        </div>
                      </div>

                      <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="btnBack2">
                          <i class="bi bi-arrow-left me-1"></i> Zurück
                        </button>
                        <button type="button" class="btn btn-primary" id="btnNext2">
                          Weiter <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                      </div>
                    </div>

                    <!-- STEP 3 -->
                    <div id="step3" class="content d-none" role="tabpanel" aria-labelledby="step3-trigger">
                      <div class="row">
                        <div class="col-lg-8 mb-3">
                          <div class="form-floating">
                            <textarea class="form-control" id="tn_notizen" placeholder="Notizen" style="height: 180px;"></textarea>
                            <label for="tn_notizen">Notizen</label>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <div class="alert alert-light border h-100 mb-0 d-flex gap-2">
                            <i class="bi bi-info-circle text-secondary mt-1"></i>
                            <div class="small text-secondary">
                              Infotext...
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="btnBack3">
                          <i class="bi bi-arrow-left me-1"></i> Zurück
                        </button>
                        <button type="button" class="btn btn-primary" id="btnNext3">
                          Weiter <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                      </div>
                    </div>

                    <!-- STEP 4 -->
                    <div id="step4" class="content d-none" role="tabpanel" aria-labelledby="step4-trigger">

                      <div class="row g-3">

                        <!-- LINKS: Übersicht kompakt -->
                        <div class="col-lg-6">
                          <div class="card border-0 shadow-sm">
                            <div class="card-body">
                              <div class="fw-semibold mb-2">
                                <i class="bi bi-card-checklist me-2"></i>Übersicht Eingaben
                              </div>

                              <div class="small">
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Name</span>
                                  <span class="fw-semibold text-end" id="sum_name">—</span>
                                </div>
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Geburt</span>
                                  <span class="fw-semibold text-end" id="sum_geb">—</span>
                                </div>
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Kontakt</span>
                                  <span class="fw-semibold text-end" id="sum_tel">—</span>
                                </div>
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Adresse</span>
                                  <span class="fw-semibold text-end" id="sum_addr">—</span>
                                </div>
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Maßnahme</span>
                                  <span class="fw-semibold text-end" id="sum_massnahme">—</span>
                                </div>
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Betreuer</span>
                                  <span class="fw-semibold text-end" id="sum_betreuer">—</span>
                                </div>
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Zuweisung</span>
                                  <span class="fw-semibold text-end" id="sum_zuweisung">—</span>
                                </div>
                                <!-- NEU: Eintrittsdatum in Übersicht -->
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Eintrittsdatum</span>
                                  <span class="fw-semibold text-end" id="sum_eintritt">—</span>
                                </div>
                                <!-- NEU: Status-Vorschau -->
                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">Status</span>
                                  <span class="fw-semibold text-end">
                                  <span class="badge bg-secondary" id="sum_status">—</span>
                                </span>

                                </div>

                                <div class="d-flex justify-content-between border-bottom py-1">
                                  <span class="text-secondary">JC-Team</span>
                                  <span class="fw-semibold text-end" id="sum_jc_team">—</span>
                                </div>
                                <div class="d-flex justify-content-between py-1">
                                  <span class="text-secondary">JC-MA</span>
                                  <span class="fw-semibold text-end" id="sum_jc_mitarbeiter">—</span>
                                </div>
                              </div>

                              <hr class="my-3">

                              <!-- Schalter entfernt, stattdessen klare Erklärung -->
                              <div class="alert alert-light border small mb-0 d-flex gap-2">
                                <i class="bi bi-info-circle text-secondary mt-1"></i>
                                <div class="text-secondary">
                                  Speichern Sie den Teilnehmer entweder als <strong>Geplant</strong> (ohne Eintrittsdatum) oder als <strong>Aktiv</strong> (mit Eintrittsdatum).
                                  Nur <strong>Aktiv</strong> darf in ESF-Statistiken auftauchen.
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- RECHTS: Erstunterlagen -->
                        <div class="col-lg-6">
                          <div class="card border-0 shadow-sm">
                            <div class="card-body">
                              <div class="fw-semibold mb-2">
                                <i class="bi bi-file-earmark-text me-2"></i>Erstunterlagen
                              </div>
                              <div class="text-secondary small mb-3">
                                Unterlagen auswählen, die beim Termin zur Unterschrift ausgedruckt werden.
                                <span class="d-block mt-1">
                                  <strong>Hinweis:</strong> Druck ist nur möglich, wenn ein Eintrittsdatum gesetzt ist.
                                </span>
                              </div>

                              <div class="border rounded-3 p-3 bg-light mb-3">
                                <div class="fw-semibold mb-2">Art der Beförderung</div>
                                <div class="form-check">
                                  <input class="form-check-input" type="radio" name="befoerderung" id="befOepnv" value="ÖPNV" checked>
                                  <label class="form-check-label" for="befOepnv">ÖPNV</label>
                                </div>
                                <div class="form-check">
                                  <input class="form-check-input" type="radio" name="befoerderung" id="befPkw" value="PKW">
                                  <label class="form-check-label" for="befPkw">PKW</label>
                                </div>
                              </div>

                              <div class="row g-1">
                                <div class="col-sm-6">
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docAgh" checked>
                                    <label class="form-check-label" for="docAgh">Vereinbarung AGH</label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docAktivierung" checked>
                                    <label class="form-check-label" for="docAktivierung">Vereinbarung Aktivierung</label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docKursordnung" checked>
                                    <label class="form-check-label" for="docKursordnung">Kursordnung</label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docDatenschutz" checked>
                                    <label class="form-check-label" for="docDatenschutz">Datenschutzrechtliche Hinweise</label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docInfoEinv" checked>
                                    <label class="form-check-label" for="docInfoEinv">Info- und Einverständnis</label>
                                  </div>
                                </div>

                                <div class="col-sm-6">
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docFahrtkosten" checked>
                                    <label class="form-check-label" for="docFahrtkosten">Bestätigung Fahrtkosten</label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docRegelungFahrtkosten" checked>
                                    <label class="form-check-label" for="docRegelungFahrtkosten">Regelung Fahrtkosten (Aktivierung)</label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docPersonalbogen" checked>
                                    <label class="form-check-label" for="docPersonalbogen">Personalbogen</label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docEltern" checked>
                                    <label class="form-check-label" for="docEltern">Einverständnis Elternarbeit</label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="docFoto" checked>
                                    <label class="form-check-label" for="docFoto">Einverständnis Foto</label>
                                  </div>
                                </div>
                              </div>

                              <hr class="my-3">

                              <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnDocsAll">
                                  <i class="bi bi-check2-square me-1"></i>Alle auswählen
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnDocsNone">
                                  <i class="bi bi-square me-1"></i>Alle abwählen
                                </button>
                              </div>

                            </div>
                          </div>
                        </div>

                      </div>

                      <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" id="btnBack4">
                          <i class="bi bi-arrow-left me-1"></i> Zurück
                        </button>

                        <!-- NEU: 2 Buttons statt 1 -->
                        <div class="d-flex flex-wrap gap-2">
                          <button type="button" class="btn btn-outline-primary" id="btnSavePlanned">
                            <i class="bi bi-calendar-plus me-1"></i> Als geplant speichern
                          </button>

                          <button type="button" class="btn btn-success" id="btnSaveActivePrint" disabled>
                            <i class="bi bi-printer me-1"></i> Eintritt speichern &amp; Unterlagen drucken
                          </button>
                        </div>
                      </div>

                    </div>
                  </div><!-- /bs-stepper-content -->
                </div><!-- /bs-stepper -->
              </div><!-- /card -->
            </form>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bs-stepper/dist/js/bs-stepper.min.js"></script>

  <script>
    let stepper;

    // --- DEMO-DATEN ---
    const TN_PROFILE_LINK = "TN-Profil_grunddaten.html";
    const NO_EINTRITT_LABEL = "Noch nicht unterschrieben";

    const participants = [
      { name: "Max Mustermann", kundennr: "1234434", geb: "2000-01-01", status: "Aktiv",   von:"2025-01-01", bis:"2026-01-01", eintritt:"2025-01-03", massnahme:"Integra 2025", betreuer:"Daniel Chu" },
      { name: "Mia Musterfrau",  kundennr: "2234434", geb: "1998-04-19", status: "Geplant", von:"2026-02-01", bis:"2026-07-31", eintritt:"",          massnahme:"Integra 2025", betreuer:"Daniel Chu" },
      { name: "Leo Beispiel",    kundennr: "3234434", geb: "1987-09-10", status: "Beendet", von:"2024-03-01", bis:"2024-12-20", eintritt:"2024-03-01", massnahme:"Integra 2024", betreuer:"Corinna Adams" },
      { name: "Sara Demo",       kundennr: "4234434", geb: "1992-12-05", status: "Aktiv",   von:"2025-09-01", bis:"2026-08-31", eintritt:"2025-09-02", massnahme:"ZUKUNFT.SAUBER", betreuer:"Janine Kerber" },
      { name: "Tim Test",        kundennr: "5234434", geb: "2001-06-21", status: "Aktiv",   von:"2025-02-15", bis:"2025-11-30", eintritt:"2025-02-18", massnahme:"Integra 2025", betreuer:"Corinna Adams" },
      { name: "Nina Klick",      kundennr: "6234434", geb: "1995-08-14", status: "Geplant", von:"2026-03-15", bis:"2026-12-15", eintritt:"",          massnahme:"ZUKUNFT.SAUBER", betreuer:"Janine Kerber" },
      { name: "Jonas Platz",     kundennr: "7234434", geb: "1989-11-02", status: "Beendet", von:"2023-10-01", bis:"2024-02-29", eintritt:"2023-10-05", massnahme:"Integra 2024", betreuer:"Daniel Chu" },
      { name: "Lara Beispiel",   kundennr: "8234434", geb: "1999-02-28", status: "Aktiv",   von:"2025-05-01", bis:"2026-04-30", eintritt:"2025-05-01", massnahme:"Integra 2025", betreuer:"Daniel Chu" },
      { name: "Paul Probe",      kundennr: "9234434", geb: "1990-07-07", status: "Geplant", von:"2026-01-15", bis:"2026-06-30", eintritt:"",          massnahme:"Integra 2025", betreuer:"Corinna Adams" },
      { name: "Elli Muster",     kundennr: "1034434",geb: "2002-03-03", status: "Beendet",  von:"2024-06-01", bis:"2025-01-31", eintritt:"2024-06-03", massnahme:"Integra 2024", betreuer:"Janine Kerber" }
    ];

    // --- Helpers ---
    function toISODate(value) { return (value || "").trim(); }

    function fmtDate(iso) {
      if (!iso) return "";
      const [y,m,d] = iso.split("-");
      if (!y || !m || !d) return iso;
      return `${d}.${m}.${y}`;
    }

    function initialsBadge(name) {
      const parts = (name || "").split(" ").filter(Boolean);
      const a = parts[0]?.[0] || "T";
      const b = parts[1]?.[0] || parts[0]?.[1] || "N";
      return (a + b).toUpperCase();
    }

    function statusBadge(status) {
      const s = (status || "").toLowerCase();
      if (s === "aktiv") return `<span class="badge bg-success">Aktiv</span>`;
      if (s === "geplant") return `<span class="badge bg-primary">Geplant</span>`;
      if (s === "beendet") return `<span class="badge bg-secondary">Beendet</span>`;
      return `<span class="badge bg-light text-dark">${status || "—"}</span>`;
    }

    // Zeitraum-Filter: Überlappung
    function matchesDateRange(tnVon, tnBis, fltVon, fltBis) {
      const v = toISODate(fltVon);
      const b = toISODate(fltBis);
      if (!v && !b) return true;

      const aVon = toISODate(tnVon);
      const aBis = toISODate(tnBis);

      if (v && !b) return (!aBis || aBis >= v);
      if (!v && b) return (!aVon || aVon <= b);
      return (!aVon || aVon <= b) && (!aBis || aBis >= v);
    }

    function renderTable(rows) {
      const tbody = document.getElementById("tnTbody");
      tbody.innerHTML = "";

      rows.forEach(p => {
        const tr = document.createElement("tr");
        tr.className = "row-click";
        tr.setAttribute("data-row-click", TN_PROFILE_LINK);
        tr.setAttribute("data-bs-toggle", "tooltip");
        tr.setAttribute("title", "Profil aufrufen");
        tr.style.cursor = "pointer";

        const eintrittCell = (p.status === "Geplant")
          ? `<span class="text-secondary">${NO_EINTRITT_LABEL}</span>`
          : (p.eintritt ? fmtDate(p.eintritt) : "—");

        tr.innerHTML = `
          <td data-col="teilnehmer" class="fw-semibold">
            <span class="badge text-bg-secondary me-2">${initialsBadge(p.name)}</span> ${p.name}
          </td>
          <td data-col="kundennr">${p.kundennr}</td>
          <td data-col="geb">${fmtDate(p.geb) || "—"}</td>
          <td data-col="status">${statusBadge(p.status)}</td>
          <td data-col="zuweisung">${fmtDate(p.von)} - ${fmtDate(p.bis)}</td>
          <td data-col="eintritt">${eintrittCell}</td>
          <td data-col="massnahme">${p.massnahme}</td>
          <td data-col="betreuer">${p.betreuer}</td>
          <td data-col="aktionen" class="text-end">
            <div class="btn-group btn-group-sm" role="group" aria-label="Aktionen">
              <button class="btn btn-outline-secondary" title="Profil" onclick="event.stopPropagation()"><i class="bi bi-person-vcard"></i></button>
              <button class="btn btn-outline-secondary" title="Notiz" onclick="event.stopPropagation()"><i class="bi bi-journal-text"></i></button>
              <button class="btn btn-outline-secondary" title="Mehr" onclick="event.stopPropagation()"><i class="bi bi-three-dots"></i></button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Tooltips neu initialisieren (dynamische Zeilen)
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

      // Row click -> iframe / navigation
      document.querySelectorAll("[data-row-click]").forEach(row => {
        row.addEventListener("click", function () {
          const targetPage = this.getAttribute("data-row-click");
          let frame = null;
          try { frame = parent.document.getElementById("mainFrame"); } catch (e) {}
          if (frame && targetPage) frame.src = targetPage;
          else if (targetPage) window.location.href = targetPage;
        });
      });

      document.getElementById("cntTeilnehmer").textContent = String(rows.length);
    }

    function applyFilters() {
      const q = (document.getElementById("fltSearch")?.value || "").trim().toLowerCase();
      const massnahme = document.getElementById("fltMassnahme")?.value || "";
      const betreuer = document.getElementById("fltBetreuer")?.value || "";
      const status = document.getElementById("fltStatus")?.value || "";
      const von = document.getElementById("fltVon")?.value || "";
      const bis = document.getElementById("fltBis")?.value || "";

      const filtered = participants.filter(p => {
        const hay = [p.name, p.kundennr, p.massnahme, p.betreuer, p.status].join(" ").toLowerCase();

        if (q && !hay.includes(q)) return false;
        if (massnahme && p.massnahme !== massnahme) return false;
        if (betreuer && p.betreuer !== betreuer) return false;
        if (status && p.status !== status) return false;
        if (!matchesDateRange(p.von, p.bis, von, bis)) return false;

        return true;
      });

      renderTable(filtered);
    }

    function setColumnVisibility(colKey, visible) {
      const table = document.getElementById("tnTable");
      if (!table) return;
      table.querySelectorAll(`[data-col="${colKey}"]`).forEach(cell => {
        cell.classList.toggle("col-hide", !visible);
      });
    }

    function closeModal(id) {
      const modalEl = document.getElementById(id);
      if (!modalEl) return;
      let modal = bootstrap.Modal.getInstance(modalEl);
      if (!modal) modal = new bootstrap.Modal(modalEl);
      modal.hide();
    }

    document.addEventListener("DOMContentLoaded", function () {
      // Tooltips (statische Elemente)
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

      // Initial Table
      renderTable(participants);
      applyFilters();

      // Filter events
      ["fltSearch","fltMassnahme","fltBetreuer","fltStatus","fltVon","fltBis"].forEach(id => {
        document.getElementById(id)?.addEventListener("input", applyFilters);
        document.getElementById(id)?.addEventListener("change", applyFilters);
      });
      document.getElementById("btnSearch")?.addEventListener("click", (e) => { e.preventDefault(); applyFilters(); });

      document.getElementById("btnReset")?.addEventListener("click", () => {
        document.getElementById("fltSearch").value = "";
        document.getElementById("fltMassnahme").value = "";
        document.getElementById("fltBetreuer").value = "";
        document.getElementById("fltStatus").value = "";
        document.getElementById("fltVon").value = "";
        document.getElementById("fltBis").value = "";
        applyFilters();
      });

      // Spalten-Toggles
      document.querySelectorAll(".col-toggle").forEach(cb => {
        const colKey = cb.getAttribute("data-col");
        setColumnVisibility(colKey, cb.checked);
        cb.addEventListener("change", () => setColumnVisibility(colKey, cb.checked));
      });

      // Stepper init
      const stepperElement = document.querySelector("#stepper");
      if (stepperElement) {
        stepper = new window.Stepper(stepperElement);
        showStep("step1");
      }

      // Step navigation
      document.getElementById("btnNext1")?.addEventListener("click", () => {
        const nachname = document.getElementById("tn_nachname");
        if (nachname && !nachname.value.trim()) {
          nachname.focus();
          nachname.classList.add("is-invalid");
          return;
        }
        nachname?.classList.remove("is-invalid");
        stepper.next(); showStep("step2");
      });

      document.getElementById("btnBack2")?.addEventListener("click", () => { stepper.previous(); showStep("step1"); });

      document.getElementById("btnNext2")?.addEventListener("click", () => {
        const requiredIds = ["tn_massnahme","tn_betreuer","tn_zuweisung_von","tn_zuweisung_bis","tn_jc_team","tn_jc_mitarbeiter"];
        let ok = true;
        requiredIds.forEach(id => {
          const el = document.getElementById(id);
          if (el && !String(el.value || "").trim()) { el.classList.add("is-invalid"); ok = false; }
          else el?.classList.remove("is-invalid");
        });
        if (!ok) return;

        stepper.next(); showStep("step3");
      });

      document.getElementById("btnBack3")?.addEventListener("click", () => { stepper.previous(); showStep("step2"); });
      document.getElementById("btnNext3")?.addEventListener("click", () => {
        stepper.next(); showStep("step4");
        updateSummary();
        syncSaveButtons(); // neu
      });
      document.getElementById("btnBack4")?.addEventListener("click", () => { stepper.previous(); showStep("step3"); });

      function showStep(id) {
        document.querySelectorAll(".bs-stepper-content .content").forEach(s => s.classList.add("d-none"));
        document.getElementById(id)?.classList.remove("d-none");
      }

      function getDocIds() {
        return [
          "docAgh","docAktivierung","docKursordnung","docDatenschutz","docInfoEinv",
          "docFahrtkosten","docRegelungFahrtkosten","docPersonalbogen","docEltern","docFoto"
        ];
      }

      function getSelectedDocs() {
        const labels = {
          docAgh: "Vereinbarung AGH",
          docAktivierung: "Vereinbarung Aktivierung",
          docKursordnung: "Kursordnung",
          docDatenschutz: "Datenschutzrechtliche Hinweise",
          docInfoEinv: "Info- und Einverständnis",
          docFahrtkosten: "Bestätigung Fahrtkosten",
          docRegelungFahrtkosten: "Regelung Fahrtkosten (Aktivierung)",
          docPersonalbogen: "Personalbogen",
          docEltern: "Einverständnis Elternarbeit",
          docFoto: "Einverständnis Foto"
        };
        const selected = [];
        getDocIds().forEach(id => {
          const el = document.getElementById(id);
          if (el && el.checked) selected.push(labels[id] || id);
        });
        return selected;
      }

      function collectTeilnehmerPayload() {
        const befoerderung = document.querySelector('input[name="befoerderung"]:checked')?.value || "ÖPNV";
        const eintritt = document.getElementById("tn_eintritt")?.value || "";
        const status = eintritt ? "Aktiv" : "Geplant";

        return {
          nachname: (document.getElementById("tn_nachname")?.value || "").trim(),
          vorname: (document.getElementById("tn_vorname")?.value || "").trim(),
          geburtsdatum: document.getElementById("tn_geburtsdatum")?.value || "",
          strasse: (document.getElementById("tn_strasse")?.value || "").trim(),
          hausnummer: (document.getElementById("tn_hausnummer")?.value || "").trim(),
          plz: (document.getElementById("tn_plz")?.value || "").trim(),
          ort: (document.getElementById("tn_ort")?.value || "").trim(),
          land: (document.getElementById("tn_land")?.value || "").trim(),
          telefon: (document.getElementById("tn_telefon")?.value || "").trim(),
          mobil: (document.getElementById("tn_mobil")?.value || "").trim(),
          mail: (document.getElementById("tn_mail")?.value || "").trim(),
          massnahme: document.getElementById("tn_massnahme")?.value || "",
          betreuer: document.getElementById("tn_betreuer")?.value || "",
          zuweisung_von: document.getElementById("tn_zuweisung_von")?.value || "",
          zuweisung_bis: document.getElementById("tn_zuweisung_bis")?.value || "",
          eintritt,
          jc_team: document.getElementById("tn_jc_team")?.value || "",
          jc_mitarbeiter: document.getElementById("tn_jc_mitarbeiter")?.value || "",
          status,
          befoerderung,
          docs: getSelectedDocs()
        };
      }

      function validateRequired() {
        const requiredIds = ["tn_nachname","tn_massnahme","tn_betreuer","tn_zuweisung_von","tn_zuweisung_bis","tn_jc_team","tn_jc_mitarbeiter"];
        let ok = true;
        requiredIds.forEach(id => {
          const el = document.getElementById(id);
          if (el && !String(el.value || "").trim()) { el.classList.add("is-invalid"); ok = false; }
          else el?.classList.remove("is-invalid");
        });
        if (!ok) {
          if (!document.getElementById("tn_nachname")?.value.trim()) { stepper.to(1); showStep("step1"); }
          else { stepper.to(2); showStep("step2"); }
        }
        return ok;
      }

      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }

      function syncSaveButtons() {
        const eintritt = document.getElementById("tn_eintritt")?.value || "";
        const btnActive = document.getElementById("btnSaveActivePrint");
        if (btnActive) btnActive.disabled = !eintritt;
        // Status-Vorschau aktualisieren
        setText("sum_status", eintritt ? "Aktiv" : "Geplant");
      }

      function updateSummary() {
        const p = collectTeilnehmerPayload();

        const fullName = [p.vorname, p.nachname].filter(Boolean).join(" ").trim() || "—";
        setText("sum_name", fullName);
        setText("sum_geb", p.geburtsdatum || "—");

        const tel = [p.telefon, p.mobil].filter(Boolean).join(" / ");
        setText("sum_tel", tel || "—");

        const addrLine1 = [p.strasse, p.hausnummer].filter(Boolean).join(" ").trim();
        const addrLine2 = [p.plz, p.ort].filter(Boolean).join(" ").trim();
        const addrLine3 = p.land || "";
        const addr = [addrLine1, addrLine2, addrLine3].filter(Boolean).join(", ") || "—";
        setText("sum_addr", addr);

        setText("sum_massnahme", p.massnahme || "—");
        setText("sum_betreuer", p.betreuer || "—");

        const zuw = (p.zuweisung_von || p.zuweisung_bis) ? `${p.zuweisung_von || "—"} bis ${p.zuweisung_bis || "—"}` : "—";
        setText("sum_zuweisung", zuw);

        setText("sum_eintritt", p.eintritt ? fmtDate(p.eintritt) : "—");
        setText("sum_status", p.status || "—");

        setText("sum_jc_team", p.jc_team || "—");
        setText("sum_jc_mitarbeiter", p.jc_mitarbeiter || "—");
      }

      // Live Summary Update
      const liveIds = [
        "tn_nachname","tn_vorname","tn_geburtsdatum","tn_telefon","tn_mobil",
        "tn_strasse","tn_hausnummer","tn_plz","tn_ort","tn_land",
        "tn_massnahme","tn_betreuer","tn_zuweisung_von","tn_zuweisung_bis",
        "tn_eintritt",
        "tn_jc_team","tn_jc_mitarbeiter"
      ];
      liveIds.forEach(id => document.getElementById(id)?.addEventListener("input", () => { updateSummary(); syncSaveButtons(); }));
      liveIds.forEach(id => document.getElementById(id)?.addEventListener("change", () => { updateSummary(); syncSaveButtons(); }));

      // Docs quick actions
      document.getElementById("btnDocsAll")?.addEventListener("click", () => {
        getDocIds().forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
      });
      document.getElementById("btnDocsNone")?.addEventListener("click", () => {
        getDocIds().forEach(id => { const el = document.getElementById(id); if (el) el.checked = false; });
      });

      // NEU: Speichern als GEPLANT (ohne Eintritt, ohne Druck)
      document.getElementById("btnSavePlanned")?.addEventListener("click", function () {
        if (!validateRequired()) return;

        const payload = collectTeilnehmerPayload();
        payload.status = "Geplant";
        payload.eintritt = ""; // hart setzen, damit Logik eindeutig ist

        console.log("SAVE Teilnehmer (Geplant) (Demo)", payload);

        closeModal("teilnehmerModal");
        alert(
          "Teilnehmer gespeichert (Geplant) (Demo).\n\n" +
          "Teilnehmer: " + [payload.vorname, payload.nachname].filter(Boolean).join(" ") + "\n" +
          "Maßnahme: " + payload.massnahme + "\n" +
          "Status: Geplant\n\n" +
          "Hinweis: Er erscheint nicht in ESF-Statistiken (keine Unterschrift)."
        );
      });

      // NEU: Speichern als AKTIV + Drucken
      document.getElementById("btnSaveActivePrint")?.addEventListener("click", function () {
        if (!validateRequired()) return;

        const payload = collectTeilnehmerPayload();
        if (!payload.eintritt) {
          alert("Bitte ein Eintrittsdatum setzen, um als Aktiv zu speichern und Unterlagen zu drucken.");
          document.getElementById("tn_eintritt")?.focus();
          return;
        }
        payload.status = "Aktiv";

        console.log("SAVE Teilnehmer (Aktiv + Print) (Demo)", payload);

        closeModal("teilnehmerModal");

        const docs = getSelectedDocs();
        alert(
          "Teilnehmer gespeichert (Aktiv) & Drucken (Demo)\n\n" +
          "Teilnehmer: " + [payload.vorname, payload.nachname].filter(Boolean).join(" ") + "\n" +
          "Maßnahme: " + payload.massnahme + "\n" +
          "Eintritt: " + fmtDate(payload.eintritt) + "\n" +
          "Status: Aktiv\n" +
          "Beförderung: " + payload.befoerderung + "\n\n" +
          "Unterlagen:\n- " + (docs.length ? docs.join("\n- ") : "(keine)")
        );
      });

      // Reset when modal closes
      const modalEl = document.getElementById("teilnehmerModal");
      modalEl?.addEventListener("hidden.bs.modal", () => {
        document.getElementById("teilnehmerForm")?.reset();
        stepper?.to(1);
        showStep("step1");
        ["tn_nachname","tn_massnahme","tn_betreuer","tn_zuweisung_von","tn_zuweisung_bis","tn_jc_team","tn_jc_mitarbeiter"]
          .forEach(id => document.getElementById(id)?.classList.remove("is-invalid"));

        // Buttons/Übersicht zurücksetzen
        setText("sum_eintritt", "—");
        setText("sum_status", "—");
        const btnActive = document.getElementById("btnSaveActivePrint");
        if (btnActive) btnActive.disabled = true;
      });
    });
  </script>

</body>
</html>
