<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PHÖNIX – Maßnahme Detail</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Custom Styles -->
  <link rel="stylesheet" href="css/custom.css">
</head>

<body class="bg-light p-4 p-lg-5">

<div class="xx">

  <!-- CARD: Titel + KPIs + (aufklappbare) Stammdaten -->
  <div class="card border-0 shadow mb-3">
    <div class="card-body p-4">

      <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
        <div>
          <div class="text-secondary small">Maßnahme</div>
          <h2 class="fw-normal mb-0" id="mNameTitle">Integra 2025</h2>
          <div class="text-secondary mt-2" style="font-size:.95rem;">
            Dashboard & Verwaltung
          </div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" type="button" id="btnEditMassnahme">
            <i class="bi bi-pencil-square me-1"></i> Bearbeiten
          </button>
          <button class="btn btn-primary" type="button" onclick="document.querySelector('[data-bs-target=&quot;#tab-berichte&quot;]')?.click()">
            <i class="bi bi-file-earmark-text me-1"></i> Berichte
          </button>
        </div>
      </div>

      <hr class="my-3">

      <!-- ROW 1: KPIs -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <div class="card border-0 bg-body-tertiary h-100">
            <div class="card-body p-3">
              <div class="text-secondary small text-uppercase">Belegung</div>
              <div class="display-6 fw-bold mt-2">
                <span id="kpiBelegungPct">50</span><span>%</span>
              </div>
              <div class="text-secondary">
                <span id="kpiBelegungAbs">10 von 20</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 bg-body-tertiary h-100">
            <div class="card-body p-3">
              <div class="text-secondary small text-uppercase">Anwesenheit</div>
              <div class="display-6 fw-bold mt-2">
                <span id="kpiAnwesenheitPct">56</span><span>%</span>
              </div>
              <div class="text-secondary small" id="kpiAnwesenheitHint">Monat: aktuell</div>
            </div>
          </div>
        </div>

        <div class="col-md-2">
          <div class="card border-0 bg-body-tertiary h-100">
            <div class="card-body p-3">
              <div class="text-secondary small text-uppercase">Module</div>
              <div class="display-6 fw-bold mt-2" id="kpiModule">8</div>
              <div class="text-secondary small">zugeordnet</div>
            </div>
          </div>
        </div>

        <div class="col-md-2">
          <div class="card border-0 bg-body-tertiary h-100">
            <div class="card-body p-3">
              <div class="text-secondary small text-uppercase">Vermittlungen</div>
              <div class="display-6 fw-bold mt-2 text-success" id="kpiVermittlungen">2</div>
              <div class="text-secondary small">gesamt</div>
            </div>
          </div>
        </div>

        <div class="col-md-2">
          <div class="card border-0 bg-body-tertiary h-100">
            <div class="card-body p-3">
              <div class="text-secondary small text-uppercase">Laufzeit</div>
              <div class="fw-semibold mt-2" id="mVon">01.01.2024</div>
              <div class="text-secondary" id="mBis">– 31.06.2025</div>
              <span class="badge text-bg-primary mt-2" id="mFoerderungBadge">ESF</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Aufklappbarer Block: Maßnahmendetails (Standard: geschlossen) -->
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <button class="btn btn-outline-secondary btn-sm"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#massnahmeDetailsCollapse"
                aria-expanded="false"
                aria-controls="massnahmeDetailsCollapse">
          <i class="bi bi-chevron-down me-1"></i> Zeige alle Maßnahmendetails
        </button>
      </div>

      <div class="collapse" id="massnahmeDetailsCollapse">
        <div class="border rounded-3 p-3 bg-white">
          <div class="row g-3">

            <!-- BLOCK: Grunddaten -->
            <div class="col-12 col-lg-3">
              <div class="border rounded-3 p-3 h-100" data-edit-block="grunddaten">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="fw-semibold"><i class="bi bi-card-text me-2"></i>Grunddaten</div>
                  <button class="btn btn-outline-secondary btn-sm py-0 px-2"
                          type="button"
                          data-edit-gear="grunddaten"
                          title="Bearbeiten">
                    <i class="bi bi-gear"></i>
                  </button>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Kurzname</label>
                  <input class="form-control form-control-sm" id="mKurzname" type="text" readonly>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Kategorie</label>
                  <select class="form-select form-select-sm" id="mKategorie" disabled>
                    <option>Sonstige</option>
                    <option>AGH</option>
                    <option selected>Aktivierung</option>
                  </select>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Förderung</label>
                  <select class="form-select form-select-sm" id="mFoerderungText" disabled>
                    <option selected>ESF</option>
                    <option>Andere</option>
                  </select>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">AZ</label>
                  <input class="form-control form-control-sm" id="mAZ" type="text" readonly>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">nrArge</label>
                  <input class="form-control form-control-sm" id="mNrArge" type="text" readonly>
                </div>

                <div class="mb-0">
                  <label class="form-label small text-muted mb-1">Kostenstelle</label>
                  <input class="form-control form-control-sm" id="mKostenstelle" type="text" readonly>
                </div>

                <div class="d-flex gap-2 justify-content-end mt-3 d-none" data-edit-actions="grunddaten">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-edit-cancel="grunddaten">
                    Abbrechen
                  </button>
                  <button class="btn btn-primary btn-sm" type="button" data-edit-save="grunddaten">
                    <i class="bi bi-check2 me-1"></i> Speichern
                  </button>
                </div>
              </div>
            </div>

            <!-- BLOCK: Kosten & Plätze -->
            <div class="col-12 col-lg-3">
              <div class="border rounded-3 p-3 h-100" data-edit-block="kostenplaetze">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="fw-semibold"><i class="bi bi-cash-coin me-2"></i>Kosten & Plätze</div>
                  <button class="btn btn-outline-secondary btn-sm py-0 px-2"
                          type="button"
                          data-edit-gear="kostenplaetze"
                          title="Bearbeiten">
                    <i class="bi bi-gear"></i>
                  </button>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Platzzahl</label>
                  <input class="form-control form-control-sm" id="mPlatzzahl" type="number" readonly>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Kostenpauschale (Euro)</label>
                  <input class="form-control form-control-sm" id="mKostenpauschale" type="text" readonly>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Mehraufwand (Euro)</label>
                  <input class="form-control form-control-sm" id="mMehraufwand" type="text" readonly>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Anzahl U (Urlaub)</label>
                  <input class="form-control form-control-sm" id="mUrlaub" type="number" readonly>
                </div>

                <div class="mb-0">
                  <label class="form-label small text-muted mb-1">Sonstiges</label>
                  <textarea class="form-control form-control-sm" id="mSonstiges" rows="3" readonly></textarea>
                </div>

                <div class="d-flex gap-2 justify-content-end mt-3 d-none" data-edit-actions="kostenplaetze">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-edit-cancel="kostenplaetze">
                    Abbrechen
                  </button>
                  <button class="btn btn-primary btn-sm" type="button" data-edit-save="kostenplaetze">
                    <i class="bi bi-check2 me-1"></i> Speichern
                  </button>
                </div>
              </div>
            </div>

            <!-- BLOCK: Vergabe & Inhalt -->
            <div class="col-12 col-lg-3">
              <div class="border rounded-3 p-3 h-100" data-edit-block="vergabe">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="fw-semibold"><i class="bi bi-folder2-open me-2"></i>Vergabe & Inhalt</div>
                  <button class="btn btn-outline-secondary btn-sm py-0 px-2"
                          type="button"
                          data-edit-gear="vergabe"
                          title="Bearbeiten">
                    <i class="bi bi-gear"></i>
                  </button>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Vergabenummer</label>
                  <input class="form-control form-control-sm" id="mVergabenummer" type="text" readonly>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Losnummer</label>
                  <input class="form-control form-control-sm" id="mLosnummer" type="text" readonly>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">VB Arbeitsverteilung</label>
                  <input class="form-control form-control-sm" id="mVBArbeitsverteilung" type="text" readonly>
                </div>

                <div class="mb-0">
                  <label class="form-label small text-muted mb-1">Tätigkeit</label>
                  <textarea class="form-control form-control-sm" id="mTaetigkeit" rows="6" readonly></textarea>
                </div>

                <div class="d-flex gap-2 justify-content-end mt-3 d-none" data-edit-actions="vergabe">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-edit-cancel="vergabe">
                    Abbrechen
                  </button>
                  <button class="btn btn-primary btn-sm" type="button" data-edit-save="vergabe">
                    <i class="bi bi-check2 me-1"></i> Speichern
                  </button>
                </div>
              </div>
            </div>

            <!-- BLOCK: Ansprechpartner -->
            <div class="col-12 col-lg-3">
              <div class="border rounded-3 p-3 h-100" data-edit-block="ansprechpartner">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="fw-semibold"><i class="bi bi-person-lines-fill me-2"></i>Ansprechpartner</div>
                  <button class="btn btn-outline-secondary btn-sm py-0 px-2"
                          type="button"
                          data-edit-gear="ansprechpartner"
                          title="Bearbeiten">
                    <i class="bi bi-gear"></i>
                  </button>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted mb-1">Namen (je Zeile ein Name)</label>
                  <textarea class="form-control form-control-sm" id="mAnsprechpartnerText" rows="6" readonly></textarea>
                  <div class="form-text small">In der Übersicht/Chips wird die Liste zusammengefasst dargestellt.</div>
                </div>

                <div class="border rounded-3 p-2 bg-body-tertiary">
                  <div class="small text-muted mb-1">Übersicht (Chips)</div>
                  <div class="d-flex flex-wrap gap-2" id="mAnsprechpartnerChips">
                    <span class="text-muted small">—</span>
                  </div>
                </div>

                <div class="d-flex gap-2 justify-content-end mt-3 d-none" data-edit-actions="ansprechpartner">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-edit-cancel="ansprechpartner">
                    Abbrechen
                  </button>
                  <button class="btn btn-primary btn-sm" type="button" data-edit-save="ansprechpartner">
                    <i class="bi bi-check2 me-1"></i> Speichern
                  </button>
                </div>
              </div>
            </div>

          </div><!-- /row -->
        </div><!-- /border -->
      </div><!-- /collapse -->

    </div>
  </div>

  <!-- CARD: Tabs + Inhalte -->
  <div class="card border-0 shadow">
    <div class="card-body p-0">

      <!-- Tabs -->
      <div class="px-3 px-lg-4 pt-3 pt-lg-4 border-bottom">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-teilnehmer">
              <i class="bi bi-people me-1"></i> Teilnehmer
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-anwesenheit">
              <i class="bi bi-calendar-check me-1"></i> Anwesenheiten erfassen
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-fahrkosten">
              <i class="bi bi-car-front me-1"></i> Fahrtkosten
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-arbeitsbereiche">
              <i class="bi bi-diagram-3 me-1"></i> Arbeitsbereiche
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-berichte">
              <i class="bi bi-file-earmark-text me-1"></i> Berichte & Auswertungen
            </button>
          </li>
        </ul>
      </div>

      <div class="tab-content p-3 p-lg-4">

        <!-- TAB: TEILNEHMER -->
        <div class="tab-pane fade show active" id="tab-teilnehmer">

          <div class="text-secondary mb-3" style="font-size: 0.95rem;">
            Hier sehen Sie alle Teilnehmer dieser Maßnahme. Standardmäßig werden <strong>aktive</strong> Teilnehmer angezeigt.
            Über <strong>Mehr Filter</strong> können Sie auch <strong>geplante</strong> und <strong>beendete</strong> Teilnehmer einblenden.
          </div>

          <!-- Filter (aufgeräumt) -->
          <div class="card border-0 bg-body-tertiary mb-3">
            <div class="card-body p-3">

              <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-2">
                <div>
                  <div class="text-secondary small">Filtern / Suchen</div>
                  <div class="text-secondary" style="font-size:.95rem;">
                    Standardfilter oben – Status & Zeitraum bei Bedarf über <strong>Mehr Filter</strong>.
                  </div>
                </div>
              </div>

              <div class="row g-2 align-items-end">
                <div class="col-12 col-lg-4">
                  <div class="input-group">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="tnFilterSearch" placeholder="Name, Kennung, Kürzel …">
                  </div>
                </div>

                <div class="col-12 col-lg-2">
                  <select class="form-select" id="tnFilterBetreuer">
                    <option value="" selected>Betreuer</option>
                    <option>Daniel Chu</option>
                    <option>Holger Irmak</option>
                  </select>
                </div>

                <div class="col-12 col-lg-2">
                  <select class="form-select" id="tnFilterArbeitsbereich">
                    <option value="" selected>Arbeitsbereich</option>
                    <option>Maler</option>
                    <option>Gärtnerei</option>
                    <option>Hauswirtschaft</option>
                  </select>
                </div>

                <div class="col-12 col-lg-2">
                  <select class="form-select" id="tnFilterAnleiter">
                    <option value="" selected>Anleiter</option>
                    <option>Sabine König</option>
                    <option>Thomas Weber</option>
                    <option>Murat Yilmaz</option>
                  </select>
                </div>

                <div class="col-12 col-lg-2">
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-dark w-100" type="button" id="btnTnApply">
                      <i class="bi bi-funnel me-1"></i> Anwenden
                    </button>

                    <button class="btn btn-outline-secondary" type="button"
                            data-bs-toggle="collapse" data-bs-target="#tnMoreFilters"
                            aria-expanded="false" aria-controls="tnMoreFilters"
                            title="Mehr Filter">
                      <i class="bi bi-sliders"></i>
                    </button>

                    <button class="btn btn-outline-secondary" type="button" id="btnTnReset" title="Zurücksetzen">
                      <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Mehr Filter -->
              <div class="collapse mt-2" id="tnMoreFilters">
                <div class="border rounded-3 bg-white p-3">
                  <div class="row g-2 align-items-end">

                    <div class="col-12 col-lg-6">
                      <div class="small text-muted mb-1">Status anzeigen</div>
                      <div class="d-flex flex-wrap gap-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="statusAktiv" checked>
                          <label class="form-check-label" for="statusAktiv">aktiv</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="statusGeplant">
                          <label class="form-check-label" for="statusGeplant">geplant</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="statusBeendet">
                          <label class="form-check-label" for="statusBeendet">beendet</label>
                        </div>
                      </div>
                      <div class="form-text small">
                        Standard ist nur <strong>aktiv</strong>. Für Planung/Archiv weitere Status aktivieren.
                      </div>
                    </div>

                    <div class="col-12 col-lg-3">
                      <div class="form-floating">
                        <input type="date" class="form-control" id="tnFilterVon" value="">
                        <label for="tnFilterVon">Zuweisung von</label>
                      </div>
                    </div>
                    <div class="col-12 col-lg-3">
                      <div class="form-floating">
                        <input type="date" class="form-control" id="tnFilterBis" value="">
                        <label for="tnFilterBis">Zuweisung bis</label>
                      </div>
                    </div>

                  </div>

                  <hr class="my-3">

                  <div class="d-flex flex-wrap gap-2 justify-content-end">
                    <button class="btn btn-outline-secondary btn-sm" type="button"
                            data-bs-toggle="collapse" data-bs-target="#tnMoreFilters" aria-expanded="true">
                      <i class="bi bi-chevron-up me-1"></i> Schließen
                    </button>
                    <button class="btn btn-outline-dark btn-sm" type="button" id="btnTnApply2">
                      <i class="bi bi-funnel me-1"></i> Anwenden
                    </button>
                  </div>

                </div>
              </div>

            </div>
          </div>

          <!-- Wichtige Aktionen (unter Filter, vor Tabelle) -->
          <div class="d-flex justify-content-end gap-2 mb-2">
            <div class="dropdown">
              <button class="btn btn-primary text-nowrap dropdown-toggle"
                      type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-list-ul me-2"></i> Teilnehmerliste
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <button class="dropdown-item" type="button" onclick="showToast('Export', 'Teilnehmerliste als PDF (Demo).')">
                    <i class="bi bi-filetype-pdf me-2"></i> PDF
                  </button>
                </li>
                <li>
                  <button class="dropdown-item" type="button" onclick="showToast('Export', 'Teilnehmerliste als Word (Demo).')">
                    <i class="bi bi-filetype-docx me-2"></i> Word
                  </button>
                </li>
              </ul>
            </div>

            <button class="btn btn-success text-nowrap" type="button" id="btnOpenUnterschriftenModal">
              <i class="bi bi-pen me-2"></i> Unterschriftenliste
            </button>
          </div>

          <!-- Tabelle Teilnehmer -->
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
              <tr>
                <th>Teilnehmer</th>
                <th>Status</th>
                <th>Eintritt</th>
                <th>Betreuer</th>
                <th>Anleiter</th>
                <th>Arbeitsbereich</th>
                <th>Zuweisung</th>
                <th>Maßnahme</th>
                <th>JC-Betreuer</th>
                <th class="text-end">Aktionen</th>
              </tr>
              </thead>
              <tbody id="tnTableBody">
                <!-- per JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- TAB: ANWESENHEIT -->
        <div class="tab-pane fade" id="tab-anwesenheit">
          <div class="card border-0 bg-body-tertiary mb-3">
            <div class="card-body p-3">
              <div class="row g-2">
                <div class="col-md-6"><select class="form-select"><option selected>Betreuer</option></select></div>
                <div class="col-md-6"><select class="form-select"><option selected>Arbeitsbereich</option></select></div>
              </div>
              <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
                <button class="btn btn-outline-secondary"><i class="bi bi-chevron-left"></i></button>
                <input type="date" class="form-control w-auto" value="2025-05-21">
                <button class="btn btn-outline-secondary"><i class="bi bi-chevron-right"></i></button>
                <button class="btn btn-outline-dark ms-lg-2">Alle Anwesend</button>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
              <tr><th>Teilnehmer</th><th>Anwesenheit</th><th class="text-end">Aktion</th></tr>
              </thead>
              <tbody>
              <tr>
                <td><span class="badge text-bg-secondary me-2">MM</span> Max Mustermann</td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-outline-secondary btn-sm" onclick="setAnwesend(this)">Anwesend</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="setSpecial(this, 'krank')">Krank</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="setSpecial(this, 'entschuldigt')">Entschuldigt</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="setSpecial(this, 'unentschuldigt')">Unentschuldigt</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="setSpecial(this, 'urlaub')">Urlaub</button>
                  </div>
                </td>
                <td class="text-end">
                  <button class="btn btn-outline-dark btn-sm" onclick="toggleDetails(this)">Detail</button>
                </td>
              </tr>

              <tr class="d-none detail-row">
                <td colspan="3" class="bg-light">
                  <div id="anwesenheit-zeiten" class="mb-3 d-none">
                    <div class="mb-2">
                      <strong>Praxis</strong>
                      <input type="time" class="form-control d-inline-block w-auto ms-2 me-2" value="08:00">
                      <input type="time" class="form-control d-inline-block w-auto me-2" value="16:00">
                      <input type="text" class="form-control d-inline-block w-auto" value="8 Stunden" readonly>
                    </div>
                    <div class="mb-2">
                      <strong>Theorie</strong>
                      <input type="time" class="form-control d-inline-block w-auto ms-2 me-2" value="08:00">
                      <input type="time" class="form-control d-inline-block w-auto me-2" value="16:00">
                      <input type="text" class="form-control d-inline-block w-auto" value="8 Stunden" readonly>
                    </div>
                  </div>

                  <div id="sonderoptionen" class="mt-3 d-none">
                    <div class="mb-2 d-flex flex-wrap align-items-center gap-2">
                      <label class="form-label mb-0">von:</label>
                      <input type="date" class="form-control w-auto">
                      <label class="form-label mb-0">bis:</label>
                      <input type="date" class="form-control w-auto">

                      <button class="btn btn-outline-primary btn-sm" id="auBtn" style="display:none;">
                        <i class="bi bi-upload me-1"></i> AU hochladen
                      </button>

                      <input type="text" class="form-control w-auto" id="urlaubFeld" placeholder="Urlaubsanspruch" style="display:none;">
                    </div>

                    <div class="mb-2" id="grundFeld" style="display:none;">
                      <label for="grundInput" class="form-label">Grund</label>
                      <input type="text" class="form-control" id="grundInput" placeholder="z. B. Arzttermin">
                    </div>
                  </div>

                  <button class="btn btn-outline-primary btn-sm mt-2">
                    <i class="bi bi-pen me-1"></i> persönliche Arbeitszeit bearbeiten
                  </button>
                </td>
              </tr>

              </tbody>
            </table>
          </div>
        </div>

        <!-- TAB: FAHRKOSTEN -->
        <div class="tab-pane fade" id="tab-fahrkosten">
          <div class="text-secondary">Fahrkosten für die gesamte Maßhname nach Monaten</div>
        </div>

        <!-- TAB: ARBEITSBEREICHE -->
        <div class="tab-pane fade" id="tab-arbeitsbereiche">
          <div class="text-secondary">Platzhalter: Arbeitsbereiche-Inhalte folgen.</div>
        </div>

        <!-- TAB: BERICHTE & AUSWERTUNGEN -->
        <div class="tab-pane fade" id="tab-berichte">

          <!-- === SCREEN A: Start (Accordion) === -->
          <div id="reportsHome">
            <div class="card border-0 bg-body">
              <div class="card-body p-4">

                <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
                  <div>
                    <div class="text-secondary small">Erzeugen / Export</div>
                    <h5 class="mb-0">Berichte & Abrechnungen</h5>
                    <div class="text-secondary mt-2" style="font-size:.95rem;">
                      Wählen Sie eine Kategorie und erzeugen Sie die gewünschte Auswertung (PDF / Excel).
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm">
                      <i class="bi bi-funnel me-1"></i> Filter
                    </button>
                    <button class="btn btn-outline-secondary btn-sm">
                      <i class="bi bi-download me-1"></i> Export-Center
                    </button>
                  </div>
                </div>

                <hr class="my-3">

                <div class="accordion accordion-flush" id="reportsAccordion">

                  <div class="accordion-item border-0">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed bg-body text-dark fw-semibold shadow-none"
                        type="button" data-bs-toggle="collapse" data-bs-target="#cFahrt">
                        <i class="bi bi-car-front me-2"></i> Fahrtkosten
                      </button>
                    </h2>
                    <div id="cFahrt" class="accordion-collapse collapse">
                      <div class="accordion-body bg-body text-dark pt-2">
                        <div class="d-grid gap-2">
                          <button class="btn btn-outline-secondary text-start">
                            <i class="bi bi-receipt me-2"></i> Fahrtkostenabrechnung
                          </button>
                          <button class="btn btn-outline-secondary text-start">
                            <i class="bi bi-calculator me-2"></i> Fahrtkostenkalkulation
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item border-0">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed bg-body text-dark fw-semibold shadow-none"
                        type="button" data-bs-toggle="collapse" data-bs-target="#cEsf">
                        <i class="bi bi-file-earmark-check me-2"></i> ESF / Abrechnung
                      </button>
                    </h2>
                    <div id="cEsf" class="accordion-collapse collapse">
                      <div class="accordion-body bg-body text-dark pt-2">
                        <div class="d-grid gap-2">
                          <button class="btn btn-outline-secondary text-start" id="btnEsfMitAbrechnung">
                            <i class="bi bi-people me-2"></i> Teilnehmer mit ESF Abrechnung
                          </button>
                          <button class="btn btn-outline-secondary text-start">
                            <i class="bi bi-people me-2"></i> Teilnehmer ohne ESF Abrechnung
                          </button>

                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item border-0">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed bg-body text-dark fw-semibold shadow-none"
                        type="button" data-bs-toggle="collapse" data-bs-target="#cListen">
                        <i class="bi bi-card-list me-2"></i> Listen & Unterlagen
                      </button>
                    </h2>
                    <div id="cListen" class="accordion-collapse collapse">
                      <div class="accordion-body bg-body text-dark pt-2">
                        <div class="d-grid gap-2">
                          <button class="btn btn-outline-secondary text-start">
                            <i class="bi bi-bar-chart me-2"></i> Belegungszahlen
                          </button>
                          <button class="btn btn-outline-secondary text-start">
                            <i class="bi bi-building me-2"></i> Liste Jobcenter – Anlage 2
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                </div><!-- /accordion -->
              </div>
            </div>
          </div>

          <!-- === SCREEN B: ESF Report === -->
          <div id="esfReportScreen" class="d-none">

            <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
              <div>
                <div class="text-secondary small">ESF / Abrechnung</div>
                <h5 class="mb-0">Teilnehmer mit ESF-Abrechnung</h5>
                <div class="text-secondary mt-2" style="font-size:.95rem;">
                  Filtern Sie nach Zeitraum. Öffnen Sie pro Teilnehmer das ESF-Formular zur Prüfung/Bearbeitung
                  und erzeugen Sie anschließend alle Stammblätter gesammelt.
                </div>
              </div>
                <div class="d-flex gap-3">
                <button class="btn btn-outline-secondary btn-md px-3" type="button" id="btnBackToReports">
                    <i class="bi bi-arrow-left me-2"></i> Zurück
                </button>

                <button class="btn btn-primary btn-md px-3" type="button" id="btnEsfBatchCreate">
                    <i class="bi bi-layers-fill me-2"></i> Alle Stammblätter erzeugen
                </button>
                </div>


            </div>

            <!-- Filter + KPIs (ESF-Zeitraum) -->
            <div class="card border-0 bg-body-tertiary mb-3">
              <div class="card-body p-3">
                <div class="text-secondary small mb-2">ESF-Zeitraum</div>

                <div class="row g-2 align-items-end">
                  <div class="col-12 col-lg-4">
                    <div class="form-floating">
                      <input type="date" class="form-control" id="esfFilterVon" value="2024-01-01">
                      <label for="esfFilterVon">Datum von</label>
                    </div>
                  </div>
                  <div class="col-12 col-lg-4">
                    <div class="form-floating">
                      <input type="date" class="form-control" id="esfFilterBis" value="2025-12-31">
                      <label for="esfFilterBis">Datum bis</label>
                    </div>
                  </div>
                  <div class="col-12 col-lg-4 d-flex gap-2">
                    <button class="btn btn-outline-dark w-100" type="button" id="btnEsfApply">
                      <i class="bi bi-funnel me-1"></i> Anwenden
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="btnEsfReset" title="Zurücksetzen">
                      <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                  </div>
                </div>

                <hr class="my-3">

                <div class="row g-2">
                  <div class="col-md-4">
                    <div class="border rounded-3 p-2 bg-white">
                      <div class="text-secondary small">Treffer</div>
                      <div class="fs-4 fw-semibold" id="esfKpiTreffer">0</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="border rounded-3 p-2 bg-white">
                      <div class="text-secondary small">Vollständig</div>
                      <div class="fs-4 fw-semibold text-success" id="esfKpiOk">0</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="border rounded-3 p-2 bg-white">
                      <div class="text-secondary small">Prüfen</div>
                      <div class="fs-4 fw-semibold text-warning" id="esfKpiOpen">0</div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- Ergebnisliste (ESF Vertrag = Haken) -->
            <div class="card border-0 shadow-sm">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Teilnehmer</th>
                        <th>Zuweisung</th>
                        <th>ESF-Vertrag Zustimmung</th>
                        <th>Daten</th>
                        <th class="text-end">Aktionen</th>
                      </tr>
                    </thead>
                    <tbody id="esfResultsBody">
                      <!-- per JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div><!-- /esfReportScreen -->

        </div><!-- /tab-berichte -->

      </div><!-- /tab-content -->
    </div>
  </div>

</div><!-- /container -->


<!-- === Unterschriftenliste Modal === -->
<div class="modal fade" id="unterschriftenModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <div class="text-secondary small">Drucken</div>
          <h5 class="modal-title mb-0">Unterschriftenliste</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>

      <div class="modal-body">
        <div class="text-secondary mb-3" style="font-size:.95rem;">
          Wählen Sie den Tag, für den die Unterschriftenliste gedruckt wird (Teilnehmer bestätigen Anwesenheit und Tätigkeit).
        </div>

        <div class="form-floating mb-3">
          <input type="date" class="form-control" id="uDatum">
          <label for="uDatum">Datum (für den Ausdruck)</label>
        </div>

        <div class="d-grid gap-2">
          <button class="btn btn-primary" type="button" id="btnUDruckPdf">
            <i class="bi bi-printer me-2"></i> Unterschriftenliste (PDF drucken)
          </button>
          <button class="btn btn-outline-secondary" type="button" id="btnUDruckExcel">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i> Unterschriftenliste (Excel)
          </button>
        </div>

        <div class="alert alert-info mt-3 mb-0 py-2">
          <i class="bi bi-info-circle me-1"></i>
          Demo: Buttons zeigen nur eine Meldung (keine echte Datei-Erzeugung).
        </div>
      </div>
    </div>
  </div>
</div>


<!-- === ESF Modal (Prüfen/Bearbeiten) === -->
<div class="modal fade" id="esfModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <div>
          <div class="text-secondary small">ESF-Formular</div>
          <h5 class="modal-title mb-0" id="esfModalTitle">Teilnehmer</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>

      <div class="modal-body">

        <div class="alert alert-warning py-2 d-none" id="esfModalWarn">
          <i class="bi bi-exclamation-triangle me-1"></i>
          Einige Pflichtfelder fehlen. Bitte ergänzen, bevor Stammblatt erzeugt wird.
        </div>

        <!-- Kopf: Name/Kennung + Zuweisung -->
        <div class="row g-2 mb-2">
          <div class="col-md-6">
            <div class="form-floating">
              <input class="form-control" id="esfName" type="text" readonly>
              <label for="esfName">Name</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input class="form-control" id="esfKennung" type="text" readonly>
              <label for="esfKennung">Kennung</label>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-floating">
              <input class="form-control" id="esfZuweisungVon" type="date" readonly>
              <label for="esfZuweisungVon">Zuweisung von</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input class="form-control" id="esfZuweisungBis" type="date" readonly>
              <label for="esfZuweisungBis">Zuweisung bis</label>
            </div>
          </div>
        </div>

        <!-- ESF Toggle + Hinweis -->
        <div class="alert alert-warning py-2 px-3 mb-3" role="alert">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
              <input type="checkbox" id="esfToggle" class="form-check-input m-0" style="transform: scale(1.2);" disabled>
              <label for="esfToggle" class="form-check-label fw-semibold mb-0">ESF</label>
            </div>

            <div class="small text-muted d-flex align-items-center gap-2">
              <span id="esfVertragInfoIcon" class="text-success d-none"><i class="bi bi-check-circle-fill"></i></span>
              <span id="esfVertragInfoText">Vertrag: —</span>
            </div>
          </div>

          <div class="small mt-2">
            <strong>Hinweis:</strong> Ohne Unterschrift dürfen keine ESF Daten gespeichert und kein Stammblatt erzeugt werden.
          </div>
        </div>

        <form class="row g-3" id="esfFormModal" onsubmit="return false;">

          <!-- OBERER BLOCK: Übernommene Angaben -->
          <div class="row g-3 row-cols-1 row-cols-md-2 row-cols-xl-4">

            <!-- Eintrittsdatum (übernommen) -->
            <div class="col">
              <div class="form-floating">
                <input type="date" class="form-control" id="esfEintrittsdatum" readonly>
                <label for="esfEintrittsdatum">Eintrittsdatum (übernommen)</label>
              </div>
            </div>

            <!-- Drittstaat -->
            <div class="col">
              <div class="form-floating">
                <select class="form-select" id="esfDrittstaat" disabled>
                  <option value="">keine Angabe</option>
                  <option value="ja">Ja</option>
                  <option value="nein">Nein</option>
                </select>
                <label for="esfDrittstaat">Drittstaatsangehörige/r</label>
              </div>
            </div>

            <!-- Geflüchtet -->
            <div class="col">
              <div class="form-floating">
                <select class="form-select" id="esfGefluechtet" disabled>
                  <option value="">keine Angabe</option>
                  <option value="ja">Ja</option>
                  <option value="nein">Nein</option>
                </select>
                <label for="esfGefluechtet">ist geflüchtet</label>
              </div>
            </div>

            <!-- ausländische Herkunft -->
            <div class="col">
              <div class="form-floating">
                <select class="form-select" id="esfAuslaendischeHerkunft" disabled>
                  <option value="">keine Angabe</option>
                  <option value="ja">Ja</option>
                  <option value="nein">Nein</option>
                </select>
                <label for="esfAuslaendischeHerkunft">ausländische Herkunft</label>
              </div>
            </div>

          </div>

          <div class="col-12">
            <hr class="mt-1 mb-1">
          </div>

          <!-- Einverständniserklärung -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfEinverstaendnis" disabled>
                <option value="">Bitte wählen …</option>
                <option value="Ja">Ja</option>
                <option value="Nein">Nein</option>
              </select>
              <label for="esfEinverstaendnis">Einverständniserklärung liegt vor</label>
            </div>
          </div>

          <!-- Leistungsbezug nach SGB -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfSgbLeistung" disabled>
                <option value="">Bitte wählen …</option>
                <option value="SGB II (Bürgergeld)">SGB II (Bürgergeld)</option>
                <option value="SGB III (Arbeitslosengeld I)">SGB III (Arbeitslosengeld I)</option>
                <option value="kein Leistungsbezug">kein Leistungsbezug</option>
              </select>
              <label for="esfSgbLeistung">Leistungsbezug nach SGB (bei Eintritt)</label>
            </div>
          </div>

          <!-- Höchster Schulabschluss -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfSchulabschluss" disabled>
                <option value="">Bitte wählen …</option>
                <option value="kein Schulabschluss">kein Schulabschluss</option>
                <option value="Haupt-/Mittelschulabschluss">Haupt-/Mittelschulabschluss</option>
                <option value="Realschulabschluss">Realschulabschluss</option>
                <option value="Fachhochschulreife/Abitur">Fachhochschulreife/Abitur</option>
              </select>
              <label for="esfSchulabschluss">höchster erreichter Schulabschluss</label>
            </div>
          </div>

          <!-- Höchster Berufsabschluss -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfBerufsabschluss" disabled>
                <option value="">Bitte wählen …</option>
                <option value="kein Berufsabschluss">kein Berufsabschluss</option>
                <option value="anerkannte Berufsausbildung">anerkannte Berufsausbildung</option>
                <option value="Meister / Techniker">Meister / Techniker</option>
                <option value="akademischer Abschluss">akademischer Abschluss</option>
              </select>
              <label for="esfBerufsabschluss">höchster erreichter Berufsabschluss</label>
            </div>
          </div>

          <!-- Zielgruppe -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfZielgruppe" disabled>
                <option value="">Bitte wählen …</option>
                <option value="arbeitslos">arbeitslos</option>
                <option value="langzeitarbeitslos">langzeitarbeitslos</option>
                <option value="erwerbstätig, von Armut bedroht">erwerbstätig, von Armut bedroht</option>
              </select>
              <label for="esfZielgruppe">Zielgruppe</label>
            </div>
          </div>

          <!-- Fester Wohnsitz -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfWohnsitz" disabled>
                <option value="">Bitte wählen …</option>
                <option value="Ja">Ja</option>
                <option value="Nein">Nein</option>
                <option value="keine Angabe">keine Angabe</option>
              </select>
              <label for="esfWohnsitz">Fester Wohnsitz</label>
            </div>
          </div>

          <!-- Abschnitt "Beendet" -->
          <div class="col-12 mt-2">
            <hr>
            <h6 class="text-muted mb-0">Beendet</h6>
          </div>

          <!-- Gründe für vorzeitigen Austritt -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfAustrittsgrund" disabled>
                <option value="">Bitte wählen …</option>
                <option value="regulär beendet">regulär beendet</option>
                <option value="vorzeitig abgebrochen (Teilnehmer)">vorzeitig abgebrochen (Teilnehmer)</option>
                <option value="vorzeitig beendet (Träger/JC)">vorzeitig beendet (Träger/JC)</option>
              </select>
              <label for="esfAustrittsgrund">Gründe für vorzeitigen Austritt</label>
            </div>
          </div>

          <!-- Erreichte Zertifizierung -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfZertifizierung" disabled>
                <option value="">Bitte wählen …</option>
                <option value="keine Zertifizierung">keine Zertifizierung</option>
                <option value="interne Teilnahmebescheinigung">interne Teilnahmebescheinigung</option>
                <option value="anerkannte Qualifizierung / Zertifikat">anerkannte Qualifizierung / Zertifikat</option>
              </select>
              <label for="esfZertifizierung">erreichte Zertifizierung</label>
            </div>
          </div>

          <!-- Verbleib nach Austritt -->
          <div class="col-md-4">
            <div class="form-floating">
              <select class="form-select" id="esfVerbleib" disabled>
                <option value="">Bitte wählen …</option>
                <option value="Beschäftigung aufgenommen">Beschäftigung aufgenommen</option>
                <option value="Ausbildung / Schule">Ausbildung / Schule</option>
                <option value="weiter arbeitslos">weiter arbeitslos</option>
                <option value="sonstiger Verbleib">sonstiger Verbleib</option>
              </select>
              <label for="esfVerbleib">Verbleib nach Austritt</label>
            </div>
          </div>

        </form>

      </div>

      <div class="modal-footer">
        <div class="me-auto d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary" type="button" id="btnEsfModalEdit">
            <i class="bi bi-gear me-1"></i> Bearbeiten
          </button>
          <span class="text-secondary small" id="esfModalStatusText">Status: —</span>
        </div>

        <button class="btn btn-outline-secondary d-none" type="button" id="btnEsfModalCancel">Abbrechen</button>

        <button class="btn btn-success d-none" type="button" id="btnEsfModalSave">
          <i class="bi bi-check2 me-1"></i> ESF-Angaben speichern
        </button>

        <button class="btn btn-danger" type="button" id="btnEsfModalCreateStammblatt">
          <i class="bi bi-file-earmark-arrow-down me-1"></i> Stammblatt erzeugen
        </button>
      </div>

    </div>
  </div>
</div>


<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
  <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="bi bi-info-circle me-2"></i>
      <strong class="me-auto" id="toastTitle">Info</strong>
      <small class="text-muted">jetzt</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Schließen"></button>
    </div>
    <div class="toast-body" id="toastBody">—</div>
  </div>
</div>

<!-- Bootstrap Script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // =========================
  // Utils
  // =========================
  function fmtDateDE(iso) {
    if (!iso) return "–";
    const [y,m,d] = iso.split("-");
    if (!y || !m || !d) return iso;
    return `${d}.${m}.${y}`;
  }
  function euro(v) {
    const n = Number(v);
    if (Number.isNaN(n)) return "0,00 €";
    return n.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
  }
  function showToast(title, body) {
    const t = document.getElementById("appToast");
    document.getElementById("toastTitle").textContent = title;
    document.getElementById("toastBody").textContent = body;
    const toast = bootstrap.Toast.getOrCreateInstance(t, { delay: 2500 });
    toast.show();
  }
</script>

<script>
  // =========================
  // Stammdaten füllen
  // =========================
  const massnahmeInput = {
    kurzname: "Integra 2025",
    von: "2024-01-01",
    bis: "2025-06-30",
    nrArge: "555XV5974",
    kostenstelle: "KS-0815",
    sonstiges: "Bemerkung zur Maßnahme …",
    platzzahl: 20,
    kostenpauschale: 1200.00,
    mehraufwand: 150.00,
    az: "AZ-123",
    urlaub: 30,
    kategorie: "Aktivierung",
    foerderung: "ESF",
    vbArbeitsverteilung: "Vormittagsgruppe / Nachmittagsgruppe",
    vergabenummer: "V-2025-001",
    losnummer: "LOS-03",
    taetigkeit: "Längerer Text zur Tätigkeit.\nMehrzeilig möglich.\nHier steht später richtig viel.",
    ansprechpartner: ["Frau Müller", "Herr Schmidt"]
  };

  function renderChipsFromTextArea() {
    const chips = document.getElementById("mAnsprechpartnerChips");
    const ta = document.getElementById("mAnsprechpartnerText");
    if (!chips || !ta) return;

    const lines = ta.value
      .split("\n")
      .map(s => s.trim())
      .filter(Boolean);

    if (lines.length === 0) {
      chips.innerHTML = `<span class="text-muted small">—</span>`;
      return;
    }

    chips.innerHTML = lines.map(n => `
      <span class="badge text-bg-light border">
        <i class="bi bi-person me-1"></i>${String(n).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}
      </span>
    `).join("");
  }

  function renderMassnahmeStammdaten() {
    document.getElementById("mNameTitle").textContent = massnahmeInput.kurzname;
    document.getElementById("mVon").textContent = fmtDateDE(massnahmeInput.von);
    document.getElementById("mBis").textContent = "– " + fmtDateDE(massnahmeInput.bis);
    document.getElementById("mFoerderungBadge").textContent = massnahmeInput.foerderung || "—";

    document.getElementById("mKurzname").value = massnahmeInput.kurzname || "";
    document.getElementById("mAZ").value = massnahmeInput.az || "";
    document.getElementById("mNrArge").value = massnahmeInput.nrArge || "";
    document.getElementById("mKostenstelle").value = massnahmeInput.kostenstelle || "";

    const kat = document.getElementById("mKategorie");
    if (kat) kat.value = massnahmeInput.kategorie || "Sonstige";

    const fo = document.getElementById("mFoerderungText");
    if (fo) fo.value = massnahmeInput.foerderung || "Andere";

    document.getElementById("mPlatzzahl").value = (massnahmeInput.platzzahl ?? "");
    document.getElementById("mKostenpauschale").value = euro(massnahmeInput.kostenpauschale);
    document.getElementById("mMehraufwand").value = euro(massnahmeInput.mehraufwand);
    document.getElementById("mUrlaub").value = (massnahmeInput.urlaub ?? "");
    document.getElementById("mSonstiges").value = massnahmeInput.sonstiges || "";

    document.getElementById("mVergabenummer").value = massnahmeInput.vergabenummer || "";
    document.getElementById("mLosnummer").value = massnahmeInput.losnummer || "";
    document.getElementById("mVBArbeitsverteilung").value = massnahmeInput.vbArbeitsverteilung || "";
    document.getElementById("mTaetigkeit").value = massnahmeInput.taetigkeit || "";

    const ta = document.getElementById("mAnsprechpartnerText");
    if (ta) ta.value = (massnahmeInput.ansprechpartner || []).join("\n");
    renderChipsFromTextArea();
  }
</script>

<script>
  // =========================
  // Edit-Logik pro Block
  // =========================
  const editSnapshots = {};

  function getBlockEl(blockKey) {
    return document.querySelector(`[data-edit-block="${blockKey}"]`);
  }
  function getEditableFields(blockKey) {
    const block = getBlockEl(blockKey);
    if (!block) return [];
    return Array.from(block.querySelectorAll("input, select, textarea"));
  }
  function setBlockEditing(blockKey, isEditing) {
    const fields = getEditableFields(blockKey);
    const actions = document.querySelector(`[data-edit-actions="${blockKey}"]`);
    const gear = document.querySelector(`[data-edit-gear="${blockKey}"]`);

    fields.forEach(f => {
      if (f.tagName === "SELECT") f.disabled = !isEditing;
      else f.readOnly = !isEditing;
    });

    if (actions) actions.classList.toggle("d-none", !isEditing);
    if (gear) gear.disabled = isEditing;

    const block = getBlockEl(blockKey);
    if (block) block.classList.toggle("border-primary", isEditing);
  }
  function snapshotBlock(blockKey) {
    const fields = getEditableFields(blockKey);
    editSnapshots[blockKey] = fields.map(f => ({ id: f.id, value: f.value }));
  }
  function restoreBlock(blockKey) {
    const snap = editSnapshots[blockKey] || [];
    snap.forEach(s => {
      const el = document.getElementById(s.id);
      if (el) el.value = s.value;
    });
    if (blockKey === "ansprechpartner") renderChipsFromTextArea();
  }
  function initBlockEditors() {
    document.querySelectorAll("[data-edit-gear]").forEach(btn => {
      btn.addEventListener("click", () => {
        const blockKey = btn.getAttribute("data-edit-gear");
        const ok = window.confirm("Sind Sie sicher, dass Sie die Daten ändern wollen?");
        if (!ok) return;
        snapshotBlock(blockKey);
        setBlockEditing(blockKey, true);
      });
    });

    document.querySelectorAll("[data-edit-cancel]").forEach(btn => {
      btn.addEventListener("click", () => {
        const blockKey = btn.getAttribute("data-edit-cancel");
        restoreBlock(blockKey);
        setBlockEditing(blockKey, false);
      });
    });

    document.querySelectorAll("[data-edit-save]").forEach(btn => {
      btn.addEventListener("click", () => {
        const blockKey = btn.getAttribute("data-edit-save");
        setBlockEditing(blockKey, false);
        if (blockKey === "ansprechpartner") renderChipsFromTextArea();
      });
    });

    ["grunddaten","kostenplaetze","vergabe","ansprechpartner"].forEach(k => setBlockEditing(k, false));
  }
</script>

<script>
  // =========================
  // Teilnehmer: Daten + Filter
  // =========================
  const demoTeilnehmerMassnahme = [
    {
      id: "tn-001", kuerzel: "MM", name: "Max Mustermann", kennung: "KV-555NXX",
      status: "aktiv", eintritt: "2024-01-15", zuweisungVon: "2024-01-15", zuweisungBis: "2024-12-31",
      betreuer: "Daniel Chu", anleiter: "Sabine König", arbeitsbereich: "Maler", massnahme: "Integra 2025", jcBetreuer: "Daniel Chu"
    },
    {
      id: "tn-002", kuerzel: "CP", name: "Claudia Peters", kennung: "JC-555XCRT",
      status: "aktiv", eintritt: "2024-03-01", zuweisungVon: "2024-03-01", zuweisungBis: "2025-03-01",
      betreuer: "Daniel Chu", anleiter: "Thomas Weber", arbeitsbereich: "Gärtnerei", massnahme: "Integra 2025", jcBetreuer: "Holger Irmak"
    },
    {
      id: "tn-003", kuerzel: "AB", name: "Ali Benali", kennung: "JC-1003",
      status: "geplant", eintritt: "", zuweisungVon: "2025-02-01", zuweisungBis: "2025-08-31",
      betreuer: "Holger Irmak", anleiter: "Murat Yilmaz", arbeitsbereich: "Hauswirtschaft", massnahme: "Integra 2025", jcBetreuer: "Daniel Chu"
    },
    {
      id: "tn-004", kuerzel: "LS", name: "Leonie Schmitt", kennung: "JC-2044",
      status: "beendet", eintritt: "2024-02-05", zuweisungVon: "2024-02-05", zuweisungBis: "2024-10-31",
      betreuer: "Daniel Chu", anleiter: "Sabine König", arbeitsbereich: "Maler", massnahme: "Integra 2025", jcBetreuer: "Holger Irmak"
    },
    {
      id: "tn-005", kuerzel: "HR", name: "Hasan Rahmani", kennung: "JC-3110",
      status: "aktiv", eintritt: "2024-06-01", zuweisungVon: "2024-06-01", zuweisungBis: "2025-06-30",
      betreuer: "Holger Irmak", anleiter: "Thomas Weber", arbeitsbereich: "Gärtnerei", massnahme: "Integra 2025", jcBetreuer: "Daniel Chu"
    },
    {
      id: "tn-006", kuerzel: "NK", name: "Nina Keller", kennung: "JC-4088",
      status: "geplant", eintritt: "", zuweisungVon: "2025-04-01", zuweisungBis: "2025-12-31",
      betreuer: "Daniel Chu", anleiter: "Murat Yilmaz", arbeitsbereich: "Hauswirtschaft", massnahme: "Integra 2025", jcBetreuer: "Holger Irmak"
    },
    {
      id: "tn-007", kuerzel: "FB", name: "Fatima Bouzid", kennung: "JC-5122",
      status: "beendet", eintritt: "2024-01-20", zuweisungVon: "2024-01-20", zuweisungBis: "2024-07-31",
      betreuer: "Holger Irmak", anleiter: "Sabine König", arbeitsbereich: "Gärtnerei", massnahme: "Integra 2025", jcBetreuer: "Daniel Chu"
    }
  ];

  function statusBadgeTn(status) {
    const s = String(status || "").toLowerCase();
    if (s === "aktiv") return `<span class="badge text-bg-success">aktiv</span>`;
    if (s === "geplant") return `<span class="badge text-bg-secondary">geplant</span>`;
    if (s === "beendet") return `<span class="badge text-bg-dark">beendet</span>`;
    return `<span class="badge text-bg-light border text-dark">—</span>`;
  }

  function fmtEintritt(eintrittISO, status) {
    if (eintrittISO) return fmtDateDE(eintrittISO);
    const s = String(status || "").toLowerCase();
    if (s === "geplant") return "noch nicht gestartet";
    return "—";
  }

  function withinRangeOverlap(vonISO, bisISO, fromISO, toISO) {
    if (!vonISO && !bisISO) return true;

    const aStart = vonISO ? new Date(vonISO + "T00:00:00") : null;
    const aEnd   = bisISO ? new Date(bisISO + "T00:00:00") : null;

    const f = fromISO ? new Date(fromISO + "T00:00:00") : null;
    const t = toISO ? new Date(toISO + "T00:00:00") : null;

    const start = aStart || aEnd;
    const end   = aEnd || aStart;

    if (!start || !end) return true;

    if (f && end < f) return false;
    if (t && start > t) return false;
    return true;
  }

  function renderTeilnehmerTable(list) {
    const tbody = document.getElementById("tnTableBody");
    if (!tbody) return;

    if (!list || list.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="10" class="text-center text-secondary py-4">
            <i class="bi bi-inbox me-1"></i> Keine Treffer für die aktuellen Filter.
          </td>
        </tr>`;
      return;
    }

    tbody.innerHTML = list.map(tn => `
      <tr class="massnahme-tn-row" data-page="TN-Profil_massnahme.html" style="cursor:pointer;">
        <td class="fw-semibold">
          <span class="badge text-bg-secondary me-2">${tn.kuerzel}</span> ${tn.name}<br>
          <span class="text-secondary small">${tn.kennung}</span>
        </td>
        <td>${statusBadgeTn(tn.status)}</td>
        <td>${fmtEintritt(tn.eintritt, tn.status)}</td>
        <td>${tn.betreuer || "—"}</td>
        <td>${tn.anleiter || "—"}</td>
        <td>${tn.arbeitsbereich || "—"}</td>
        <td>${fmtDateDE(tn.zuweisungVon)} – ${fmtDateDE(tn.zuweisungBis)}</td>
        <td>${tn.massnahme || "—"}</td>
        <td>${tn.jcBetreuer || "—"}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); showToast('Bearbeiten', 'Teilnehmer bearbeiten (Demo).');">
            <i class="bi bi-pencil me-1"></i> Bearbeiten
          </button>
        </td>
      </tr>
    `).join("");

    document.querySelectorAll(".massnahme-tn-row").forEach(row => {
      row.addEventListener("click", function () {
        const target = this.getAttribute("data-page");
        if (!target) return;

        let frame = null;
        try {
          if (window.parent && window.parent !== window) {
            frame = window.parent.document.getElementById("mainFrame");
          }
        } catch (e) {}

        if (frame) frame.src = target;
        else window.location.href = target;
      });
    });
  }

  function applyTeilnehmerFilter() {
    const q = (document.getElementById("tnFilterSearch")?.value || "").trim().toLowerCase();
    const betreuer = (document.getElementById("tnFilterBetreuer")?.value || "").trim();
    const arbeitsbereich = (document.getElementById("tnFilterArbeitsbereich")?.value || "").trim();
    const anleiter = (document.getElementById("tnFilterAnleiter")?.value || "").trim();

    const von = document.getElementById("tnFilterVon")?.value || "";
    const bis = document.getElementById("tnFilterBis")?.value || "";

    const showAktiv = document.getElementById("statusAktiv")?.checked;
    const showGeplant = document.getElementById("statusGeplant")?.checked;
    const showBeendet = document.getElementById("statusBeendet")?.checked;

    const statusSet = new Set();
    if (showAktiv) statusSet.add("aktiv");
    if (showGeplant) statusSet.add("geplant");
    if (showBeendet) statusSet.add("beendet");

    let list = demoTeilnehmerMassnahme.slice();

    list = list.filter(tn => statusSet.has(String(tn.status || "").toLowerCase()));

    if (q) {
      list = list.filter(tn =>
        (tn.name || "").toLowerCase().includes(q) ||
        (tn.kennung || "").toLowerCase().includes(q) ||
        (tn.kuerzel || "").toLowerCase().includes(q)
      );
    }

    if (betreuer) list = list.filter(tn => (tn.betreuer || "") === betreuer);
    if (arbeitsbereich) list = list.filter(tn => (tn.arbeitsbereich || "") === arbeitsbereich);
    if (anleiter) list = list.filter(tn => (tn.anleiter || "") === anleiter);

    if (von || bis) {
      list = list.filter(tn => withinRangeOverlap(tn.zuweisungVon, tn.zuweisungBis, von, bis));
    }

    renderTeilnehmerTable(list);
  }

  function resetTeilnehmerFilter() {
    document.getElementById("tnFilterSearch").value = "";
    document.getElementById("tnFilterBetreuer").value = "";
    document.getElementById("tnFilterArbeitsbereich").value = "";
    document.getElementById("tnFilterAnleiter").value = "";
    document.getElementById("tnFilterVon").value = "";
    document.getElementById("tnFilterBis").value = "";

    document.getElementById("statusAktiv").checked = true;
    document.getElementById("statusGeplant").checked = false;
    document.getElementById("statusBeendet").checked = false;

    applyTeilnehmerFilter();
  }
</script>

<script>
  // =========================
  // Anwesenheit
  // =========================
  function toggleDetails(button) {
    const row = button.closest("tr");
    const detailRow = row.nextElementSibling;
    document.querySelectorAll(".detail-row").forEach(r => {
      if (r !== detailRow) r.classList.add("d-none");
    });
    detailRow.classList.toggle("d-none");
  }

  function setAnwesend(button) {
    setActive(button, "bg-success");
    document.getElementById("anwesenheit-zeiten").classList.remove("d-none");
    document.getElementById("sonderoptionen").classList.add("d-none");
  }

  function setActive(button, colorClass) {
    const group = button.parentElement.querySelectorAll("button");
    group.forEach(btn => {
      btn.classList.remove("bg-success", "bg-warning", "bg-info", "bg-danger", "bg-primary", "text-white", "text-dark");
      btn.classList.add("btn-outline-secondary");
    });
    button.classList.remove("btn-outline-secondary");
    colorClass.split(" ").forEach(c => button.classList.add(c));
  }

  function setSpecial(button, type) {
    const sonder = document.getElementById("sonderoptionen");
    const au = document.getElementById("auBtn");
    const urlaub = document.getElementById("urlaubFeld");
    const grund = document.getElementById("grundFeld");
    const zeiten = document.getElementById("anwesenheit-zeiten");

    setActive(button,
      type === "krank"         ? "bg-warning text-dark" :
      type === "entschuldigt"  ? "bg-info text-white"   :
      type === "unentschuldigt"? "bg-danger text-white" :
                                  "bg-primary text-white"
    );

    sonder.classList.remove("d-none");
    zeiten.classList.add("d-none");

    au.style.display     = (type === "krank" || type === "entschuldigt") ? "inline-block" : "none";
    urlaub.style.display = (type === "urlaub") ? "inline-block" : "none";
    grund.style.display  = (type === "entschuldigt" || type === "unentschuldigt") ? "block" : "none";
  }
</script>

<script>
  // =========================
  // ESF Report + ESF Modal
  // =========================
  const demoEsfTeilnehmer = [
    {
      id: "esf-001", kuerzel: "MM", name: "Max Mustermann", kennung: "KV-555NXX",
      zuweisungVon: "2024-01-15", zuweisungBis: "2024-12-31",
      esf: true, esfVertragUnterschrieben: true,
      esfForm: {
        eintrittsdatum: "2024-01-15",
        drittstaat: "nein",
        gefluechtet: "nein",
        auslaendischeHerkunft: "ja",
        einverstaendnis: "Ja",
        sgbLeistung: "SGB II (Bürgergeld)",
        schulabschluss: "Realschulabschluss",
        berufsabschluss: "anerkannte Berufsausbildung",
        zielgruppe: "arbeitslos",
        wohnsitz: "Ja",
        austrittsgrund: "",
        zertifizierung: "",
        verbleib: ""
      }
    },
    {
      id: "esf-002", kuerzel: "CP", name: "Claudia Peters", kennung: "JC-555XCRT",
      zuweisungVon: "2024-03-01", zuweisungBis: "2025-03-01",
      esf: true, esfVertragUnterschrieben: true, /* KEIN VERTRAG */
      esfForm: {
        eintrittsdatum: "2024-03-01",
        drittstaat: "",
        gefluechtet: "",
        auslaendischeHerkunft: "",
        einverstaendnis: "",
        sgbLeistung: "",
        schulabschluss: "",
        berufsabschluss: "",
        zielgruppe: "",
        wohnsitz: "",
        austrittsgrund: "",
        zertifizierung: "",
        verbleib: ""
      }
    },
    {
      id: "esf-003", kuerzel: "LS", name: "Leonie Schmitt", kennung: "JC-2044",
      zuweisungVon: "2024-02-05", zuweisungBis: "2024-10-31",
      esf: true, esfVertragUnterschrieben: true,
      esfForm: { eintrittsdatum: "2024-02-05", drittstaat:"nein", gefluechtet:"nein", auslaendischeHerkunft:"nein", einverstaendnis:"Ja",
        sgbLeistung:"SGB II (Bürgergeld)", schulabschluss:"Fachhochschulreife/Abitur", berufsabschluss:"kein Berufsabschluss", zielgruppe:"langzeitarbeitslos", wohnsitz:"Ja",
        austrittsgrund:"regulär beendet", zertifizierung:"interne Teilnahmebescheinigung", verbleib:"Beschäftigung aufgenommen"
      }
    },
    {
      id: "esf-004", kuerzel: "HR", name: "Hasan Rahmani", kennung: "JC-3110",
      zuweisungVon: "2024-06-01", zuweisungBis: "2025-06-30",
      esf: true, esfVertragUnterschrieben: true,
      esfForm: { eintrittsdatum:"2024-06-01", drittstaat:"ja", gefluechtet:"nein", auslaendischeHerkunft:"ja", einverstaendnis:"Ja",
        sgbLeistung:"SGB II (Bürgergeld)", schulabschluss:"Haupt-/Mittelschulabschluss", berufsabschluss:"anerkannte Berufsausbildung", zielgruppe:"arbeitslos", wohnsitz:"Ja",
        austrittsgrund:"", zertifizierung:"", verbleib:""
      }
    },
    {
      id: "esf-005", kuerzel: "NK", name: "Nina Keller", kennung: "JC-4088",
      zuweisungVon: "2025-04-01", zuweisungBis: "2025-12-31",
      esf: true, esfVertragUnterschrieben: true,
      esfForm: { eintrittsdatum:"", drittstaat:"", gefluechtet:"", auslaendischeHerkunft:"", einverstaendnis:"", sgbLeistung:"", schulabschluss:"", berufsabschluss:"", zielgruppe:"", wohnsitz:"", austrittsgrund:"", zertifizierung:"", verbleib:"" }
    },
    {
      id: "esf-006", kuerzel: "FB", name: "Fatima Bouzid", kennung: "JC-5122",
      zuweisungVon: "2024-01-20", zuweisungBis: "2024-07-31",
      esf: true, esfVertragUnterschrieben: true,
      esfForm: { eintrittsdatum:"2024-01-20", drittstaat:"ja", gefluechtet:"ja", auslaendischeHerkunft:"ja", einverstaendnis:"Ja",
        sgbLeistung:"SGB II (Bürgergeld)", schulabschluss:"Haupt-/Mittelschulabschluss", berufsabschluss:"kein Berufsabschluss", zielgruppe:"langzeitarbeitslos", wohnsitz:"Nein",
        austrittsgrund:"", zertifizierung:"", verbleib:""
      }
    },
    {
      id: "esf-007", kuerzel: "TR", name: "Tim Richter", kennung: "JC-6001",
      zuweisungVon: "2024-09-01", zuweisungBis: "2025-02-28",
      esf: true, esfVertragUnterschrieben: true,
      esfForm: { eintrittsdatum:"2024-09-01", drittstaat:"nein", gefluechtet:"nein", auslaendischeHerkunft:"nein", einverstaendnis:"Nein",
        sgbLeistung:"SGB III (Arbeitslosengeld I)", schulabschluss:"Realschulabschluss", berufsabschluss:"anerkannte Berufsausbildung", zielgruppe:"arbeitslos", wohnsitz:"Ja",
        austrittsgrund:"", zertifizierung:"", verbleib:""
      }
    },
    {
      id: "esf-008", kuerzel: "JM", name: "Julia Mayer", kennung: "JC-7002",
      zuweisungVon: "2024-05-10", zuweisungBis: "2025-05-10",
      esf: true, esfVertragUnterschrieben: true,
      esfForm: { eintrittsdatum:"2024-05-10", drittstaat:"nein", gefluechtet:"nein", auslaendischeHerkunft:"nein", einverstaendnis:"Ja",
        sgbLeistung:"kein Leistungsbezug", schulabschluss:"Fachhochschulreife/Abitur", berufsabschluss:"akademischer Abschluss", zielgruppe:"erwerbstätig, von Armut bedroht", wohnsitz:"Ja",
        austrittsgrund:"", zertifizierung:"", verbleib:""
      }
    }
  ];

  let esfState = {
    filtered: [],
    activeId: null,
    modalSnapshot: null,
    modalEditing: false
  };

  function withinRange(dateISO, fromISO, toISO) {
    if (!dateISO) return false;
    const d = new Date(dateISO + "T00:00:00");
    const f = fromISO ? new Date(fromISO + "T00:00:00") : null;
    const t = toISO ? new Date(toISO + "T00:00:00") : null;
    if (f && d < f) return false;
    if (t && d > t) return false;
    return true;
  }

  // Vollständigkeit (anpassbar): Eintrittsdatum + Einverständnis
  function esfCompleteness(tn) {
    const f = tn.esfForm || {};
    const missing = [];
    if (!f.eintrittsdatum) missing.push("Eintrittsdatum");
    if (!f.einverstaendnis) missing.push("Einverständnis");
    return { ok: missing.length === 0, missing };
  }

  function renderEsfKpis(list) {
    const treffer = list.length;
    let ok = 0, open = 0;

    list.forEach(tn => {
      const c = esfCompleteness(tn);
      if (c.ok) ok++;
      else open++;
    });

    document.getElementById("esfKpiTreffer").textContent = treffer;
    document.getElementById("esfKpiOk").textContent = ok;
    document.getElementById("esfKpiOpen").textContent = open;
  }

  function statusBadgeEsf(tn) {
    const c = esfCompleteness(tn);
    if (c.ok) return `<span class="badge text-bg-success">vollständig</span>`;
    return `<span class="badge text-bg-warning text-dark">prüfen</span>`;
  }

  function esfContractIcon(tn) {
    if (tn.esfVertragUnterschrieben) {
      return `<span class="text-success" title="ESF-Vertrag unterschrieben" aria-label="ESF-Vertrag unterschrieben">
                <i class="bi bi-check-circle-fill"></i>
              </span>`;
    }
    return `<span class="text-secondary" title="ESF-Vertrag fehlt" aria-label="ESF-Vertrag fehlt">
              <i class="bi bi-dash-circle"></i>
            </span>`;
  }

  function renderEsfTable(list) {
    const tbody = document.getElementById("esfResultsBody");
    if (!tbody) return;

    if (list.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-secondary py-4">
            <i class="bi bi-inbox me-1"></i> Keine Treffer im gewählten Zeitraum.
          </td>
        </tr>`;
      return;
    }

    tbody.innerHTML = list.map(tn => `
      <tr>
        <td class="fw-semibold">
          <span class="badge text-bg-secondary me-2">${tn.kuerzel}</span>${tn.name}<br>
          <span class="text-secondary small">${tn.kennung}</span>
        </td>
        <td><div class="small">${fmtDateDE(tn.zuweisungVon)} – ${fmtDateDE(tn.zuweisungBis)}</div></td>
        <td class="text-center">${esfContractIcon(tn)}</td>
        <td>${statusBadgeEsf(tn)}</td>
        <td class="text-end">
          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="openEsfModal('${tn.id}')">
            <i class="bi bi-ui-checks-grid me-1"></i> ESF-Formular öffnen
          </button>
        </td>
      </tr>
    `).join("");
  }

  function applyEsfFilter() {
    const von = document.getElementById("esfFilterVon")?.value || "";
    const bis = document.getElementById("esfFilterBis")?.value || "";

    const filtered = demoEsfTeilnehmer
      .filter(tn => tn.esf === true)
      .filter(tn => withinRange(tn.zuweisungVon, von, bis) || withinRange(tn.zuweisungBis, von, bis));

    esfState.filtered = filtered;
    renderEsfKpis(filtered);
    renderEsfTable(filtered);
  }

  function setEsfModalEditing(isEditing) {
    esfState.modalEditing = isEditing;

    const selectIds = [
      "esfDrittstaat","esfGefluechtet","esfAuslaendischeHerkunft",
      "esfEinverstaendnis","esfSgbLeistung","esfSchulabschluss","esfBerufsabschluss",
      "esfZielgruppe","esfWohnsitz",
      "esfAustrittsgrund","esfZertifizierung","esfVerbleib"
    ];

    selectIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = !isEditing;
    });

    const eintritt = document.getElementById("esfEintrittsdatum");
    if (eintritt) eintritt.readOnly = true;

    document.getElementById("btnEsfModalEdit").classList.toggle("d-none", isEditing);
    document.getElementById("btnEsfModalCancel").classList.toggle("d-none", !isEditing);
    document.getElementById("btnEsfModalSave").classList.toggle("d-none", !isEditing);
  }

  function openEsfModal(id) {
    const tn = demoEsfTeilnehmer.find(x => x.id === id);
    if (!tn) return;

    esfState.activeId = id;
    esfState.modalEditing = false;

    document.getElementById("esfModalTitle").textContent = `${tn.name} (${tn.kennung})`;
    document.getElementById("esfName").value = tn.name || "";
    document.getElementById("esfKennung").value = tn.kennung || "";
    document.getElementById("esfZuweisungVon").value = tn.zuweisungVon || "";
    document.getElementById("esfZuweisungBis").value = tn.zuweisungBis || "";

    document.getElementById("esfToggle").checked = !!tn.esf;

    const icon = document.getElementById("esfVertragInfoIcon");
    const txt = document.getElementById("esfVertragInfoText");
    if (tn.esfVertragUnterschrieben) {
      icon?.classList.remove("d-none");
      if (txt) txt.textContent = "Vertrag: unterschrieben";
    } else {
      icon?.classList.add("d-none");
      if (txt) txt.textContent = "Vertrag: fehlt";
    }

    const f = tn.esfForm || {};
    document.getElementById("esfEintrittsdatum").value = f.eintrittsdatum || tn.zuweisungVon || "";
    document.getElementById("esfDrittstaat").value = f.drittstaat ?? "";
    document.getElementById("esfGefluechtet").value = f.gefluechtet ?? "";
    document.getElementById("esfAuslaendischeHerkunft").value = f.auslaendischeHerkunft ?? "";

    document.getElementById("esfEinverstaendnis").value = f.einverstaendnis ?? "";
    document.getElementById("esfSgbLeistung").value = f.sgbLeistung ?? "";
    document.getElementById("esfSchulabschluss").value = f.schulabschluss ?? "";
    document.getElementById("esfBerufsabschluss").value = f.berufsabschluss ?? "";
    document.getElementById("esfZielgruppe").value = f.zielgruppe ?? "";
    document.getElementById("esfWohnsitz").value = f.wohnsitz ?? "";

    document.getElementById("esfAustrittsgrund").value = f.austrittsgrund ?? "";
    document.getElementById("esfZertifizierung").value = f.zertifizierung ?? "";
    document.getElementById("esfVerbleib").value = f.verbleib ?? "";

    esfState.modalSnapshot = {
      eintrittsdatum: document.getElementById("esfEintrittsdatum").value,
      drittstaat: document.getElementById("esfDrittstaat").value,
      gefluechtet: document.getElementById("esfGefluechtet").value,
      auslaendischeHerkunft: document.getElementById("esfAuslaendischeHerkunft").value,
      einverstaendnis: document.getElementById("esfEinverstaendnis").value,
      sgbLeistung: document.getElementById("esfSgbLeistung").value,
      schulabschluss: document.getElementById("esfSchulabschluss").value,
      berufsabschluss: document.getElementById("esfBerufsabschluss").value,
      zielgruppe: document.getElementById("esfZielgruppe").value,
      wohnsitz: document.getElementById("esfWohnsitz").value,
      austrittsgrund: document.getElementById("esfAustrittsgrund").value,
      zertifizierung: document.getElementById("esfZertifizierung").value,
      verbleib: document.getElementById("esfVerbleib").value
    };

    const missing = [];
    if (!document.getElementById("esfEintrittsdatum").value) missing.push("Eintrittsdatum");
    if (!document.getElementById("esfEinverstaendnis").value) missing.push("Einverständnis");

    document.getElementById("esfModalWarn").classList.toggle("d-none", missing.length === 0);
    document.getElementById("esfModalStatusText").textContent =
      missing.length === 0 ? "Status: vollständig" : "Status: prüfen";

    setEsfModalEditing(false);
    bootstrap.Modal.getOrCreateInstance(document.getElementById("esfModal")).show();
  }

  function saveEsfModal() {
    const id = esfState.activeId;
    const tn = demoEsfTeilnehmer.find(x => x.id === id);
    if (!tn) return;

    if (!tn.esfVertragUnterschrieben) {
      showToast("Nicht möglich", "Ohne Unterschrift dürfen keine ESF Daten gespeichert werden.");
      return;
    }

    tn.esfForm = tn.esfForm || {};
    tn.esfForm.eintrittsdatum = document.getElementById("esfEintrittsdatum").value;
    tn.esfForm.drittstaat = document.getElementById("esfDrittstaat").value;
    tn.esfForm.gefluechtet = document.getElementById("esfGefluechtet").value;
    tn.esfForm.auslaendischeHerkunft = document.getElementById("esfAuslaendischeHerkunft").value;

    tn.esfForm.einverstaendnis = document.getElementById("esfEinverstaendnis").value;
    tn.esfForm.sgbLeistung = document.getElementById("esfSgbLeistung").value;
    tn.esfForm.schulabschluss = document.getElementById("esfSchulabschluss").value;
    tn.esfForm.berufsabschluss = document.getElementById("esfBerufsabschluss").value;
    tn.esfForm.zielgruppe = document.getElementById("esfZielgruppe").value;
    tn.esfForm.wohnsitz = document.getElementById("esfWohnsitz").value;

    tn.esfForm.austrittsgrund = document.getElementById("esfAustrittsgrund").value;
    tn.esfForm.zertifizierung = document.getElementById("esfZertifizierung").value;
    tn.esfForm.verbleib = document.getElementById("esfVerbleib").value;

    setEsfModalEditing(false);
    applyEsfFilter();

    const c = esfCompleteness(tn);
    document.getElementById("esfModalWarn").classList.toggle("d-none", c.ok);
    document.getElementById("esfModalStatusText").textContent =
      c.ok ? "Status: vollständig" : "Status: prüfen";

    showToast("Gespeichert", "ESF-Angaben wurden (demo) übernommen.");
  }

  function cancelEsfModal() {
    if (!esfState.modalSnapshot) return;

    document.getElementById("esfEintrittsdatum").value = esfState.modalSnapshot.eintrittsdatum;
    document.getElementById("esfDrittstaat").value = esfState.modalSnapshot.drittstaat;
    document.getElementById("esfGefluechtet").value = esfState.modalSnapshot.gefluechtet;
    document.getElementById("esfAuslaendischeHerkunft").value = esfState.modalSnapshot.auslaendischeHerkunft;

    document.getElementById("esfEinverstaendnis").value = esfState.modalSnapshot.einverstaendnis;
    document.getElementById("esfSgbLeistung").value = esfState.modalSnapshot.sgbLeistung;
    document.getElementById("esfSchulabschluss").value = esfState.modalSnapshot.schulabschluss;
    document.getElementById("esfBerufsabschluss").value = esfState.modalSnapshot.berufsabschluss;
    document.getElementById("esfZielgruppe").value = esfState.modalSnapshot.zielgruppe;
    document.getElementById("esfWohnsitz").value = esfState.modalSnapshot.wohnsitz;

    document.getElementById("esfAustrittsgrund").value = esfState.modalSnapshot.austrittsgrund;
    document.getElementById("esfZertifizierung").value = esfState.modalSnapshot.zertifizierung;
    document.getElementById("esfVerbleib").value = esfState.modalSnapshot.verbleib;

    setEsfModalEditing(false);
  }

  function batchCreateStammblaetter() {
    const list = esfState.filtered || [];
    const incomplete = list.filter(tn => !esfCompleteness(tn).ok);

    if (list.length === 0) {
      showToast("Keine Treffer", "Es gibt keine Teilnehmer für den aktuellen Filter.");
      return;
    }

    const ohneVertrag = list.filter(tn => !tn.esfVertragUnterschrieben);
    if (ohneVertrag.length > 0) {
      showToast("Nicht möglich", `${ohneVertrag.length} Teilnehmer haben keinen unterschriebenen ESF-Vertrag.`);
      return;
    }

    if (incomplete.length > 0) {
      showToast("Nicht möglich", `${incomplete.length} Teilnehmer sind unvollständig. Bitte zuerst prüfen.`);
      return;
    }

    showToast("Batch gestartet", `Erzeuge ${list.length} Stammblätter (Demo)…`);
  }

  function switchReportsScreen(showEsf) {
    const home = document.getElementById("reportsHome");
    const esf = document.getElementById("esfReportScreen");
    if (!home || !esf) return;

    home.classList.toggle("d-none", showEsf);
    esf.classList.toggle("d-none", !showEsf);

    if (showEsf) applyEsfFilter();
  }
</script>

<script>
  // =========================
  // Init
  // =========================
  document.addEventListener("DOMContentLoaded", () => {
    // Stammdaten
    renderMassnahmeStammdaten();
    initBlockEditors();

    // Teilnehmer: Standardmäßig nur aktiv
    resetTeilnehmerFilter();

    // Teilnehmer: Events
    document.getElementById("btnTnApply")?.addEventListener("click", applyTeilnehmerFilter);
    document.getElementById("btnTnReset")?.addEventListener("click", resetTeilnehmerFilter);
    document.getElementById("btnTnApply2")?.addEventListener("click", () => document.getElementById("btnTnApply")?.click());

    ["tnFilterSearch","tnFilterBetreuer","tnFilterArbeitsbereich","tnFilterAnleiter","tnFilterVon","tnFilterBis"].forEach(id => {
      document.getElementById(id)?.addEventListener("change", applyTeilnehmerFilter);
      if (id === "tnFilterSearch") {
        document.getElementById(id)?.addEventListener("keyup", applyTeilnehmerFilter);
      }
    });
    ["statusAktiv","statusGeplant","statusBeendet"].forEach(id => {
      document.getElementById(id)?.addEventListener("change", applyTeilnehmerFilter);
    });

    // Unterschriftenliste Modal
    document.getElementById("btnOpenUnterschriftenModal")?.addEventListener("click", () => {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      document.getElementById("uDatum").value = `${y}-${m}-${d}`;

      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById("unterschriftenModal"));
      modal.show();
    });

    document.getElementById("btnUDruckPdf")?.addEventListener("click", () => {
      const dt = document.getElementById("uDatum")?.value;
      if (!dt) { showToast("Fehlt", "Bitte Datum auswählen."); return; }
      showToast("Druck", `Unterschriftenliste (PDF) für ${fmtDateDE(dt)} (Demo).`);
      bootstrap.Modal.getOrCreateInstance(document.getElementById("unterschriftenModal")).hide();
    });

    document.getElementById("btnUDruckExcel")?.addEventListener("click", () => {
      const dt = document.getElementById("uDatum")?.value;
      if (!dt) { showToast("Fehlt", "Bitte Datum auswählen."); return; }
      showToast("Export", `Unterschriftenliste (Excel) für ${fmtDateDE(dt)} (Demo).`);
      bootstrap.Modal.getOrCreateInstance(document.getElementById("unterschriftenModal")).hide();
    });

    // ESF Screens
    document.getElementById("btnEsfMitAbrechnung")?.addEventListener("click", () => switchReportsScreen(true));
    document.getElementById("btnBackToReports")?.addEventListener("click", () => switchReportsScreen(false));
    document.getElementById("btnEsfApply")?.addEventListener("click", applyEsfFilter);
    document.getElementById("btnEsfReset")?.addEventListener("click", () => {
      document.getElementById("esfFilterVon").value = "2024-01-01";
      document.getElementById("esfFilterBis").value = "2025-12-31";
      applyEsfFilter();
    });
    document.getElementById("btnEsfBatchCreate")?.addEventListener("click", batchCreateStammblaetter);

    // ESF Modal Buttons
    document.getElementById("btnEsfModalCancel")?.addEventListener("click", cancelEsfModal);
    document.getElementById("btnEsfModalSave")?.addEventListener("click", saveEsfModal);

    document.getElementById("btnEsfModalEdit")?.addEventListener("click", () => {
      const ok = window.confirm("Sind Sie sicher, dass Sie die ESF-Daten ändern wollen?");
      if (!ok) return;
      setEsfModalEditing(true);
    });

    document.getElementById("btnEsfModalCreateStammblatt")?.addEventListener("click", () => {
      const tn = demoEsfTeilnehmer.find(x => x.id === esfState.activeId);
      if (!tn) return;

      if (!tn.esfVertragUnterschrieben) {
        showToast("Nicht möglich", "Ohne Unterschrift darf kein Stammblatt erzeugt werden.");
        return;
      }

      const c = esfCompleteness(tn);
      if (!c.ok) {
        showToast("Nicht möglich", "Bitte zuerst Pflichtangaben vervollständigen.");
        return;
      }

      showToast("Stammblatt", "Stammblatt erzeugen (Demo).");
    });
  });
</script>

</body>
</html>
