<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PHÖNIX – Parameter: Textbausteine</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="p-4 bg-light">

  <div class="container-fluid">

    <!-- Header Card -->
    <div class="card border-0 shadow mb-3">
      <div class="card-body p-4">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
          <div>
            <div class="text-secondary small">Parameter</div>
            <h1 class="h4 mb-2"><i class="bi bi-chat-square-text me-2"></i>Textbausteine</h1>

            <!-- aufklappbare Hilfe -->
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#helpTextbausteine">
              <i class="bi bi-info-circle me-1"></i> Hinweis
            </button>

            <div class="collapse mt-3" id="helpTextbausteine">
              <div class="alert alert-light border mb-0">
                Hier legen Sie wiederkehrende Formulierungen für <strong>Aktennotizen</strong> und <strong>Briefe</strong> an.
                Die Einträge werden unten in der Liste angezeigt (Demo: nur im Browser gespeichert).
              </div>
            </div>
          </div>

          <div class="text-end">

          </div>
        </div>
      </div>
    </div>

    <!-- Accordion -->
    <div class="accordion" id="textbausteineAccordion">

      <!-- AKTENNOTIZBAUSTEINE -->
      <div class="accordion-item border-0 shadow mb-3">
        <h2 class="accordion-header" id="headingAkten">
          <button
            class="accordion-button bg-white text-dark fw-semibold"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseAkten"
            aria-expanded="true"
            aria-controls="collapseAkten"
          >
            <i class="bi bi-journal-text me-2"></i> Aktennotizbausteine
          </button>
        </h2>

        <div id="collapseAkten" class="accordion-collapse collapse show" aria-labelledby="headingAkten" data-bs-parent="#textbausteineAccordion">
          <div class="accordion-body bg-white">

            <div class="text-secondary" style="font-size:.95rem;">
              Wiederkehrende Formulierungen für Aktennotizen anlegen und verwalten.
            </div>

            <hr class="my-3">

            <form id="formAkten" class="mb-3">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="aktenName" placeholder="Bausteinname" required />
                    <label for="aktenName">Bausteinname</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="aktenBetreff" placeholder="Betreff" required />
                    <label for="aktenBetreff">Betreff</label>
                  </div>
                </div>

                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="aktenInhalt" placeholder="Inhalt" style="height: 160px" required></textarea>
                    <label for="aktenInhalt">Inhalt</label>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-3">
                <button type="reset" class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-x-circle me-1"></i>Zurücksetzen
                </button>
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-save me-1"></i>Speichern
                </button>
              </div>
            </form>

            <hr class="my-3">

            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-semibold mb-0">Vorhandene Bausteine</h6>
              <button class="btn btn-sm btn-outline-secondary" type="button" id="btnClearAkten">
                <i class="bi bi-trash3 me-1"></i>Liste leeren
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Bausteinname</th>
                    <th>Betreff</th>
                    <th class="text-end">Aktion</th>
                  </tr>
                </thead>
                <tbody id="aktenList">
                  <tr class="text-muted small">
                    <td colspan="3">Noch keine Einträge.</td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

      <!-- BRIEFBAUSTEINE -->
      <div class="accordion-item border-0 shadow mb-3">
        <h2 class="accordion-header" id="headingBrief">
          <button
            class="accordion-button collapsed bg-white text-dark fw-semibold"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseBrief"
            aria-expanded="false"
            aria-controls="collapseBrief"
          >
            <i class="bi bi-envelope-paper me-2"></i> Briefbausteine
          </button>
        </h2>

        <div id="collapseBrief" class="accordion-collapse collapse" aria-labelledby="headingBrief" data-bs-parent="#textbausteineAccordion">
          <div class="accordion-body bg-white">

            <div class="text-secondary" style="font-size:.95rem;">
              Textbausteine für das Briefmodul (Anschreiben, Standardformulierungen, Grußformeln).
            </div>

            <hr class="my-3">

            <form id="formBrief" class="mb-3">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="briefName" placeholder="Bausteinname" required />
                    <label for="briefName">Bausteinname</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="briefBetreff" placeholder="Betreff" required />
                    <label for="briefBetreff">Betreff</label>
                  </div>
                </div>

                <div class="col-12">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="briefBetreffZusatz" placeholder="Betreffzusatz" />
                    <label for="briefBetreffZusatz">Betreffzusatz (optional)</label>
                  </div>
                </div>

                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="briefInhalt" placeholder="Bausteininhalt" style="height: 160px" required></textarea>
                    <label for="briefInhalt">Bausteininhalt</label>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-3">
                <button type="reset" class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-x-circle me-1"></i>Zurücksetzen
                </button>
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-save me-1"></i>Speichern
                </button>
              </div>
            </form>

            <hr class="my-3">

            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-semibold mb-0">Vorhandene Bausteine</h6>
              <button class="btn btn-sm btn-outline-secondary" type="button" id="btnClearBrief">
                <i class="bi bi-trash3 me-1"></i>Liste leeren
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Bausteinname</th>
                    <th>Betreff</th>
                    <th class="text-end">Aktion</th>
                  </tr>
                </thead>
                <tbody id="briefList">
                  <tr class="text-muted small">
                    <td colspan="3">Noch keine Einträge.</td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

    </div><!-- /accordion -->

  </div><!-- /container -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ====== Demo-Speicher (LocalStorage) ======
    const LS_KEYS = {
      akten: "phoenix_textbausteine_akten",
      brief: "phoenix_textbausteine_brief"
    };

    function safeParse(json, fallback) {
      try { return JSON.parse(json) ?? fallback; } catch { return fallback; }
    }
    function loadList(key) { return safeParse(localStorage.getItem(key), []); }
    function saveList(key, list) { localStorage.setItem(key, JSON.stringify(list)); }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ====== Rendering ======
    function renderAkten() {
      const tbody = document.getElementById("aktenList");
      const list = loadList(LS_KEYS.akten);

      if (!list.length) {
        tbody.innerHTML = `<tr class="text-muted small"><td colspan="3">Noch keine Einträge.</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map((item, idx) => `
        <tr>
          <td>${escapeHtml(item.name)}</td>
          <td>${escapeHtml(item.betreff)}</td>
          <td class="text-end">
            <button class="btn btn-outline-secondary btn-sm me-1" type="button" data-akten-edit="${idx}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" type="button" data-akten-del="${idx}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join("");
    }

    function renderBrief() {
      const tbody = document.getElementById("briefList");
      const list = loadList(LS_KEYS.brief);

      if (!list.length) {
        tbody.innerHTML = `<tr class="text-muted small"><td colspan="3">Noch keine Einträge.</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map((item, idx) => `
        <tr>
          <td>${escapeHtml(item.name)}</td>
          <td>${escapeHtml(item.betreff)}</td>
          <td class="text-end">
            <button class="btn btn-outline-secondary btn-sm me-1" type="button" data-brief-edit="${idx}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" type="button" data-brief-del="${idx}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join("");
    }

    // ====== CRUD ======
    function upsertAkten(payload, editIndex) {
      const list = loadList(LS_KEYS.akten);
      if (typeof editIndex === "number") list[editIndex] = payload;
      else list.unshift(payload);
      saveList(LS_KEYS.akten, list);
      renderAkten();
    }

    function deleteAkten(idx) {
      const list = loadList(LS_KEYS.akten);
      list.splice(idx, 1);
      saveList(LS_KEYS.akten, list);
      renderAkten();
    }

    function upsertBrief(payload, editIndex) {
      const list = loadList(LS_KEYS.brief);
      if (typeof editIndex === "number") list[editIndex] = payload;
      else list.unshift(payload);
      saveList(LS_KEYS.brief, list);
      renderBrief();
    }

    function deleteBrief(idx) {
      const list = loadList(LS_KEYS.brief);
      list.splice(idx, 1);
      saveList(LS_KEYS.brief, list);
      renderBrief();
    }

    // ====== Init + Events ======
    document.addEventListener("DOMContentLoaded", () => {
      renderAkten();
      renderBrief();

      const formAkten = document.getElementById("formAkten");
      const formBrief = document.getElementById("formBrief");

      // Akten Submit
      formAkten.addEventListener("submit", (e) => {
        e.preventDefault();

        const payload = {
          name: document.getElementById("aktenName").value.trim(),
          betreff: document.getElementById("aktenBetreff").value.trim(),
          inhalt: document.getElementById("aktenInhalt").value.trim(),
          updatedAt: new Date().toISOString()
        };

        if (!payload.name || !payload.betreff || !payload.inhalt) return;

        const editIndex = formAkten.dataset.editIndex ? Number(formAkten.dataset.editIndex) : null;
        upsertAkten(payload, Number.isFinite(editIndex) ? editIndex : undefined);

        formAkten.reset();
        delete formAkten.dataset.editIndex;
      });

      // Brief Submit
      formBrief.addEventListener("submit", (e) => {
        e.preventDefault();

        const payload = {
          name: document.getElementById("briefName").value.trim(),
          betreff: document.getElementById("briefBetreff").value.trim(),
          betreffZusatz: document.getElementById("briefBetreffZusatz").value.trim(),
          inhalt: document.getElementById("briefInhalt").value.trim(),
          updatedAt: new Date().toISOString()
        };

        if (!payload.name || !payload.betreff || !payload.inhalt) return;

        const editIndex = formBrief.dataset.editIndex ? Number(formBrief.dataset.editIndex) : null;
        upsertBrief(payload, Number.isFinite(editIndex) ? editIndex : undefined);

        formBrief.reset();
        delete formBrief.dataset.editIndex;
      });

      // Akten: Aktionen
      document.getElementById("aktenList").addEventListener("click", (e) => {
        const editBtn = e.target.closest("[data-akten-edit]");
        const delBtn = e.target.closest("[data-akten-del]");

        if (editBtn) {
          const idx = Number(editBtn.getAttribute("data-akten-edit"));
          const list = loadList(LS_KEYS.akten);
          const item = list[idx];
          if (!item) return;

          document.getElementById("aktenName").value = item.name ?? "";
          document.getElementById("aktenBetreff").value = item.betreff ?? "";
          document.getElementById("aktenInhalt").value = item.inhalt ?? "";
          formAkten.dataset.editIndex = String(idx);

          const aktenCollapse = document.getElementById("collapseAkten");
          bootstrap.Collapse.getOrCreateInstance(aktenCollapse, { toggle: false }).show();
          formAkten.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        if (delBtn) {
          const idx = Number(delBtn.getAttribute("data-akten-del"));
          if (confirm("Aktennotizbaustein wirklich löschen?")) deleteAkten(idx);
        }
      });

      // Brief: Aktionen
      document.getElementById("briefList").addEventListener("click", (e) => {
        const editBtn = e.target.closest("[data-brief-edit]");
        const delBtn = e.target.closest("[data-brief-del]");

        if (editBtn) {
          const idx = Number(editBtn.getAttribute("data-brief-edit"));
          const list = loadList(LS_KEYS.brief);
          const item = list[idx];
          if (!item) return;

          document.getElementById("briefName").value = item.name ?? "";
          document.getElementById("briefBetreff").value = item.betreff ?? "";
          document.getElementById("briefBetreffZusatz").value = item.betreffZusatz ?? "";
          document.getElementById("briefInhalt").value = item.inhalt ?? "";
          formBrief.dataset.editIndex = String(idx);

          const briefCollapse = document.getElementById("collapseBrief");
          bootstrap.Collapse.getOrCreateInstance(briefCollapse, { toggle: false }).show();
          formBrief.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        if (delBtn) {
          const idx = Number(delBtn.getAttribute("data-brief-del"));
          if (confirm("Briefbaustein wirklich löschen?")) deleteBrief(idx);
        }
      });

      // Listen leeren
      document.getElementById("btnClearAkten").addEventListener("click", () => {
        if (!confirm("Liste der Aktennotizbausteine wirklich leeren?")) return;
        saveList(LS_KEYS.akten, []);
        renderAkten();
      });

      document.getElementById("btnClearBrief").addEventListener("click", () => {
        if (!confirm("Liste der Briefbausteine wirklich leeren?")) return;
        saveList(LS_KEYS.brief, []);
        renderBrief();
      });
    });
  </script>

</body>
</html>
