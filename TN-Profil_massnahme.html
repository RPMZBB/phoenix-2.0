<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PHÖNIX Prototyp</title>

  <!-- Bootstrap & Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bs-stepper/dist/css/bs-stepper.min.css" rel="stylesheet" />
  <link href="css/custom.css" rel="stylesheet" />
</head>

<body class="bg-light p-4 p-lg-5">

  <!-- HEADER CARD -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body py-3 px-4">

      <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3 flex-grow-1">
          <div>
            <div class="d-flex align-items-center gap-2">
              <h2 class="fw-normal mb-0">Max Mustermann – Maßnahmebezogene Daten</h2>

              <button
                class="btn btn-sm p-0 text-muted"
                data-bs-toggle="collapse"
                data-bs-target="#hilfeMassnahme"
                aria-expanded="false"
                aria-controls="hilfeMassnahme"
                type="button"
              >
                <i class="bi bi-info-circle"></i>
              </button>
            </div>

            <div class="d-flex flex-wrap gap-4 mt-1 small text-muted">
              <div>
                <span class="text-secondary">TN-ID:</span>
                <span class="fw-semibold text-dark ms-1">12345</span>
              </div>
              <div>
                <span class="text-secondary">Kennung:</span>
                <span class="fw-semibold text-dark ms-1">555XV5974</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="collapse mt-3" id="hilfeMassnahme">
        <div class="bg-body-tertiary rounded p-3 text-muted small">
          In dieser Ansicht bearbeiten und verwalten Sie ausschließlich
          <strong>maßnahmebezogene Informationen</strong> von
          <strong>Max Mustermann</strong>.
          <br><br>
          Allgemeine Stammdaten (z.&nbsp;B. Adresse, Kontaktdaten,
          persönliche Angaben) können nur über den Bereich
          <strong>„Teilnehmer“</strong> angepasst werden.
        </div>
      </div>

    </div>
  </div>

  <!-- MAIN CARD -->
  <div class="card">
    <div class="card-body">
      <div class="row">

        <!-- LEFT SIDEBAR -->
        <div class="col-lg-3 border-end mb-4 mb-lg-0">

          <div class="d-flex justify-content-between align-items-start mb-2 small text-muted">
            <div>
              <div>TN-ID: <strong>12345</strong></div>
              <div>Kennung: <strong>555XV5974</strong></div>
            </div>
            <span class="badge rounded-pill bg-success">aktiv</span>
          </div>

          <div class="text-center mt-2 mb-3">
            <div
              class="avatar-initials bg-secondary text-white mx-auto mb-2 d-flex align-items-center justify-content-center rounded-circle border border-4 border-success"
              style="
                width: 90px;
                height: 90px;
                font-size: 36px;
                box-shadow:
                  0 0 0 3px rgba(25,135,84,.35),
                  0 0 14px rgba(25,135,84,.55);
              "
            >
              MM
            </div>
            <h4 class="mb-0">Max Mustermann</h4>
          </div>

          <div class="bg-body-secondary rounded-3 p-3 mb-3">
            <div class="text-center mb-3">
              <div class="text-muted small mb-1">Zugewiesene Maßnahme</div>
              <div class="h5 mb-1 text-primary fw-bold">Integra 2025</div>
              <div class="small text-muted">01.01.2024 – 31.12.2024</div>
            </div>

            <div class="row text-center small g-2">
              <div class="col-4">
                <div class="text-muted">Betreuer</div>
                <div class="fw-semibold">D. Chu</div>
              </div>
              <div class="col-4">
                <div class="text-muted">Bereich</div>
                <div class="fw-semibold">Maler</div>
              </div>
              <div class="col-4">
                <div class="text-muted">JC</div>
                <div class="fw-semibold">F. Beispiel</div>
              </div>
            </div>
          </div>

          <div class="list-group small" id="sektionenNav" role="tablist">

            <a
              href="TN-Profil_grunddaten.html"
              class="list-group-item list-group-item-action d-flex align-items-center gap-2 text-success fw-semibold"
            >
              <i class="bi bi-pencil-square"></i>
              Grunddaten bearbeiten
            </a>

            <button
              class="list-group-item list-group-item-action active"
              id="sektionDok-tab"
              data-bs-toggle="tab"
              data-bs-target="#sektionDok"
              type="button"
              role="tab"
              aria-controls="sektionDok"
              aria-selected="true"
            >
              <i class="bi bi-file-text me-1"></i> Dokumentation
            </button>

            <button
              class="list-group-item list-group-item-action"
              id="sektionVerlauf-tab"
              data-bs-toggle="tab"
              data-bs-target="#sektionVerlauf"
              type="button"
              role="tab"
              aria-controls="sektionVerlauf"
              aria-selected="false"
            >
              <i class="bi bi-graph-up me-1"></i> Verlauf &amp; Bewertung
            </button>

            <button
              class="list-group-item list-group-item-action"
              id="sektionOrga-tab"
              data-bs-toggle="tab"
              data-bs-target="#sektionOrga"
              type="button"
              role="tab"
              aria-controls="sektionOrga"
              aria-selected="false"
            >
              <i class="bi bi-briefcase me-1"></i> Organisation
            </button>

            <button
              class="list-group-item list-group-item-action text-danger"
              id="sektionEnde-tab"
              data-bs-toggle="tab"
              data-bs-target="#sektionEnde"
              type="button"
              role="tab"
              aria-controls="sektionEnde"
              aria-selected="false"
            >
              <i class="bi bi-door-closed me-1"></i> Teilnahme beenden
            </button>

          </div>
        </div>

        <!-- RIGHT CONTENT -->
        <div class="col-lg-9">
          <div class="tab-content">

            <!-- SEKTION: DOKUMENTATION -->
            <div class="tab-pane fade show active" id="sektionDok" role="tabpanel" aria-labelledby="sektionDok-tab">

              <ul class="nav nav-pills mb-3" id="dokTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active"
                          id="dokInterventionen-tab"
                          data-bs-toggle="tab"
                          data-bs-target="#dokInterventionen"
                          type="button" role="tab"
                          aria-controls="dokInterventionen"
                          aria-selected="true">
                    Interventionen
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link"
                          id="dokBriefe-tab"
                          data-bs-toggle="tab"
                          data-bs-target="#dokBriefe"
                          type="button" role="tab"
                          aria-controls="dokBriefe"
                          aria-selected="false">
                    Briefe
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link"
                          id="dokAktennotizen-tab"
                          data-bs-toggle="tab"
                          data-bs-target="#dokAktennotizen"
                          type="button" role="tab"
                          aria-controls="dokAktennotizen"
                          aria-selected="false">
                    Aktennotizen
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link"
                          id="dokNotizen-tab"
                          data-bs-toggle="tab"
                          data-bs-target="#dokNotizen"
                          type="button" role="tab"
                          aria-controls="dokNotizen"
                          aria-selected="false">
                    Notizen
                  </button>
                </li>
                  <li class="nav-item" role="presentation">
                  <button class="nav-link"
                          id="dokFahrkosten-tab"
                          data-bs-toggle="tab"
                          data-bs-target="#dokFahrkosten"
                          type="button" role="tab"
                          aria-controls="dokFahrkosten"
                          aria-selected="false">
                    Fahrtkosten
                  </button>
                </li>
              </ul>

              <div class="tab-content">
                <!-- DOK: INTERVENTIONEN -->
                <div class="tab-pane fade show active" id="dokInterventionen" role="tabpanel" aria-labelledby="dokInterventionen-tab">

                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h5 class="mb-0">Interventionen</h5>
                      <small class="text-muted">Übersicht aller Interventionen zum Teilnehmer während dieser Maßnahme</small>
                    </div>

                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-primary btn-sm"
                              data-bs-toggle="modal"
                              data-bs-target="#interventionCreateModal"
                              type="button">
                        <i class="bi bi-plus-lg me-1"></i> Neue Intervention
                      </button>

                      <button class="btn btn-outline-primary btn-sm" type="button" id="btnInterventionExport">
                        <i class="bi bi-journal-text me-1"></i> Export
                      </button>
                    </div>
                  </div>

                  <div class="row g-3 mb-3">
                    <div class="col-6 col-lg-3">
                      <div class="border rounded-3 p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                          <span class="text-muted small">Gesamt</span>
                          <i class="bi bi-collection"></i>
                        </div>
                        <div class="fs-4 fw-semibold" id="interventionCountTotal">0</div>
                      </div>
                    </div>

                    <div class="col-6 col-lg-3">
                      <div class="border rounded-3 p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                          <span class="text-muted small">Offen</span>
                          <i class="bi bi-exclamation-circle"></i>
                        </div>
                        <div class="fs-4 fw-semibold" id="interventionCountOpen">0</div>
                      </div>
                    </div>

                    <div class="col-6 col-lg-3">
                      <div class="border rounded-3 p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                          <span class="text-muted small">Mit Meldefrist</span>
                          <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="fs-4 fw-semibold" id="interventionCountDeadline">0</div>
                      </div>
                    </div>

                    <div class="col-6 col-lg-3">
                      <div class="border rounded-3 p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                          <span class="text-muted small">Hausbesuche</span>
                          <i class="bi bi-house-door"></i>
                        </div>
                        <div class="fs-4 fw-semibold" id="interventionCountVisits">0</div>
                      </div>
                    </div>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 10%">Datum</th>
                          <th style="width: 14%">Erstellt von</th>
                          <th style="width: 14%">Art</th>
                          <th style="width: 24%">Details</th>
                          <th style="width: 14%">Meldefrist</th>
                          <th style="width: 10%">Status</th>
                          <th style="width: 14%">Ergebnis</th>
                          <th style="width: 10%" class="text-end">Aktionen</th>
                        </tr>
                      </thead>
                      <tbody id="interventionTableBody"></tbody>
                    </table>
                  </div>

                </div>

                <!-- DOK: BRIEFE -->
                <div class="tab-pane fade" id="dokBriefe" role="tabpanel" aria-labelledby="dokBriefe-tab">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h5 class="mb-0">Briefe</h5>
                      <small class="text-muted">Erzeugte Schreiben &amp; Vorlagen</small>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" type="button">
                      <i class="bi bi-plus-lg me-1"></i> Neuen Brief erzeugen
                    </button>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Datum</th>
                          <th>Vorlage</th>
                          <th>Status</th>
                          <th class="text-end">Aktionen</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>01.12.2025</td>
                          <td>Einladung Erstgespräch</td>
                          <td><span class="badge bg-success-subtle text-success-emphasis">gedruckt</span></td>
                          <td class="text-end">
                            <button class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-pencil-square"></i></button>
                          </td>
                        </tr>
                        <tr>
                          <td>15.11.2025</td>
                          <td>Erinnerung Meldetermin</td>
                          <td><span class="badge bg-secondary-subtle text-secondary-emphasis">Entwurf</span></td>
                          <td class="text-end">
                            <button class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-pencil"></i></button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- DOK: AKTENNOTIZEN -->
                <div class="tab-pane fade" id="dokAktennotizen" role="tabpanel" aria-labelledby="dokAktennotizen-tab">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h5 class="mb-0">Aktennotizen</h5>
                      <small class="text-muted">Formale Notizen zum Vorgang</small>
                    </div>

                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-primary btn-sm"
                              type="button"
                              data-bs-toggle="modal"
                              data-bs-target="#modalAktennotiz">
                        <i class="bi bi-plus-lg me-1"></i> Neue Aktennotiz
                      </button>

                      <button class="btn btn-outline-primary btn-sm" type="button" id="btnAktenExport">
                        <i class="bi bi-journal-text me-1"></i> Export
                      </button>
                    </div>
                  </div>

                  <div class="list-group small" id="aktennotizenList"></div>
                </div>

                <!-- DOK: NOTIZEN -->
                <div class="tab-pane fade" id="dokNotizen" role="tabpanel" aria-labelledby="dokNotizen-tab">
                  <h5>Freie Notizen</h5>
                  <p class="text-muted small">
                    Hier können schnelle, informelle Notizen zur Person erfasst werden.
                  </p>

                  <div class="mb-3">
                    <label class="form-label">Neue Notiz</label>
                    <textarea class="form-control" rows="3" placeholder="Kurznotiz eingeben …"></textarea>
                  </div>
                  <button class="btn btn-primary btn-sm mb-3" type="button">
                    <i class="bi bi-plus-lg me-1"></i> Notiz speichern
                  </button>

                  <hr>

                  <h6>Letzte Notizen</h6>
                  <ul class="list-unstyled small">
                    <li class="mb-2">
                      <strong>09.12.2025</strong>: Teilnehmer wirkte heute motiviert im Praxisbereich.
                    </li>
                    <li class="mb-2">
                      <strong>07.12.2025</strong>: Meldung von Verspätungen – Ursache: ÖPNV-Störung.
                    </li>
                  </ul>
                </div>

<!-- DOK: FAHRTKOSTEN -->
<div class="tab-pane fade" id="dokFahrkosten" role="tabpanel" aria-labelledby="dokFahrkosten-tab">

  <!-- Kopfzeile -->
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
    <div>
      <h5 class="mb-0">Fahrkosten</h5>
      <small class="text-muted">Erfassung & Übersicht der Fahrtkosteneinträge des Teilnehmers</small>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm"
              type="button"
              id="btnFahrkostenNew"
              data-bs-toggle="modal"
              data-bs-target="#fahrkostenModal">
        <i class="bi bi-plus-lg me-1"></i> Neuer Eintrag
      </button>

      <button class="btn btn-outline-primary btn-sm" type="button" id="btnFahrkostenExport">
        <i class="bi bi-journal-text me-1"></i> Export
      </button>
    </div>
  </div>

  <!-- Summary -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-lg-3">
      <div class="border rounded-3 p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small">Summe (aktiv)</span>
          <i class="bi bi-cash-coin"></i>
        </div>
        <div class="fs-4 fw-semibold" id="fahrkostenSumAktiv">0,00 €</div>
        <div class="small text-muted" id="fahrkostenSumHint">—</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="border rounded-3 p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small">Einträge</span>
          <i class="bi bi-list-check"></i>
        </div>
        <div class="fs-4 fw-semibold" id="fahrkostenCount">0</div>
        <div class="small text-muted" id="fahrkostenCountHint">—</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="border rounded-3 p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small">Storniert</span>
          <i class="bi bi-x-circle"></i>
        </div>
        <div class="fs-4 fw-semibold" id="fahrkostenCountStorno">0</div>
        <div class="small text-muted" id="fahrkostenStornoHint">—</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="border rounded-3 p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small">Aktiver Monat</span>
          <i class="bi bi-calendar-month"></i>
        </div>
        <div class="fs-4 fw-semibold" id="fahrkostenActiveMonth">—</div>
        <div class="small text-muted">über Filter einstellbar</div>
      </div>
    </div>
  </div>

  <!-- Filter Accordion (weiß wie der Rest) -->
  <div class="accordion mb-3" id="fahrkostenFilterAccordion">
    <div class="accordion-item border rounded-3 bg-white">
      <h2 class="accordion-header" id="fahrkostenFilterHeading">
        <button class="accordion-button collapsed py-2 bg-white"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#fahrkostenFilterCollapse"
                aria-expanded="false"
                aria-controls="fahrkostenFilterCollapse">
          <i class="bi bi-funnel me-2"></i> Filter
          <span class="ms-2 small text-muted" id="fahrkostenFilterSummary">—</span>
        </button>
      </h2>
      <div id="fahrkostenFilterCollapse"
           class="accordion-collapse collapse"
           aria-labelledby="fahrkostenFilterHeading"
           data-bs-parent="#fahrkostenFilterAccordion">
        <div class="accordion-body bg-white">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1" for="fahrkostenFilterMonat">Monat</label>
              <input type="month" class="form-control form-control-sm" id="fahrkostenFilterMonat">
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1" for="fahrkostenFilterArt">Art</label>
              <select class="form-select form-select-sm" id="fahrkostenFilterArt">
                <option value="">Alle</option>
                <option>Monatskarte</option>
                <option>Wochenkarte</option>
                <option>Einzelkarte</option>
                <option>Tageskarte</option>
                <option>PKW</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1" for="fahrkostenFilterStorno">Storno</label>
              <select class="form-select form-select-sm" id="fahrkostenFilterStorno">
                <option value="">Alle</option>
                <option value="Nein">Nur aktiv</option>
                <option value="Ja">Nur storniert</option>
              </select>
            </div>
            <div class="col-12 col-md-3 d-flex gap-2 justify-content-md-end">
              <button class="btn btn-outline-secondary btn-sm" type="button" id="btnFahrkostenResetFilter">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabelle -->
  <div class="border rounded-3 p-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h6 class="mb-0">Einträge</h6>
        <small class="text-muted">Aktionen: Formular, Bearbeiten, Löschen</small>
      </div>
      <div class="small text-muted" id="fahrkostenLiveInfo">—</div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 12%">Monat</th>
            <th style="width: 12%">Ausstellung</th>
            <th style="width: 16%">Zeitraum</th>
            <th style="width: 12%">Art</th>
            <th style="width: 10%">Storno</th>
            <th style="width: 16%">Details</th>
            <th style="width: 10%" class="text-end">Betrag</th>
            <th style="width: 12%" class="text-end">Aktionen</th>
          </tr>
        </thead>
        <tbody id="fahrkostenTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- =========================
       MODAL: Fahrtkosten Create/Edit
       (nur Floating Labels)
       ========================= -->
  <div class="modal fade" id="fahrkostenModal" tabindex="-1" aria-labelledby="fahrkostenModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <form id="fahrkostenForm">
          <div class="modal-header">
            <h5 class="modal-title" id="fahrkostenModalLabel">Fahrtkosten – Neuer Eintrag</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="fahrkostenId">

            <div class="row g-3">

              <!-- Monatsbezug + Info -->
              <div class="col-12 col-md-6">
                <div class="form-floating">
                  <input type="month" class="form-control" id="FahrtkostenBetrifftMonat" placeholder="Monatsbezug" required>
                  <label for="FahrtkostenBetrifftMonat">FahrtkostenBetrifftMonat</label>
                </div>
              </div>

              <!-- Ausstellung -->
              <div class="col-12 col-md-6">
                <div class="form-floating">
                  <input type="date" class="form-control" id="FahrtkostenAusstellungsdatum" placeholder="Ausstellung" required>
                  <label for="FahrtkostenAusstellungsdatum">FahrtkostenAusstellungsdatum</label>
                </div>
              </div>

              <!-- Art -->
              <div class="col-12 col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="FahrtkostenArt" required>
                    <option value="" selected disabled>Bitte wählen …</option>
                    <option>Monatskarte</option>
                    <option>Wochenkarte</option>
                    <option>Einzelkarte</option>
                    <option>Tageskarte</option>
                    <option>PKW</option>
                  </select>
                  <label for="FahrtkostenArt">FahrtkostenArt</label>
                </div>
              </div>

              <!-- Betrag + Info -->
              <div class="col-12 col-md-6">

                <div class="form-floating">
                  <input type="number" step="0.01" min="0" class="form-control" id="FahrtkostenBetrag" placeholder="Betrag" required>
                  <label for="FahrtkostenBetrag">FahrtkostenBetrag (€)</label>
                </div>
              </div>

              <!-- Preisstufe: Monatskarte + Wochenkarte -->
              <div class="col-12 col-md-6" id="wrapPreisstufe" style="display:none;">
                <div class="form-floating">
                  <select class="form-select" id="FahrtkostenPreisstufe">
                    <option value="" selected disabled>Bitte wählen …</option>
                    <option value="1">Preisstufe 1</option>
                    <option value="2">Preisstufe 2</option>
                    <option value="3">Preisstufe 3</option>
                  </select>
                  <label for="FahrtkostenPreisstufe">Preisstufe</label>
                </div>
              </div>

              <!-- Kartenanzahl -->
              <div class="col-12 col-md-6" id="wrapKartenanzahl">
                <div class="form-floating">
                  <input type="number" min="0" class="form-control" id="FahrtkostenKartenanzahl" placeholder="Kartenanzahl" value="1">
                  <label for="FahrtkostenKartenanzahl">FahrtkostenKartenanzahl</label>
                </div>
              </div>

              <!-- Zeitraum (unter Art & Betrag, 2 Felder) -->
              <div class="col-12">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <div class="form-floating">
                      <input type="date" class="form-control" id="FahrtkostenZeitraumVon" placeholder="Von" required>
                      <label for="FahrtkostenZeitraumVon">Zeitraum von</label>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="form-floating">
                      <input type="date" class="form-control" id="FahrtkostenZeitraumBis" placeholder="Bis" required>
                      <label for="FahrtkostenZeitraumBis">Zeitraum bis</label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Storno -->
              <div class="col-12">
                <div class="form-floating">
                  <select class="form-select" id="FahrtkostenStorno" required>
                    <option>Nein</option>
                    <option>Ja</option>
                  </select>
                  <label for="FahrtkostenStorno">FahrtkostenStorno</label>
                </div>
              </div>

              <!-- PKW-Details -->
              <div class="col-12" id="wrapPKW" style="display:none;">
                <div class="border rounded-3 p-3 bg-light">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="fw-semibold"><i class="bi bi-car-front me-1"></i>PKW-Details</div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="small text-muted">KM berechnen</span>
                      <button type="button"
                              class="btn btn-link p-0 text-muted"
                              data-bs-toggle="tooltip"
                              data-bs-placement="top"
                              title="KM bitte im Falk Routenplaner berechnen.">
                        <i class="bi bi-info-circle"></i>
                      </button>
                      <a href="#" class="small" id="linkFalkMock">Falk Routenplaner</a>
                    </div>
                  </div>

                  <div class="row g-3">
                    <div class="col-12 col-md-6">
                      <div class="form-floating">
                        <input type="text" class="form-control" id="FahrtkostenWegpunktA" placeholder="Wegpunkt A">
                        <label for="FahrtkostenWegpunktA">Wegpunkt A</label>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="form-floating">
                        <input type="text" class="form-control" id="FahrtkostenWegpunktB" placeholder="Wegpunkt B">
                        <label for="FahrtkostenWegpunktB">Wegpunkt B</label>
                      </div>
                    </div>

                    <div class="col-12 col-md-4">
                      <div class="form-floating">
                        <input type="number" step="0.1" min="0" class="form-control" id="FahrtkostenEFKM" placeholder="KM">
                        <label for="FahrtkostenEFKM">Entfernung KM</label>
                      </div>
                    </div>

                    <div class="col-12 col-md-4">
                      <div class="form-floating">
                        <input type="number" min="0" class="form-control" id="FahrtkostenAnzahlPKWTage" placeholder="Tage">
                        <label for="FahrtkostenAnzahlPKWTage">Anzahl PKW-Tage</label>
                      </div>
                    </div>

                    <div class="col-12 col-md-4">
                      <div class="form-floating">
                        <input type="number" step="0.01" min="0" class="form-control" id="FahrtkostenKmPauschale" placeholder="0,40">
                        <label for="FahrtkostenKmPauschale">km Pauschale (€/km)</label>
                      </div>
                    </div>

                    <div class="col-12">
                      <div class="small text-muted">
                        Berechnung: <strong>KM × Tage × Satz (km Pauschale)</strong>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

            </div><!-- /row -->
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-danger me-auto" id="btnFahrkostenDelete" style="display:none;">
              <i class="bi bi-trash me-1"></i> Löschen
            </button>

            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>

            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check2 me-1"></i> Speichern
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- =========================
       MODAL: Formular-Ausgabe
       (kleines Popup, nur Floating)
       ========================= -->
  <div class="modal fade" id="fahrkostenFormularModal" tabindex="-1" aria-labelledby="fahrkostenFormularModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <form id="fahrkostenFormularForm">
          <div class="modal-header">
            <h5 class="modal-title" id="fahrkostenFormularModalLabel">Formular</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="fahrkostenFormularRowId">

            <div class="border rounded-3 p-2 mb-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkBeleg" checked>
                <label class="form-check-label" for="chkBeleg">Fahrtgeldbeleg</label>
              </div>
            </div>

            <div class="border rounded-3 p-2 mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkEmpfang" checked>
                <label class="form-check-label" for="chkEmpfang">Empfangsbestätigung Fahrkartenausgabe</label>
              </div>
            </div>

            <div class="form-floating" style="display:none;">
              <select class="form-select" id="fahrkostenFormularTyp" required>
                <option value="beleg" selected>Fahrtgeldbeleg</option>
                <option value="empfang">Empfangsbestätigung Fahrkartenausgabe</option>
              </select>
              <label for="fahrkostenFormularTyp">Auswahl</label>
            </div>

            <div class="small text-muted mt-2">
              Ausgewählte Formulare werden erzeugt.
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Schließen</button>
            <button type="submit" class="btn btn-primary btn-sm">
              <i class="bi bi-filetype-pdf me-1"></i> Ausgabe als PDF
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div><!-- /dokFahrkosten -->

                
              </div>
            </div>

            <!-- SEKTION: VERLAUF & BEWERTUNG -->
            <div class="tab-pane fade" id="sektionVerlauf" role="tabpanel" aria-labelledby="sektionVerlauf-tab">
              <h5 class="mb-3">Verlauf &amp; Bewertung</h5>

              <!-- Anwesenheit Card -->
              <div class="mb-3">
                <div class="border rounded-3 p-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Anwesenheit</h6>
                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#anwesenheitModal" type="button">
                      <i class="bi bi-calendar3 me-1"></i> Detailansicht
                    </button>
                  </div>
                  <p class="text-muted small mb-2">
                    Übersicht zu Anwesenheit/Fehlzeiten während dieser Maßnahme.
                  </p>
                  <div class="small">
                    <span class="badge bg-success-subtle text-success-emphasis me-1">56 % Anwesenheitsquote</span>
                    <span class="badge bg-warning-subtle text-warning-emphasis">2 Fehltage</span>
                  </div>
                </div>
              </div>

              <!-- Modal: Anwesenheit Detailansicht -->
              <div class="modal fade" id="anwesenheitModal" tabindex="-1" aria-labelledby="anwesenheitModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="anwesenheitModalLabel">Anwesenheit – Detailansicht</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                      <div class="row g-3 mb-4">
                        <div class="col-md-4">
                          <div class="border rounded-3 p-4 h-100 d-flex flex-column justify-content-center text-center">
                            <div class="display-4 fw-semibold">56&nbsp;%</div>
                            <div class="text-muted text-uppercase small mt-2">Anwesenheitsquote</div>
                          </div>
                        </div>

                        <div class="col-md-8">
                          <div class="row g-3">
                            <div class="col-6">
                              <div class="border rounded-3 p-3 text-center h-100">
                                <div class="small text-muted">Fehltage</div>
                                <div class="fs-4 fw-semibold">2</div>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="border rounded-3 p-3 text-center h-100">
                                <div class="small text-muted">Quote AU</div>
                                <div class="fs-4 fw-semibold">90&nbsp;%</div>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="border rounded-3 p-3 text-center h-100">
                                <div class="small text-muted">Urlaub</div>
                                <div class="fs-4 fw-semibold">30</div>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="border rounded-3 p-3 text-center h-100">
                                <div class="small text-muted">Quote F</div>
                                <div class="fs-4 fw-semibold">10&nbsp;%</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                          <select class="form-select form-select-sm" style="width:auto;">
                            <option selected>2025</option>
                            <option>2024</option>
                            <option>2023</option>
                          </select>

                          <select class="form-select form-select-sm" style="width:auto;">
                            <option>Januar</option>
                            <option>Februar</option>
                            <option>März</option>
                            <option>April</option>
                            <option>Mai</option>
                            <option>Juni</option>
                            <option>Juli</option>
                            <option>August</option>
                            <option>September</option>
                            <option>Oktober</option>
                            <option>November</option>
                            <option selected>Dezember</option>
                          </select>

                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-primary">Monat</button>
                            <button type="button" class="btn btn-outline-primary">Jahr</button>
                          </div>
                        </div>

                        <button class="btn btn-outline-secondary btn-sm" type="button">
                          Anwesenheit exportieren
                        </button>
                      </div>

                      <div class="border rounded-3">
                        <table class="table table-bordered mb-0 align-middle text-center small">
                          <thead class="table-light">
                            <tr>
                              <th scope="col">Mon</th>
                              <th scope="col">Tue</th>
                              <th scope="col">Wed</th>
                              <th scope="col">Thu</th>
                              <th scope="col">Fri</th>
                              <th scope="col">Sat</th>
                              <th scope="col">Sun</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td class="text-muted">26</td>
                              <td class="text-muted">27</td>
                              <td class="text-muted">28</td>
                              <td class="text-muted">29</td>
                              <td class="text-muted">30</td>
                              <td>1</td>
                              <td>2</td>
                            </tr>
                            <tr>
                              <td><span class="badge bg-success-subtle text-success-emphasis px-3">3</span></td>
                              <td><span class="badge bg-success-subtle text-success-emphasis px-3">4</span></td>
                              <td><span class="badge bg-danger-subtle text-danger-emphasis px-3">5</span></td>
                              <td><span class="badge bg-danger-subtle text-danger-emphasis px-3">6</span></td>
                              <td><span class="badge bg-warning-subtle text-warning-emphasis px-3">7</span></td>
                              <td>8</td>
                              <td>9</td>
                            </tr>
                            <tr>
                              <td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td>
                            </tr>
                            <tr>
                              <td>17</td><td>18</td><td>19</td><td>20</td>
                              <td>21<br><span class="badge bg-primary-subtle text-primary-emphasis mt-1">•</span></td>
                              <td>22</td><td>23</td>
                            </tr>
                            <tr>
                              <td>24</td><td>25</td><td>26</td><td>27</td><td>28</td><td>29</td>
                              <td><span class="badge bg-primary-subtle text-primary-emphasis px-3">30</span></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                    </div>

                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Schließen</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- (Deine weiteren Blöcke kannst du hier behalten, UI bleibt) -->
              <div class="mb-3">
                <div class="border rounded-3 p-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Zielvereinbarung</h6>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm" type="button">
                        <i class="bi bi-calendar-check me-1"></i> Detailansicht
                      </button>
                      <button class="btn btn-primary btn-sm" type="button">
                        <i class="bi bi-plus-lg me-1"></i> erstellen
                      </button>
                    </div>
                  </div>
                  <p class="text-muted small mb-2">Vereinbarte Ziele und Fortschritt des Teilnehmers.</p>
                  <div class="small">
                    <strong>Letzte Zielvereinbarung:</strong>
                    <span class="text-muted">12. November 2025</span>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <div class="border rounded-3 p-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Förderplan</h6>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm" type="button">
                        <i class="bi bi-calendar-check me-1"></i> Detailansicht
                      </button>
                      <button class="btn btn-primary btn-sm" type="button">
                        <i class="bi bi-plus-lg me-1"></i> erstellen
                      </button>
                    </div>
                  </div>
                  <p class="text-muted small mb-2">Vereinbarter Förderplan des Teilnehmers.</p>
                  <div class="small">
                    <strong>Letzter Förderplan:</strong>
                    <span class="text-muted">12. November 2025</span>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <div class="border rounded-3 p-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Leistungs- &amp; Verhaltensbeurteilung</h6>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm" type="button">
                        <i class="bi bi-pencil me-1"></i> Bearbeiten
                      </button>
                      <button class="btn btn-primary btn-sm" type="button">
                        <i class="bi bi-plus-lg me-1"></i> erstellen
                      </button>
                    </div>
                  </div>
                  <p class="text-muted small mb-2">
                    Einschätzungen zum Arbeitsverhalten, Sozialverhalten und Lernfortschritt. Erstellte LUVs:
                  </p>
                  <div class="small d-flex flex-wrap gap-2">
                    <span class="badge bg-primary-subtle text-primary-emphasis">Start LUV 12.09.2025</span>
                    <span class="badge bg-primary-subtle text-primary-emphasis">Verlaufs LUV 31.11.2025</span>
                  </div>
                </div>
              </div>

              <div>
                <div class="border rounded-3 p-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Anleiterbewertung</h6>
                    <button class="btn btn-outline-secondary btn-sm" type="button">
                      <i class="bi bi-clipboard-check me-1"></i> Bewertungen ansehen
                    </button>
                  </div>
                  <p class="text-muted small mb-2">Bewertung durch Praxisanleiter / Ausbilder im Einsatzbetrieb.</p>
                </div>
              </div>

            </div>

            <!-- SEKTION: ORGANISATION -->
            <div class="tab-pane fade" id="sektionOrga" role="tabpanel" aria-labelledby="sektionOrga-tab">
              <h5 class="mb-3">Organisation</h5>

              <div class="mb-3">
                <div class="border rounded-3 p-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Gruppen</h6>
                    <button class="btn btn-outline-secondary btn-sm" type="button">
                      <i class="bi bi-people me-1"></i> Gruppen bearbeiten
                    </button>
                  </div>
                  <p class="text-muted small mb-1">Zuweisung zu Trainingsgruppen, Kleingruppen oder Projektteams.</p>
                  <div class="small">Aktuelle Gruppe: <strong>Werkstatt Maler – Vormittagsgruppe</strong></div>
                </div>
              </div>

              <div class="mb-3">
                <div class="border rounded-3 p-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Praktika</h6>
                    <button class="btn btn-outline-secondary btn-sm" type="button">
                      <i class="bi bi-briefcase me-1"></i> Praktikum planen
                    </button>
                  </div>
                  <p class="text-muted small mb-1">Übersicht geplanter und vergangener Praktikumsphasen.</p>
                  <div class="small">Aktuelles Praktikum: <strong>Malerbetrieb Farbenfroh</strong> (01.02. – 31.03.2025)</div>
                </div>
              </div>



              <div class="mb-3">
                <div class="border rounded-3 p-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Persönliche Arbeitszeit des TN</h6>
                    <button class="btn btn-outline-secondary btn-sm" type="button">
                      <i class="bi bi-clock me-1"></i> Zeiten bearbeiten
                    </button>
                  </div>
                  <p class="text-muted small mb-1">Hinterlegte individuelle Arbeits- bzw. Anwesenheitszeiten.</p>
                </div>
              </div>

            </div>

            <!-- SEKTION: TEILNAHME BEENDEN -->
            <div class="tab-pane fade" id="sektionEnde" role="tabpanel" aria-labelledby="sektionEnde-tab">
              <div class="border rounded-3 p-3">
                <h5>Teilnahme beenden</h5>
                <p class="text-muted small mb-3">
                  Hier wird die Maßnahme für diesen Teilnehmer offiziell beendet.
                  Bitte Gründe und Datum dokumentieren. Die Beendigung kann an
                  Kostenträger und interne Stellen gemeldet werden.
                </p>

                <div class="mb-3">
                  <label class="form-label">Beendigungsdatum</label>
                  <input type="date" class="form-control">
                </div>

                <div class="mb-3">
                  <label class="form-label">Beendigungsgrund</label>
                  <select class="form-select">
                    <option>Bitte wählen …</option>
                    <option>Maßnahme erfolgreich abgeschlossen</option>
                    <option>Eigenkündigung Teilnehmer</option>
                    <option>Abbruch durch Träger</option>
                    <option>Abbruch durch Kostenträger</option>
                    <option>Nichtantritt / wiederholte Nichtteilnahme</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Bemerkungen (intern)</label>
                  <textarea class="form-control" rows="3"
                            placeholder="Optionale Zusatzinfos, z.B. Vereinbarungen, offene Punkte …"></textarea>
                </div>

                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="teilnahmeEndeInfoJC">
                  <label class="form-check-label small" for="teilnahmeEndeInfoJC">
                    Kostenträger (z.&nbsp;B. Jobcenter) automatisch informieren
                  </label>
                </div>

                <button class="btn btn-danger" type="button">
                  <i class="bi bi-door-closed me-1"></i> Teilnahme jetzt beenden
                </button>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ===================== MODAL: NEUE INTERVENTION (Floating Labels) ===================== -->
  <div class="modal fade" id="interventionCreateModal" tabindex="-1" aria-labelledby="interventionCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">

        <form id="interventionForm">
          <div class="modal-header">
            <h5 class="modal-title" id="interventionCreateModalLabel">Neue Intervention erstellen</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
          </div>

          <div class="modal-body">

            <div class="form-floating mb-2">
              <select class="form-select" id="interventionType" required>
                <option value="" selected disabled>Bitte auswählen …</option>
                <option value="Anschreiben">Anschreiben</option>
                <option value="Meldetermin">Meldetermin</option>
                <option value="Hausbesuch">Hausbesuch</option>
                <option value="1. Ermahnung">1. Ermahnung</option>
                <option value="2. Ermahnung">2. Ermahnung</option>
                <option value="Beendigung">Beendigung</option>
              </select>
              <label for="interventionType">Interventionsart</label>
            </div>
            <div class="form-text mb-3">
              Je nach Auswahl werden die passenden Felder eingeblendet.
            </div>

            <div class="row g-3">

              <div class="col-md-6" data-intervention-group="Anschreiben,Meldetermin,Hausbesuch,1. Ermahnung,2. Ermahnung,Beendigung">
                <div class="form-floating">
                  <input type="date" class="form-control" id="interventionDate" placeholder=" ">
                  <label for="interventionDate">Datum</label>
                </div>
              </div>

              <div class="col-md-6" data-intervention-group="Anschreiben,Meldetermin,1. Ermahnung,2. Ermahnung">
                <div class="form-floating">
                  <input type="date" class="form-control" id="interventionDeadline" placeholder=" ">
                  <label for="interventionDeadline">Meldefrist</label>
                </div>
                <div class="form-text">Wird bei Bedarf der Watchlist hinzugefügt.</div>
              </div>

              <div class="col-md-6" data-intervention-group="Hausbesuch">
                <div class="form-floating">
                  <input type="text" class="form-control" id="interventionEmployee1" placeholder=" ">
                  <label for="interventionEmployee1">Mitarbeiter 1</label>
                </div>
              </div>

              <div class="col-md-6" data-intervention-group="Hausbesuch">
                <div class="form-floating">
                  <input type="text" class="form-control" id="interventionEmployee2" placeholder=" ">
                  <label for="interventionEmployee2">Mitarbeiter 2 (optional)</label>
                </div>
              </div>

              <div class="col-12" data-intervention-group="Hausbesuch">
                <div class="border rounded-3 p-3">
                  <div class="fw-semibold mb-2">Ergebnis Hausbesuch</div>

                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="visitResult" id="visitMet" value="Angetroffen">
                    <label class="form-check-label" for="visitMet">Angetroffen</label>
                  </div>

                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="visitResult" id="visitNotMet" value="Nicht angetroffen">
                    <label class="form-check-label" for="visitNotMet">Nicht angetroffen</label>
                  </div>
                </div>
                <div class="form-text">Hinweis: Ergebnis kann später im Bearbeiten-Modal gesetzt werden.</div>
              </div>

              <div class="col-12" data-intervention-group="1. Ermahnung">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="interventionClarification">
                  <label class="form-check-label" for="interventionClarification">Klärungsbedarf vorhanden</label>
                </div>
              </div>

              <div class="col-12" data-intervention-group="Beendigung">
                <div class="form-floating">
                  <input type="text" class="form-control" id="interventionEndNote" placeholder=" ">
                  <label for="interventionEndNote">Beendigungsgrund / Bemerkung</label>
                </div>
              </div>

              <div class="col-12" data-intervention-group="Anschreiben,Meldetermin,Hausbesuch,1. Ermahnung,2. Ermahnung,Beendigung">
                <div class="form-floating">
                  <textarea class="form-control" id="interventionNote" placeholder=" " style="height: 90px"></textarea>
                  <label for="interventionNote">Notiz (intern)</label>
                </div>
              </div>

            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg me-1"></i> Intervention speichern
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- ===================== MODAL: INTERVENTION BEARBEITEN (Floating Labels) ===================== -->
  <div class="modal fade" id="interventionEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Intervention bearbeiten</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>

        <form id="interventionEditForm">
          <div class="modal-body">

            <input type="hidden" id="editInterventionId" value="">

            <div class="border rounded-3 p-3 bg-light mb-4">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label mb-1">Interventionsart</label>
                  <div class="form-control" id="editType">–</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label mb-1">Erstellt von</label>
                  <div class="form-control" id="editCreatedBy">–</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label mb-1">Datum</label>
                  <div class="form-control" id="editDate">–</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label mb-1">Meldefrist</label>
                  <div class="form-control" id="editDeadline">–</div>
                </div>

                <div class="col-12">
                  <label class="form-label mb-1">Details</label>
                  <div class="form-control" id="editDetails" style="min-height: 76px; white-space: pre-wrap;">–</div>
                </div>
              </div>
            </div>

            <div class="row g-3">

              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="editStatus" required>
                    <option value="Offen">Offen</option>
                    <option value="Erledigt">Erledigt</option>
                    <option value="Abgebrochen">Abgebrochen</option>
                  </select>
                  <label for="editStatus">Status</label>
                </div>
                <div class="form-text">Status wird in der Tabelle als Badge angezeigt.</div>
              </div>

              <div class="col-md-6" id="editResultTextWrap">
                <div class="form-floating">
                  <input type="text" class="form-control" id="editResult" placeholder=" ">
                  <label for="editResult">Ergebnis</label>
                </div>
                <div class="form-text">z.B. Teilnehmer erschienen / Nicht angetroffen …</div>
              </div>

              <div class="col-md-6 d-none" id="editVisitWrap">
                <div class="border rounded-3 p-3 h-100">
                  <div class="fw-semibold mb-2">Ergebnis Hausbesuch</div>

                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="editVisitResult" id="editVisitMet" value="Angetroffen">
                    <label class="form-check-label" for="editVisitMet">Angetroffen</label>
                  </div>

                  <div class="form-check mt-1">
                    <input class="form-check-input" type="radio" name="editVisitResult" id="editVisitNotMet" value="Nicht angetroffen">
                    <label class="form-check-label" for="editVisitNotMet">Nicht angetroffen</label>
                  </div>
                </div>
                <div class="form-text">Hausbesuch-Ergebnis wird über Radios gesetzt.</div>
              </div>

            </div>

          </div>

          <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-outline-danger" id="btnInterventionDelete">
              <i class="bi bi-trash me-1"></i> Löschen
            </button>

            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Schließen</button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i> Speichern
              </button>
            </div>
          </div>

        </form>

      </div>
    </div>
  </div>

  <!-- ===================== MODAL: AKTENNOTIZ (Floating Labels) ===================== -->
  <div class="modal fade" id="modalAktennotiz" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="aktenModalTitle">
            <i class="bi bi-journal-plus me-2"></i> Aktennotiz
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>

        <form id="aktennotizForm">
          <div class="modal-body">
            <input type="hidden" id="aktenEditIndex" value="">

            <div class="row g-3">
              <div class="col-md-7">
                <div class="form-floating">
                  <input type="text" class="form-control" id="aktenTitel" placeholder=" " required>
                  <label for="aktenTitel">Titel</label>
                </div>
              </div>

              <div class="col-md-5">
                <div class="form-floating">
                  <input type="date" class="form-control" id="aktenDatum" placeholder=" " required>
                  <label for="aktenDatum">Datum</label>
                </div>
              </div>

              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="aktenText" placeholder=" " style="height: 140px" required></textarea>
                  <label for="aktenText">Inhalt</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="aktenAutor" placeholder=" " value="D. Chu">
                  <label for="aktenAutor">Angelegt von</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="aktenTyp" aria-label="Typ">
                    <option value="Aktennotiz" selected>Aktennotiz</option>
                    <option value="Telefonat">Telefonat</option>
                    <option value="Gespräch">Gespräch</option>
                    <option value="E-Mail">E-Mail</option>
                  </select>
                  <label for="aktenTyp">Typ</label>
                </div>
              </div>
            </div>

          </div>

          <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-danger d-none" id="btnAktenDelete">
                <i class="bi bi-trash me-1"></i> Löschen
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i> Speichern
              </button>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===================== INTERVENTIONEN (voll funktionsfähig) =====================
    document.addEventListener("DOMContentLoaded", () => {

      // Demo-Store
      let interventions = [
        { id:"demo-1", type:"Anschreiben", date:"2025-12-10", createdBy:"D. Chu", details:"Einladung zum Meldetermin", deadline:"2025-12-17", status:"Offen", result:"" },
        { id:"demo-2", type:"Hausbesuch", date:"2025-12-05", createdBy:"Meier", details:"Mitarbeiter: Meier / Schulz – angetroffen", deadline:"", status:"Erledigt", result:"Angetroffen" },
        { id:"demo-3", type:"1. Ermahnung", date:"2025-12-02", createdBy:"D. Chu", details:"Klärungsbedarf: ja", deadline:"2025-12-09", status:"Offen", result:"Klärungsbedarf" }
      ];

      const tableBody = document.getElementById("interventionTableBody");
      const countTotal    = document.getElementById("interventionCountTotal");
      const countOpen     = document.getElementById("interventionCountOpen");
      const countDeadline = document.getElementById("interventionCountDeadline");
      const countVisits   = document.getElementById("interventionCountVisits");
      const btnExport     = document.getElementById("btnInterventionExport");

      // Create
      const createModalEl = document.getElementById("interventionCreateModal");
      const createForm    = document.getElementById("interventionForm");
      const typeSelect    = document.getElementById("interventionType");
      const fieldGroups   = document.querySelectorAll("[data-intervention-group]");

      // Edit
      const editModalEl   = document.getElementById("interventionEditModal");
      const editForm      = document.getElementById("interventionEditForm");
      const editIdEl      = document.getElementById("editInterventionId");
      const editTypeEl    = document.getElementById("editType");
      const editByEl      = document.getElementById("editCreatedBy");
      const editDateEl    = document.getElementById("editDate");
      const editDeadEl    = document.getElementById("editDeadline");
      const editDetEl     = document.getElementById("editDetails");
      const editStatusEl  = document.getElementById("editStatus");
      const editResEl     = document.getElementById("editResult");
      const editResultTextWrap = document.getElementById("editResultTextWrap");
      const editVisitWrap = document.getElementById("editVisitWrap");
      const btnDelete     = document.getElementById("btnInterventionDelete");
      const editVisitMet  = document.getElementById("editVisitMet");
      const editVisitNotMet = document.getElementById("editVisitNotMet");

      function formatDateDE(iso) {
        if (!iso) return "–";
        const [y,m,d] = iso.split("-");
        if (!y || !m || !d) return iso;
        return `${d}.${m}.${y}`;
      }

      function statusBadge(status) {
        if (status === "Erledigt") return `<span class="badge bg-success-subtle text-success-emphasis">Erledigt</span>`;
        if (status === "Abgebrochen") return `<span class="badge bg-danger-subtle text-danger-emphasis">Abgebrochen</span>`;
        return `<span class="badge bg-warning-subtle text-warning-emphasis">Offen</span>`;
      }

      function typeBadge(type) {
        const map = {
          "Anschreiben": "bg-primary",
          "Meldetermin": "bg-info text-dark",
          "Hausbesuch": "bg-warning text-dark",
          "1. Ermahnung": "bg-danger",
          "2. Ermahnung": "bg-danger-subtle text-danger-emphasis",
          "Beendigung": "bg-dark"
        };
        const cls = map[type] || "bg-secondary";
        return `<span class="badge ${cls}">${type}</span>`;
      }

      function updateStats() {
        const total = interventions.length;
        const open = interventions.filter(x => (x.status || "Offen") === "Offen").length;
        const withDeadline = interventions.filter(x => !!x.deadline).length;
        const visits = interventions.filter(x => x.type === "Hausbesuch").length;

        if (countTotal) countTotal.textContent = String(total);
        if (countOpen) countOpen.textContent = String(open);
        if (countDeadline) countDeadline.textContent = String(withDeadline);
        if (countVisits) countVisits.textContent = String(visits);
      }

      function renderTable() {
        if (!tableBody) return;

        const sorted = [...interventions].sort((a,b) => (b.date||"").localeCompare(a.date||""));

        tableBody.innerHTML = sorted.map(item => `
          <tr data-id="${item.id}">
            <td>${formatDateDE(item.date)}</td>
            <td>${item.createdBy || "–"}</td>
            <td>${typeBadge(item.type)}</td>
            <td>${item.details || "–"}</td>
            <td>${item.deadline ? formatDateDE(item.deadline) : "–"}</td>
            <td>${statusBadge(item.status)}</td>
            <td>${item.result && item.result.trim() ? item.result : "–"}</td>
            <td class="text-end">
              <button type="button"
                      class="btn btn-outline-secondary btn-sm js-edit-intervention"
                      data-id="${item.id}"
                      data-bs-toggle="modal"
                      data-bs-target="#interventionEditModal">
                <i class="bi bi-pencil-square"></i>
              </button>
            </td>
          </tr>
        `).join("");

        updateStats();
      }

      function updateFieldVisibility() {
        if (!typeSelect) return;
        const type = typeSelect.value;
        fieldGroups.forEach(group => {
          const types = group.getAttribute("data-intervention-group").split(",").map(t => t.trim());
          group.classList.toggle("d-none", !types.includes(type));
        });
      }

      function getCreateVisitResult() {
        return document.querySelector('input[name="visitResult"]:checked')?.value || "";
      }

      function buildDetailsFromCreateForm(type, visitResult) {
        const employee1     = document.getElementById("interventionEmployee1")?.value || "";
        const employee2     = document.getElementById("interventionEmployee2")?.value || "";
        const clarification = document.getElementById("interventionClarification")?.checked || false;
        const endNote       = document.getElementById("interventionEndNote")?.value || "";
        const note          = document.getElementById("interventionNote")?.value || "";

        if (type === "Hausbesuch") {
          const employeesText = [employee1, employee2].filter(Boolean).join(" / ") || "Mitarbeiter nicht hinterlegt";
          return `Mitarbeiter: ${employeesText} – ${visitResult || "Ergebnis offen"}`;
        }
        if (type === "1. Ermahnung") {
          return `Klärungsbedarf: ${clarification ? "ja" : "nein"}`;
        }
        if (type === "Beendigung") {
          return endNote ? `Grund: ${endNote}` : "Beendigung ohne nähere Angabe";
        }
        return note || "Keine Zusatznotiz";
      }

      // Create init
      if (typeSelect) {
        typeSelect.addEventListener("change", updateFieldVisibility);
        updateFieldVisibility();
      }
      if (createModalEl) {
        createModalEl.addEventListener("show.bs.modal", () => {
          updateFieldVisibility();
        });
      }

      // Create submit
      if (createForm) {
        createForm.addEventListener("submit", (e) => {
          e.preventDefault();

          const type = typeSelect.value;
          if (!type) return;

          const dateValue = document.getElementById("interventionDate")?.value || "";
          if (!dateValue) {
            alert("Bitte Datum auswählen.");
            return;
          }

          const deadlineValue = document.getElementById("interventionDeadline")?.value || "";
          const createdBy = "D. Chu"; // Demo: später aus Login/Session

          let status = "Offen";
          let result = "";
          let visitResult = "";

          // Hausbesuch: darf Ergebnis direkt gesetzt werden (optional) – Status bleibt zunächst Offen
          if (type === "Hausbesuch") {
            visitResult = getCreateVisitResult();
            if (visitResult) result = visitResult;
          }

          const detailsText = buildDetailsFromCreateForm(type, visitResult);

          const obj = {
            id: "i-" + Date.now(),
            type,
            date: dateValue,
            createdBy,
            details: detailsText,
            deadline: (type === "Hausbesuch") ? "" : deadlineValue,
            status,
            result
          };

          interventions.push(obj);
          renderTable();

          if ((type === "Anschreiben" || type === "Meldetermin") && !!deadlineValue) {
            const addToWatchlist = window.confirm("Möchten Sie die Meldefrist in die Watchlist eintragen?");
            if (addToWatchlist) window.alert("Meldefrist wurde (Demo) zur Watchlist hinzugefügt.");
          }

          bootstrap.Modal.getInstance(createModalEl)?.hide();
          createForm.reset();
          updateFieldVisibility();
        });
      }

      // Edit open
      document.addEventListener("click", (e) => {
        const btn = e.target.closest(".js-edit-intervention");
        if (!btn) return;

        const id = btn.getAttribute("data-id");
        const item = interventions.find(x => x.id === id);
        if (!item) return;

        editIdEl.value = item.id;

        editTypeEl.innerHTML = typeBadge(item.type);
        editByEl.textContent = item.createdBy || "–";
        editDateEl.textContent = item.date ? formatDateDE(item.date) : "–";
        editDeadEl.textContent = item.deadline ? formatDateDE(item.deadline) : "–";
        editDetEl.textContent = item.details || "–";

        // Default UI
        editResultTextWrap.classList.remove("d-none");
        editVisitWrap.classList.add("d-none");
        editStatusEl.disabled = false;

        editStatusEl.value = item.status || "Offen";
        editResEl.value = item.result || "";

        // Hausbesuch: Radios einblenden
        if (item.type === "Hausbesuch") {
          editResultTextWrap.classList.add("d-none");
          editVisitWrap.classList.remove("d-none");

          // status bleibt normal editierbar (du kannst das fixieren, falls du willst)
          editVisitMet.checked = (item.result === "Angetroffen");
          editVisitNotMet.checked = (item.result === "Nicht angetroffen");
        }
      });

      function getEditVisitResult() {
        return document.querySelector('input[name="editVisitResult"]:checked')?.value || "";
      }

      // Edit submit
      if (editForm) {
        editForm.addEventListener("submit", (e) => {
          e.preventDefault();

          const id = editIdEl.value;
          const item = interventions.find(x => x.id === id);
          if (!item) return;

          item.status = editStatusEl.value;

          if (item.type === "Hausbesuch") {
            const vr = getEditVisitResult();
            item.result = vr || "";
            // Details ggf. mitziehen
            if (vr) {
              if (typeof item.details === "string" && item.details.includes("–")) {
                item.details = item.details.split("–")[0].trim() + " – " + vr;
              }
            }
          } else {
            item.result = (editResEl.value || "").trim();
          }

          renderTable();
          bootstrap.Modal.getInstance(editModalEl)?.hide();
        });
      }

      // Delete
      if (btnDelete) {
        btnDelete.addEventListener("click", () => {
          const id = editIdEl.value;
          if (!id) return;

          const ok = window.confirm("Intervention wirklich löschen?");
          if (!ok) return;

          interventions = interventions.filter(x => x.id !== id);
          renderTable();
          bootstrap.Modal.getInstance(editModalEl)?.hide();
        });
      }

      // Export JSON
      if (btnExport) {
        btnExport.addEventListener("click", () => {
          const blob = new Blob([JSON.stringify(interventions, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "interventionen.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }

      renderTable();
    });

    // ===================== AKTENNOTIZEN (voll funktionsfähig) =====================
    (function () {
      const STORAGE_KEY = "aktennotizen_demo";

      const listEl = document.getElementById("aktennotizenList");
      const modalEl = document.getElementById("modalAktennotiz");

      const form = document.getElementById("aktennotizForm");
      const editIndexEl = document.getElementById("aktenEditIndex");
      const titleEl = document.getElementById("aktenTitel");
      const dateEl = document.getElementById("aktenDatum");
      const textEl = document.getElementById("aktenText");
      const authorEl = document.getElementById("aktenAutor");
      const typeEl = document.getElementById("aktenTyp");

      const modalTitleEl = document.getElementById("aktenModalTitle");
      const btnDelete = document.getElementById("btnAktenDelete");
      const btnExport = document.getElementById("btnAktenExport");

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function load() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
        catch { return []; }
      }
      function save(arr) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      }

      function formatDateDE(iso) {
        if (!iso) return "";
        const [y,m,d] = iso.split("-");
        if (!y || !m || !d) return iso;
        return `${d}.${m}.${y}`;
      }

      function render() {
        const data = load();
        if (!listEl) return;

        if (data.length === 0) {
          listEl.innerHTML = `
            <div class="border rounded bg-white p-3 text-muted small">
              Noch keine Aktennotizen vorhanden.
            </div>`;
          return;
        }

        const sorted = data
          .map((x, i) => ({...x, _i: i}))
          .sort((a,b) => (b.datum || "").localeCompare(a.datum || ""));

        listEl.innerHTML = sorted.map(item => `
          <a href="#" class="list-group-item list-group-item-action" data-edit="${item._i}">
            <div class="d-flex w-100 justify-content-between align-items-start gap-3">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2">
                  <h6 class="mb-1">${esc(item.titel)}</h6>
                  <span class="badge text-bg-light border">${esc(item.typ || "Aktennotiz")}</span>
                </div>
                <p class="mb-1">${esc(item.text)}</p>
                <small class="text-muted">angelegt von: ${esc(item.autor || "-")}</small>
              </div>
              <small class="text-muted flex-shrink-0">${esc(formatDateDE(item.datum))}</small>
            </div>
          </a>
        `).join("");

        listEl.querySelectorAll("[data-edit]").forEach(a => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            const idx = Number(a.getAttribute("data-edit"));
            openEdit(idx);
          });
        });
      }

      function resetModalForNew() {
        if (!modalTitleEl) return;
        modalTitleEl.innerHTML = `<i class="bi bi-journal-plus me-2"></i> Neue Aktennotiz`;
        editIndexEl.value = "";
        btnDelete.classList.add("d-none");

        form.reset();

        const today = new Date();
        const yyyy = String(today.getFullYear());
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        dateEl.value = `${yyyy}-${mm}-${dd}`;

        if (!authorEl.value) authorEl.value = "D. Chu";
        typeEl.value = "Aktennotiz";
      }

      function openEdit(idx) {
        const data = load();
        const item = data[idx];
        if (!item) return;

        modalTitleEl.innerHTML = `<i class="bi bi-pencil-square me-2"></i> Aktennotiz bearbeiten`;
        editIndexEl.value = String(idx);
        btnDelete.classList.remove("d-none");

        titleEl.value = item.titel || "";
        dateEl.value = item.datum || "";
        textEl.value = item.text || "";
        authorEl.value = item.autor || "";
        typeEl.value = item.typ || "Aktennotiz";

        bootstrap.Modal.getOrCreateInstance(modalEl).show();
      }

      if (modalEl) {
        modalEl.addEventListener("show.bs.modal", () => {
          if (!editIndexEl.value) resetModalForNew();
        });

        modalEl.addEventListener("hidden.bs.modal", () => {
          editIndexEl.value = "";
          btnDelete.classList.add("d-none");
        });
      }

      if (form) {
        form.addEventListener("submit", (e) => {
          e.preventDefault();

          const obj = {
            titel: titleEl.value.trim(),
            datum: dateEl.value,
            text: textEl.value.trim(),
            autor: authorEl.value.trim(),
            typ: typeEl.value
          };

          if (!obj.titel || !obj.datum || !obj.text) return;

          const data = load();
          const idx = editIndexEl.value === "" ? -1 : Number(editIndexEl.value);

          if (idx >= 0 && data[idx]) data[idx] = obj;
          else data.push(obj);

          save(data);
          render();
          bootstrap.Modal.getOrCreateInstance(modalEl).hide();
        });
      }

      if (btnDelete) {
        btnDelete.addEventListener("click", () => {
          const idx = editIndexEl.value === "" ? -1 : Number(editIndexEl.value);
          if (idx < 0) return;

          const data = load();
          data.splice(idx, 1);
          save(data);
          render();
          bootstrap.Modal.getOrCreateInstance(modalEl).hide();
        });
      }

      if (btnExport) {
        btnExport.addEventListener("click", () => {
          const data = load();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "aktennotizen.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }

      // Demo seed
      const existing = load();
      if (existing.length === 0) {
        save([
          { titel: "Telefonat mit JC", datum: "2025-11-10", text: "Rückmeldung zur Anwesenheit und Leistungsstand besprochen.", autor: "D. Chu", typ: "Telefonat" },
          { titel: "Gespräch mit Teilnehmer", datum: "2025-11-03", text: "Motivation und Ziele im weiteren Verlauf dokumentiert.", autor: "D. Chu", typ: "Gespräch" }
        ]);
      }

      render();
    })();
  </script>

<script>
  // ===============================
  // Fahrkosten Mockup (In-Memory)
  // ===============================

  const fahrkostenState = {
    rows: [],
    filters: { monat: "", art: "", storno: "" }
  };

  // Anpassbar (später aus "Parameter"):
  const PREIS_TICKET = {
    Monatskarte: { "1": 49.00, "2": 69.00, "3": 89.00 },
    Wochenkarte: { "1": 19.00, "2": 29.00, "3": 39.00 }
  };
  const DEFAULT_KM_PAUSCHALE = 0.40; // 40 Cent Default (Parameter)

  const euro = (n) => (Number(n || 0)).toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
  const fmtDate = (iso) => {
    if (!iso) return "";
    const [y,m,d] = iso.split("-");
    return `${d}.${m}.${y}`;
  };
  const fmtMonth = (ym) => {
    if (!ym) return "";
    const [y,m] = ym.split("-");
    return `${m}.${y}`;
  };

  const el = (id) => document.getElementById(id);

  function initTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));
  }

  function openModal(id) {
    bootstrap.Modal.getOrCreateInstance(el(id)).show();
  }
  function closeModal(id) {
    const m = bootstrap.Modal.getInstance(el(id));
    if (m) m.hide();
  }

  function getFormData() {
    return {
      id: el("fahrkostenId").value,
      FahrtkostenBetrifftMonat: el("FahrtkostenBetrifftMonat").value,
      FahrtkostenAusstellungsdatum: el("FahrtkostenAusstellungsdatum").value,
      FahrtkostenArt: el("FahrtkostenArt").value,
      FahrtkostenPreisstufe: el("FahrtkostenPreisstufe").value,
      FahrtkostenBetrag: Number(el("FahrtkostenBetrag").value),
      FahrtkostenKartenanzahl: Number(el("FahrtkostenKartenanzahl").value || 0),
      FahrtkostenStorno: el("FahrtkostenStorno").value,
      // Zeitraum 2 Felder
      FahrtkostenZeitraumVon: el("FahrtkostenZeitraumVon").value,
      FahrtkostenZeitraumBis: el("FahrtkostenZeitraumBis").value,
      // PKW Zusatz
      FahrtkostenWegpunktA: el("FahrtkostenWegpunktA").value.trim(),
      FahrtkostenWegpunktB: el("FahrtkostenWegpunktB").value.trim(),
      FahrtkostenEFKM: Number(el("FahrtkostenEFKM").value || 0),
      FahrtkostenAnzahlPKWTage: Number(el("FahrtkostenAnzahlPKWTage").value || 0),
      FahrtkostenKmPauschale: Number(el("FahrtkostenKmPauschale").value || DEFAULT_KM_PAUSCHALE),
      formularOption: "beleg"
    };
  }

  function setModalMode(mode, row) {
    const title = el("fahrkostenModalLabel");
    const btnDelete = el("btnFahrkostenDelete");

    if (mode === "edit") {
      title.textContent = "Fahrtkosten – Bearbeiten";
      btnDelete.style.display = "inline-block";
      btnDelete.dataset.id = row.id;
    } else {
      title.textContent = "Fahrtkosten – Neuer Eintrag";
      btnDelete.style.display = "none";
      btnDelete.dataset.id = "";
    }
  }

  function resetForm() {
    el("fahrkostenId").value = "";
    el("fahrkostenForm").reset();

    el("FahrtkostenKartenanzahl").value = 1;
    el("FahrtkostenStorno").value = "Nein";
    el("FahrtkostenKmPauschale").value = DEFAULT_KM_PAUSCHALE.toFixed(2);

    setModalMode("create", {});
    toggleArtFields();
    recalcAutoAmount();
  }

  function toggleArtFields() {
    const art = el("FahrtkostenArt").value;

    const showPreisstufe = (art === "Monatskarte" || art === "Wochenkarte");
    el("wrapPreisstufe").style.display = showPreisstufe ? "block" : "none";

    el("wrapPKW").style.display = (art === "PKW") ? "block" : "none";
    el("wrapKartenanzahl").style.display = (art === "PKW") ? "none" : "block";
  }

  function recalcAutoAmount() {
    const art = el("FahrtkostenArt").value;

    // Monatskarte/Wochenkarte + Preisstufe -> Betrag setzen
    if (art === "Monatskarte" || art === "Wochenkarte") {
      const ps = el("FahrtkostenPreisstufe").value;
      const price = PREIS_TICKET?.[art]?.[ps];
      if (ps && price != null) {
        el("FahrtkostenBetrag").value = Number(price).toFixed(2);
      }
    }

    // PKW -> Betrag = KM * Tage * kmPauschale
    if (art === "PKW") {
      const km = Number(el("FahrtkostenEFKM").value || 0);
      const tage = Number(el("FahrtkostenAnzahlPKWTage").value || 0);
      const satz = Number(el("FahrtkostenKmPauschale").value || DEFAULT_KM_PAUSCHALE);
      const betrag = km * tage * satz;
      el("FahrtkostenBetrag").value = (betrag || 0).toFixed(2);
    }
  }

  function applyFilters(rows) {
    const { monat, art, storno } = fahrkostenState.filters;
    return rows.filter(r => {
      if (monat && r.FahrtkostenBetrifftMonat !== monat) return false;
      if (art && r.FahrtkostenArt !== art) return false;
      if (storno && r.FahrtkostenStorno !== storno) return false;
      return true;
    });
  }

  function updateFilterSummary() {
    const m = el("fahrkostenFilterMonat").value;
    const a = el("fahrkostenFilterArt").value;
    const s = el("fahrkostenFilterStorno").value;

    const parts = [];
    if (m) parts.push(`Monat: ${fmtMonth(m)}`);
    if (a) parts.push(`Art: ${a}`);
    if (s) parts.push(`Storno: ${s}`);
    el("fahrkostenFilterSummary").textContent = parts.length ? `(${parts.join(" • ")})` : "(keine Filter aktiv)";
  }

  function computeSummary(rowsFiltered) {
    const totalAll = fahrkostenState.rows.length;
    const stornoCount = fahrkostenState.rows.filter(r => r.FahrtkostenStorno === "Ja").length;

    const sumAktiv = rowsFiltered
      .filter(r => r.FahrtkostenStorno !== "Ja")
      .reduce((acc, r) => acc + Number(r.FahrtkostenBetrag || 0), 0);

    const monthLabel = fahrkostenState.filters.monat ? fmtMonth(fahrkostenState.filters.monat) : "Alle";

    el("fahrkostenSumAktiv").textContent = euro(sumAktiv);
    el("fahrkostenSumHint").textContent = fahrkostenState.filters.monat ? `Filter: ${monthLabel}` : "ohne Filter (alle Monate)";

    el("fahrkostenCount").textContent = totalAll;
    el("fahrkostenCountHint").textContent = `sichtbar: ${rowsFiltered.length}`;

    el("fahrkostenCountStorno").textContent = stornoCount;
    el("fahrkostenStornoHint").textContent = "storniert zählt nicht zur Summe";

    el("fahrkostenActiveMonth").textContent = monthLabel;
    el("fahrkostenLiveInfo").textContent = `${rowsFiltered.length} sichtbare Einträge • Summe aktiv: ${euro(sumAktiv)}`;
  }

  function formatZeitraum(von, bis) {
    const a = von ? fmtDate(von) : "—";
    const b = bis ? fmtDate(bis) : "—";
    return `${a} – ${b}`;
  }

  function detailsText(r) {
    if (r.FahrtkostenArt === "PKW") {
      const a = r.FahrtkostenWegpunktA ? `A: ${r.FahrtkostenWegpunktA}` : "A: —";
      const b = r.FahrtkostenWegpunktB ? `B: ${r.FahrtkostenWegpunktB}` : "B: —";
      return `${r.FahrtkostenEFKM || 0} km • ${r.FahrtkostenAnzahlPKWTage || 0} Tage • ${a} • ${b}`;
    }
    const ps = (r.FahrtkostenPreisstufe) ? `PS ${r.FahrtkostenPreisstufe}` : "";
    const kz = (r.FahrtkostenKartenanzahl != null) ? `${r.FahrtkostenKartenanzahl}×` : "";
    return `${kz} ${ps}`.trim() || "—";
  }

  function renderTable() {
    const tbody = el("fahrkostenTableBody");
    tbody.innerHTML = "";

    const filtered = applyFilters(fahrkostenState.rows);

    filtered.sort((a,b) => {
      const am = (a.FahrtkostenBetrifftMonat || "");
      const bm = (b.FahrtkostenBetrifftMonat || "");
      if (am !== bm) return bm.localeCompare(am);
      return (b.FahrtkostenAusstellungsdatum || "").localeCompare(a.FahrtkostenAusstellungsdatum || "");
    });

    if (filtered.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="text-muted small py-4 text-center">
            Keine Einträge. Lege oben einen neuen Fahrtkosteneintrag an.
          </td>
        </tr>
      `;
      computeSummary(filtered);
      return;
    }

    for (const r of filtered) {
      const stornoBadge = (r.FahrtkostenStorno === "Ja")
        ? `<span class="badge bg-danger-subtle text-danger-emphasis">Ja</span>`
        : `<span class="badge bg-success-subtle text-success-emphasis">Nein</span>`;

      const rowHtml = `
        <tr>
          <td>${fmtMonth(r.FahrtkostenBetrifftMonat)}</td>
          <td>${fmtDate(r.FahrtkostenAusstellungsdatum)}</td>
          <td>${formatZeitraum(r.FahrtkostenZeitraumVon, r.FahrtkostenZeitraumBis)}</td>
          <td>${r.FahrtkostenArt}</td>
          <td>${stornoBadge}</td>
          <td class="small text-muted">${detailsText(r)}</td>
          <td class="text-end fw-semibold">${euro(r.FahrtkostenBetrag)}</td>
          <td class="text-end">
            <div class="d-inline-flex align-items-center gap-1">
              <button class="btn btn-outline-secondary btn-sm"
                      type="button"
                      data-action="form"
                      data-id="${r.id}">
                <i class="bi bi-filetype-pdf"></i>
              </button>

              <!-- Edit + Delete nebeneinander -->
              <button class="btn btn-outline-secondary btn-sm" type="button" data-action="edit" data-id="${r.id}">
                <i class="bi bi-pencil"></i>
              </button>

              <button class="btn btn-outline-danger btn-sm" type="button" data-action="delete" data-id="${r.id}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", rowHtml);
    }

    computeSummary(filtered);
  }

  function upsertRow(data) {
    // Pflichtfelder
    if (!data.FahrtkostenBetrifftMonat || !data.FahrtkostenAusstellungsdatum || !data.FahrtkostenArt ||
        !data.FahrtkostenZeitraumVon || !data.FahrtkostenZeitraumBis) {
      alert("Bitte alle Pflichtfelder ausfüllen.");
      return false;
    }

    // Art-spezifisch
    if (data.FahrtkostenArt === "PKW") {
      const satz = Number(data.FahrtkostenKmPauschale || DEFAULT_KM_PAUSCHALE);
      data.FahrtkostenKmPauschale = satz;
      data.FahrtkostenBetrag = (data.FahrtkostenEFKM || 0) * (data.FahrtkostenAnzahlPKWTage || 0) * satz;
    }

    if (data.FahrtkostenArt === "Monatskarte" || data.FahrtkostenArt === "Wochenkarte") {
      if (!data.FahrtkostenPreisstufe) {
        alert("Bitte eine Preisstufe wählen.");
        return false;
      }
      const p = PREIS_TICKET?.[data.FahrtkostenArt]?.[data.FahrtkostenPreisstufe];
      if (p != null) data.FahrtkostenBetrag = p;
    }

    // Create/Update
    if (!data.id) {
      data.id = "fk-" + Date.now();
      fahrkostenState.rows.unshift(data);
    } else {
      const idx = fahrkostenState.rows.findIndex(r => r.id === data.id);
      if (idx >= 0) fahrkostenState.rows[idx] = { ...fahrkostenState.rows[idx], ...data };
    }

    return true;
  }

  function loadIntoForm(row) {
    el("fahrkostenId").value = row.id;

    el("FahrtkostenBetrifftMonat").value = row.FahrtkostenBetrifftMonat || "";
    el("FahrtkostenAusstellungsdatum").value = row.FahrtkostenAusstellungsdatum || "";
    el("FahrtkostenArt").value = row.FahrtkostenArt || "";
    el("FahrtkostenPreisstufe").value = row.FahrtkostenPreisstufe || "";
    el("FahrtkostenBetrag").value = (Number(row.FahrtkostenBetrag || 0)).toFixed(2);
    el("FahrtkostenKartenanzahl").value = row.FahrtkostenKartenanzahl ?? 1;
    el("FahrtkostenStorno").value = row.FahrtkostenStorno || "Nein";

    el("FahrtkostenZeitraumVon").value = row.FahrtkostenZeitraumVon || "";
    el("FahrtkostenZeitraumBis").value = row.FahrtkostenZeitraumBis || "";

    el("FahrtkostenWegpunktA").value = row.FahrtkostenWegpunktA || "";
    el("FahrtkostenWegpunktB").value = row.FahrtkostenWegpunktB || "";
    el("FahrtkostenEFKM").value = row.FahrtkostenEFKM ?? "";
    el("FahrtkostenAnzahlPKWTage").value = row.FahrtkostenAnzahlPKWTage ?? "";
    el("FahrtkostenKmPauschale").value = (Number(row.FahrtkostenKmPauschale ?? DEFAULT_KM_PAUSCHALE)).toFixed(2);

    toggleArtFields();
    recalcAutoAmount();
    setModalMode("edit", row);
  }

  function handleTableClick(e) {
    const a = e.target.closest("[data-action]");
    if (!a) return;

    e.preventDefault();
    const action = a.getAttribute("data-action");
    const id = a.getAttribute("data-id");
    const row = fahrkostenState.rows.find(r => r.id === id);
    if (!row) return;

    if (action === "edit") {
      loadIntoForm(row);
      openModal("fahrkostenModal");
    }

    if (action === "delete") {
      if (!confirm("Eintrag wirklich löschen?")) return;
      fahrkostenState.rows = fahrkostenState.rows.filter(r => r.id !== id);
      renderTable();
    }

    if (action === "form") {
      el("fahrkostenFormularRowId").value = id;
      // Default Auswahl synchronisieren
      el("fahrkostenFormularTyp").value = "beleg";
      openModal("fahrkostenFormularModal");
    }
  }

  function bindFahrkosten() {
    // Tooltips aktivieren (nach DOM ready)
    initTooltips();

    // Link Mock (später echte URL)
    el("linkFalkMock").addEventListener("click", (e) => {
      e.preventDefault();
      alert("Link (Mock): Hier später Falk Routenplaner öffnen.");
    });

    // Neuer Eintrag
    el("btnFahrkostenNew").addEventListener("click", () => {
      resetForm();
      setModalMode("create", {});
    });

    // Modal open -> toggle + recalc
    el("fahrkostenModal").addEventListener("show.bs.modal", () => {
      if (!el("fahrkostenId").value) setModalMode("create", {});
      toggleArtFields();
      recalcAutoAmount();
    });

    // Form submit
    el("fahrkostenForm").addEventListener("submit", (ev) => {
      ev.preventDefault();
      toggleArtFields();
      recalcAutoAmount();

      const data = getFormData();
      const ok = upsertRow(data);
      if (!ok) return;

      renderTable();
      closeModal("fahrkostenModal");
      resetForm();
    });

    // Delete in modal
    el("btnFahrkostenDelete").addEventListener("click", () => {
      const id = el("btnFahrkostenDelete").dataset.id;
      if (!id) return;
      if (!confirm("Eintrag wirklich löschen?")) return;

      fahrkostenState.rows = fahrkostenState.rows.filter(r => r.id !== id);
      renderTable();
      closeModal("fahrkostenModal");
      resetForm();
    });

    // Auto / Toggle
    el("FahrtkostenArt").addEventListener("change", () => {
      toggleArtFields();
      recalcAutoAmount();
    });
    el("FahrtkostenPreisstufe").addEventListener("change", () => recalcAutoAmount());

    // PKW re-calc
    ["FahrtkostenEFKM","FahrtkostenAnzahlPKWTage","FahrtkostenKmPauschale"].forEach(id => {
      el(id).addEventListener("input", () => recalcAutoAmount());
    });

    // Filter inputs
    function applyFilterFromInputs() {
      fahrkostenState.filters.monat = el("fahrkostenFilterMonat").value || "";
      fahrkostenState.filters.art = el("fahrkostenFilterArt").value || "";
      fahrkostenState.filters.storno = el("fahrkostenFilterStorno").value || "";
      updateFilterSummary();
      renderTable();
    }
    el("fahrkostenFilterMonat").addEventListener("change", applyFilterFromInputs);
    el("fahrkostenFilterArt").addEventListener("change", applyFilterFromInputs);
    el("fahrkostenFilterStorno").addEventListener("change", applyFilterFromInputs);

    el("btnFahrkostenResetFilter").addEventListener("click", () => {
      fahrkostenState.filters = { monat: "", art: "", storno: "" };
      el("fahrkostenFilterMonat").value = "";
      el("fahrkostenFilterArt").value = "";
      el("fahrkostenFilterStorno").value = "";
      updateFilterSummary();
      renderTable();
    });

    // Table actions
    el("fahrkostenTableBody").addEventListener("click", handleTableClick);

    // Formular-Popup submit (Mock)
    el("fahrkostenFormularForm").addEventListener("submit", (ev) => {
      ev.preventDefault();
      const rowId = el("fahrkostenFormularRowId").value;
      const typ = el("fahrkostenFormularTyp").value;
      const beleg = el("chkBeleg").checked;
      const empfang = el("chkEmpfang").checked;

      alert(`PDF (Mock) für Eintrag ${rowId}\nTyp: ${typ}\nCheckboxen: Beleg=${beleg}, Empfang=${empfang}`);
      closeModal("fahrkostenFormularModal");
    });

    // Export placeholder
    el("btnFahrkostenExport").addEventListener("click", () => {
      alert("Export (Mock): Hier später CSV/PDF Export implementieren.");
    });

    // Initial
    updateFilterSummary();
    resetForm();
    renderTable();
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (document.getElementById("dokFahrkosten")) bindFahrkosten();
  });
</script>


</body>
</html>
